<!DOCTYPE html>
<html lang="zh"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>3. 查询处理 – PG技术内幕</title>
  <meta name="description" content="查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL官方文档所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。
本章包括下列三个部分：
第一部分：3.1节
这一节会简单介绍PostgreSQL中查询处理的流程。" /><link rel="canonical" href="http://localhost:1313/ch3/" itemprop="url" />

<meta property="og:title" content="3. 查询处理" />
<meta property="og:description" content="查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL官方文档所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。
本章包括下列三个部分：


第一部分：3.1节
这一节会简单介绍PostgreSQL中查询处理的流程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/ch3/" /><meta property="article:section" content="" />



  <meta itemprop="name" content="3. 查询处理">
  <meta itemprop="description" content="查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL官方文档所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。
本章包括下列三个部分：
第一部分：3.1节
这一节会简单介绍PostgreSQL中查询处理的流程。">
  <meta itemprop="wordCount" content="34171">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="3. 查询处理">
  <meta name="twitter:description" content="查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL官方文档所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。
本章包括下列三个部分：
第一部分：3.1节
这一节会简单介绍PostgreSQL中查询处理的流程。">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-mr-2 hx-block dark:hx-hidden" src="/images/logo.svg" alt="PG技术内幕" height="20" width="20" />
        <img class="hx-mr-2 hx-hidden dark:hx-block" src="/images/logo-dark.svg" alt="PG技术内幕" height="20" width="20" />
        <span class="hx-mr-2 hx-font-extrabold hx-inline hx-select-none" title="PG技术内幕">PG技术内幕</span>
    </a><a
            title="Documentation"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Documentation</span>
          </a><a
            title="Versions"
            href=""
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Versions</span>
          </a><a
            title="Blog"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Blog</span>
          </a><a
            title="About"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">About</span>
          </a><a
            title="Showcase"
            href="/showcase"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Showcase</span>
          </a><div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/imfing/hextra" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex max-w-full'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-sticky">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch3/"
    
  >3. 查询处理
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#31-%e6%a6%82%e8%a7%88"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.1 概览</a>
            </li>
          <li>
              <a
                href="#32-%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e4%bb%a3%e4%bb%b7%e4%bc%b0%e8%ae%a1"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.2 单表查询的代价估计</a>
            </li>
          <li>
              <a
                href="#33-%e5%88%9b%e5%bb%ba%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e8%ae%a1%e5%88%92%e6%a0%91"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.3 创建单表查询的计划树</a>
            </li>
          <li>
              <a
                href="#34-%e6%89%a7%e8%a1%8c%e5%99%a8%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.4 执行器如何工作</a>
            </li>
          <li>
              <a
                href="#35-%e8%bf%9e%e6%8e%a5"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.5 连接</a>
            </li>
          <li>
              <a
                href="#36-%e5%88%9b%e5%bb%ba%e5%a4%9a%e8%a1%a8%e6%9f%a5%e8%af%a2%e8%ae%a1%e5%88%92%e6%a0%91"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >3.6 创建多表查询计划树</a>
            </li>
          <li>
              <a
                href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >参考文献</a>
            </li>
          </ul>
  </li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch5/"
    
  >5. 并发控制
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch9/"
    
  >9. 预写式日志
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
    </ul>

    <ul class="hx-flex hx-flex-col hx-gap-1 max-md:hx-hidden">
        
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch3/"
    
  >3. 查询处理
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch5/"
    
  >5. 并发控制
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch9/"
    
  >9. 预写式日志
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
        
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
      </ul>
    </div>
  
  
    <div class="  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#31-%e6%a6%82%e8%a7%88">3.1 概览
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#311-%e8%a7%a3%e6%9e%90%e5%99%a8parser">3.1.1 解析器（Parser）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#312-%e5%88%86%e6%9e%90%e5%99%a8analyzer">3.1.2 分析器（Analyzer）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#313-%e9%87%8d%e5%86%99%e5%99%a8rewriter">3.1.3 重写器（Rewriter）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%a7%86%e5%9b%be">视图
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#314-%e8%ae%a1%e5%88%92%e5%99%a8%e4%b8%8e%e6%89%a7%e8%a1%8c%e5%99%a8">3.1.4 计划器与执行器
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pg_hint_plan">pg_hint_plan
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#32-%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e4%bb%a3%e4%bb%b7%e4%bc%b0%e8%ae%a1">3.2 单表查询的代价估计
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#321-%e9%a1%ba%e5%ba%8f%e6%89%ab%e6%8f%8f">3.2.1 顺序扫描
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#322-%e7%b4%a2%e5%bc%95%e6%89%ab%e6%8f%8f">3.2.2 索引扫描
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3221-%e5%90%af%e5%8a%a8%e4%bb%a3%e4%bb%b7">3.2.2.1 启动代价
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3222-%e8%bf%90%e8%a1%8c%e4%bb%a3%e4%bb%b7">3.2.2.2 运行代价
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%80%89%e6%8b%a9%e7%8e%87selectivity">选择率（Selectivity）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%b4%a2%e5%bc%95%e7%9b%b8%e5%85%b3%e6%80%a7index-correlation">索引相关性（index correlation）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3223-%e6%95%b4%e4%bd%93%e4%bb%a3%e4%bb%b7">3.2.2.3 整体代价
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#seq_page_cost%e5%92%8crandom_page_cost">seq_page_cost和random_page_cost
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#323-%e6%8e%92%e5%ba%8f">3.2.3 排序
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#33-%e5%88%9b%e5%bb%ba%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e8%ae%a1%e5%88%92%e6%a0%91">3.3 创建单表查询的计划树
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#331-%e9%a2%84%e5%a4%84%e7%90%86">3.3.1 预处理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#332-%e6%89%be%e5%87%ba%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84">3.3.2 找出代价最小的访问路径
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3321-%e4%be%8b1">3.3.2.1 例1
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3322-%e4%be%8b2">3.3.2.2 例2
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#333-%e5%88%9b%e5%bb%ba%e8%ae%a1%e5%88%92%e6%a0%91">3.3.3 创建计划树
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3331-%e4%be%8b1">3.3.3.1 例1
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3332-%e4%be%8b2">3.3.3.2 例2
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#34-%e6%89%a7%e8%a1%8c%e5%99%a8%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c">3.4 执行器如何工作
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%b4%e6%97%b6%e6%96%87%e4%bb%b6">临时文件
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#35-%e8%bf%9e%e6%8e%a5">3.5 连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#351-%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5nested-loop-join">3.5.1 嵌套循环连接（Nested Loop Join）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3511-%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5">3.5.1.1 嵌套循环连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3512-%e7%89%a9%e5%8c%96%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5">3.5.1.2 物化嵌套循环连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%b4%e6%97%b6%e5%85%83%e7%bb%84%e5%ad%98%e5%82%a8">临时元组存储
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3513-%e7%b4%a2%e5%bc%95%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5">3.5.1.3 索引嵌套循环连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3514-%e5%85%b6%e4%bb%96%e5%8f%98%e4%bd%93">3.5.1.4 其他变体
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#352-%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5merge-join">3.5.2 归并连接（Merge Join）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3521-%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5">3.5.2.1 归并连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3522-%e7%89%a9%e5%8c%96%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5">3.5.2.2 物化归并连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3523-%e5%85%b6%e4%bb%96%e5%8f%98%e4%bd%93">3.5.2.3 其他变体
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#353-%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5hash-join">3.5.3 散列连接（Hash Join）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3531-%e5%86%85%e5%ad%98%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5">3.5.3.1 内存散列连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3532-%e5%b8%a6%e5%80%be%e6%96%9c%e7%9a%84%e6%b7%b7%e5%90%88%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5">3.5.3.2 带倾斜的混合散列连接
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#354-%e8%bf%9e%e6%8e%a5%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84%e4%b8%8e%e8%bf%9e%e6%8e%a5%e8%8a%82%e7%82%b9">3.5.4 连接访问路径与连接节点
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3541-%e8%bf%9e%e6%8e%a5%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84">3.5.4.1 连接访问路径
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3542-%e8%bf%9e%e6%8e%a5%e8%8a%82%e7%82%b9">3.5.4.2 连接节点
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#36-%e5%88%9b%e5%bb%ba%e5%a4%9a%e8%a1%a8%e6%9f%a5%e8%af%a2%e8%ae%a1%e5%88%92%e6%a0%91">3.6 创建多表查询计划树
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#361-%e9%a2%84%e5%a4%84%e7%90%86">3.6.1 预处理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#362-%e8%8e%b7%e5%8f%96%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%b7%af%e5%be%84">3.6.2 获取代价最小的路径
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%9f%ba%e5%9b%a0%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96%e5%99%a8">基因查询优化器
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3621-%e7%ac%ac%e4%b8%80%e5%b1%82%e7%9a%84%e5%a4%84%e7%90%86">3.6.2.1 第一层的处理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#3622-%e7%ac%ac%e4%ba%8c%e5%b1%82%e7%9a%84%e5%a4%84%e7%90%86">3.6.2.2 第二层的处理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#363-%e8%8e%b7%e5%8f%96%e4%b8%89%e8%a1%a8%e6%9f%a5%e8%af%a2%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%b7%af%e5%be%84">3.6.3 获取三表查询代价最小的路径
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae">参考文献
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400"><a class="hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50" href="https://github.com/Vonng/pg-internal/edit/main/content/ch3.md" target="_blank" rel="noreferrer">Edit this page</a>
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
        <div class="content">
          <h1>3. 查询处理</h1>
          <p>查询处理是PostgreSQL中最为复杂的子系统。如PostgreSQL<a href="https://www.postgresql.org/docs/current/static/features.html" target="_blank" rel="noopener">官方文档</a>所述，PostgreSQL支持SQL2011标准中的大多数特性，查询处理子系统能够高效地处理这些SQL。本章概述了查询处理的流程，特别关注了查询优化的部分。</p>
<p>本章包括下列三个部分：</p>
<ul>
<li>
<p>第一部分：3.1节</p>
<p>这一节会简单介绍PostgreSQL中查询处理的流程。</p>
</li>
<li>
<p>第二部分：3.2~3.4节</p>
<p>这一部分会描述获取单表查询上最优执行计划的步骤。3.2节讨论代价估计的过程，3.3节描述创建计划树的过程，3.4节将简要介绍执行器的工作过程。</p>
</li>
<li>
<p>第三部分：3.5~3.6节</p>
<p>这一部分会描述获取多表查询上最优执行计划的步骤。3.5节介绍了三种连接算法：<strong>嵌套循环连接（Nested Loop Join）</strong>，<strong>归并连接（Merge Join）</strong> ，<strong>散列连接（Hash Join）</strong>。3.6节将介绍为多表查询创建计划树的过程。</p>
</li>
</ul>
<p>PostgreSQL支持三种技术上很有趣，而且也很实用的功能：<a href="https://www.postgresql.org/docs/current/static/fdwhandler.html" target="_blank" rel="noopener"><strong>外部数据包装（Foreign Data Wrapper, FDW）</strong></a>，<a href="https://www.postgresql.org/docs/current/static/parallel-query.html" target="_blank" rel="noopener"><strong>并行查询</strong></a>，以及版本11即将支持的<a href="https://www.postgresql.org/docs/11/static/jit-reason.html" target="_blank" rel="noopener">JIT编译</a>。前两者将在<a href="/ch4" >第4章</a>中描述，JIT编译超出范围本书的范围，详见<a href="https://www.postgresql.org/docs/11/static/jit-reason.html" target="_blank" rel="noopener">官方文档</a>。</p>
<h2>3.1 概览<span class="hx-absolute -hx-mt-20" id="31-概览"></span>
    <a href="#31-%e6%a6%82%e8%a7%88" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>尽管PostgreSQL在9.6版本后有了基于多个后台工作进程的并行查询，但大体上来讲，还是每个连接对应一个后端进程。后端进程由五个子系统组成，如下所示：</p>
<ol>
<li>
<p><strong>解析器（Parser）</strong></p>
<p>解析器根据SQL语句生成一颗<strong>语法解析树（parse tree）</strong> 。</p>
</li>
<li>
<p><strong>分析器（Analyzer）</strong></p>
<p>分析器对语法解析树进行语义分析，生成一颗<strong>查询树（query tree）</strong>。</p>
</li>
<li>
<p><strong>重写器（Rewriter）</strong></p>
<p>重写器按照<a href="https://www.postgresql.org/docs/current/static/rules.html" target="_blank" rel="noopener">规则系统</a>中存在的规则，对查询树进行改写。</p>
</li>
<li>
<p><strong>计划器（Planner）</strong></p>
<p>计划器基于查询树，生成一颗执行效率最高的<strong>计划树（plan tree）</strong>。</p>
</li>
<li>
<p><strong>执行器（Executor）</strong></p>
<p>执行器按照计划树中的顺序访问表和索引，执行相应查询。</p>
</li>
</ol>
<p><strong>图3.1 查询处理</strong></p>
<p><img src="/img/fig-3-01.png" alt="QueryProcessing" loading="lazy" /></p>
<p>本节将概述这些子系统。计划器和执行器很复杂，后面的章节会对这些函数的细节进行描述。</p>
<blockquote>
  <p>PostgreSQL的查询处理在<a href="http://www.postgresql.org/docs/current/static/overview.html" target="_blank" rel="noopener">官方文档</a>中有详细的描述</p>
</blockquote>
<h3>3.1.1 解析器（Parser）<span class="hx-absolute -hx-mt-20" id="311-解析器parser"></span>
    <a href="#311-%e8%a7%a3%e6%9e%90%e5%99%a8parser" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>解析器基于SQL语句的文本，生成一颗后续子系统可以理解的语法解析树。下面是一个具体的例子。</p>
<p>考虑以下查询：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>语法解析树的根节点是一个定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h" target="_blank" rel="noopener"><code>parsenodes.h</code></a>中的<code>SelectStmt</code>数据结构。图3.2(a)展示了一个查询，而图3.2(b)则是该查询对应的语法解析树。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">SelectStmt</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">NodeTag</span>         <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 这些字段只会在SelectStmts“叶节点”中使用 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">distinctClause</span><span class="p">;</span>     <span class="cm">/* NULL, DISTINCT ON表达式列表, 或
</span></span></span><span class="line"><span class="cl"><span class="cm">                                       对所有的(SELECT DISTINCT)为lcons(NIL,NIL) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">IntoClause</span> <span class="o">*</span><span class="n">intoClause</span><span class="p">;</span>         <span class="cm">/* SELECT INTO 的目标 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">targetList</span><span class="p">;</span>         <span class="cm">/* 结果目标列表 (ResTarget) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">fromClause</span><span class="p">;</span>         <span class="cm">/* FROM 子句 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span>       <span class="o">*</span><span class="n">whereClause</span><span class="p">;</span>        <span class="cm">/* WHERE 限定条件 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">groupClause</span><span class="p">;</span>        <span class="cm">/* GROUP BY 子句 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span>       <span class="o">*</span><span class="n">havingClause</span><span class="p">;</span>       <span class="cm">/* HAVING 条件表达式 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">windowClause</span><span class="p">;</span>       <span class="cm">/* WINDOW window_name AS (...), ... */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*  在一个表示值列表的叶节点中，上面的字段全都为空，而这个字段会被设置。
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 注意这个子列表中的元素仅仅是表达式，没有ResTarget的修饰，还需要注意列表元素可能为
</span></span></span><span class="line"><span class="cl"><span class="cm">         * DEFAULT (表示一个 SetToDefault 节点)，而无论值列表的上下文。 
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 由分析阶段决定否合法并拒绝。      */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">valuesLists</span><span class="p">;</span>        <span class="cm">/* 未转换的表达式列表 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 这些字段会同时在SelectStmts叶节点与SelectStmts上层节点中使用 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">sortClause</span><span class="p">;</span>         <span class="cm">/* 排序子句 (排序依据的列表) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span>       <span class="o">*</span><span class="n">limitOffset</span><span class="p">;</span>        <span class="cm">/* 需要跳过的元组数目 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span>       <span class="o">*</span><span class="n">limitCount</span><span class="p">;</span>         <span class="cm">/* 需要返回的元组数目 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span>       <span class="o">*</span><span class="n">lockingClause</span><span class="p">;</span>      <span class="cm">/* FOR UPDATE (锁子句的列表) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">WithClause</span> <span class="o">*</span><span class="n">withClause</span><span class="p">;</span>         <span class="cm">/* WITH 子句 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 这些字段只会在上层的 SelectStmts 中出现 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">SetOperation</span> <span class="n">op</span><span class="p">;</span>                <span class="cm">/* set 操作的类型 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span>            <span class="n">all</span><span class="p">;</span>            <span class="cm">/* 是否指明了 ALL 选项? */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">SelectStmt</span> <span class="o">*</span><span class="n">larg</span><span class="p">;</span>        <span class="cm">/* 左子节点 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">SelectStmt</span> <span class="o">*</span><span class="n">rarg</span><span class="p">;</span>        <span class="cm">/* 右子节点 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SelectStmt</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>图3.2. 语法解析树的例子</strong></p>
<p><img src="/img/fig-3-02.png" alt="ParseTree" loading="lazy" /></p>
<p><code>SELECT</code>查询中的元素和语法解析树中的元素有着对应关系。比如，(1)是目标列表中的一个元素，与目标表的<code>'id'</code>列相对应，(4)是一个<code>WHERE</code>子句，诸如此类。</p>
<p>当解析器生成语法分析树时只会检查语法，只有当查询中出现语法错误时才会返回错误。解析器并不会检查输入查询的语义，举个例子，如果查询中包含一个不存在的表名，解析器并不会报错，语义检查由分析器负责。</p>
<h3>3.1.2 分析器（Analyzer）<span class="hx-absolute -hx-mt-20" id="312-分析器analyzer"></span>
    <a href="#312-%e5%88%86%e6%9e%90%e5%99%a8analyzer" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>分析器对解析器产出的<strong>语法解析树（parse tree）<strong>进行语义分析，并产出一颗</strong>查询树（query tree）</strong>。</p>
<p>查询树的根节点是<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h" target="_blank" rel="noopener"><code>parsenode.h</code></a>中定义的<code>Query</code>数据结构，这个结构包含着对应查询的元数据，比如命令的类型（<code>SELECT/INSERT</code>等），还包括了一些叶子节点，叶子节点由列表或树组成，包含了特定子句相应的数据。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Query -
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	  解析与分析过程会将所有的语句转换为一颗查询树，供重写器与计划器用于进一步的处理。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    功能语句（即不可优化的语句）会设置utilityStmt字段，而Query结构本身基本上是空的。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	  DECLARE CURSOR 是一个特例：它的形式与SELECT类似，但原始的DeclareCursorStmt会
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    被放在 utilityStmt 字段中。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    计划过程会将查询树转换为一颗计划树，计划树的根节点是一个PlannedStmt结构
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    执行器不会用到查询树结构
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Query</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NodeTag</span>		<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CmdType</span>		<span class="n">commandType</span><span class="p">;</span>		<span class="cm">/* select|insert|update|delete|utility */</span>
</span></span><span class="line"><span class="cl">	<span class="n">QuerySource</span> <span class="n">querySource</span><span class="p">;</span>		<span class="cm">/* 我来自哪里? */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint32</span>		<span class="n">queryId</span><span class="p">;</span>		    <span class="cm">/* 查询标识符 (可由插件配置) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">canSetTag</span><span class="p">;</span>		    <span class="cm">/* 我设置了命令结果标签吗? */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">utilityStmt</span><span class="p">;</span>		<span class="cm">/* 如果这是一条DECLARE CURSOR或不可优化的语句 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>		<span class="n">resultRelation</span><span class="p">;</span> 	    <span class="cm">/* 对增删改语句而言是目标关系的索引; SELECT为0 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasAggs</span><span class="p">;</span>		    <span class="cm">/* 是否在目标列表或having表达式中指定了聚合函数 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasWindowFuncs</span><span class="p">;</span> 	<span class="cm">/* tlist是否包含窗口函数 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasSubLinks</span><span class="p">;</span>		<span class="cm">/* 是否包含子查询SubLink */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasDistinctOn</span><span class="p">;</span>		<span class="cm">/* 是否包含来自DISTINCT ON的distinct子句 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasRecursive</span><span class="p">;</span>		<span class="cm">/* 是否制定了WITH RECURSIVE */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasModifyingCTE</span><span class="p">;</span>	<span class="cm">/* 是否在WITH子句中包含了INSERT/UPDATE/DELETE */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasForUpdate</span><span class="p">;</span>		<span class="cm">/* 是否指定了FOR [KEY] UPDATE/SHARE*/</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasRowSecurity</span><span class="p">;</span> 	<span class="cm">/* 是否应用了行安全策略 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">cteList</span><span class="p">;</span>		    <span class="cm">/* CTE列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">rtable</span><span class="p">;</span>		    <span class="cm">/* 范围表项目列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">FromExpr</span>   	<span class="o">*</span><span class="n">jointree</span><span class="p">;</span>		    <span class="cm">/* 表连接树 (FROM 与 WHERE 子句) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">targetList</span><span class="p">;</span>		<span class="cm">/* 目标列表 (TargetEntry的列表) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">withCheckOptions</span><span class="p">;</span>	<span class="cm">/* WithCheckOption的列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">OnConflictExpr</span> 	<span class="o">*</span><span class="n">onConflict</span><span class="p">;</span> 	<span class="cm">/* ON CONFLICT DO [NOTHING | UPDATE] */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">returningList</span><span class="p">;</span>		<span class="cm">/* 返回值列表(TargetEntry的列表) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">groupClause</span><span class="p">;</span>		<span class="cm">/* SortGroupClause的列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">groupingSets</span><span class="p">;</span>		<span class="cm">/* 如果有，GroupingSet的列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">havingQual</span><span class="p">;</span>		<span class="cm">/* 分组的Having条件列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">windowClause</span><span class="p">;</span>		<span class="cm">/* 窗口子句列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">distinctClause</span><span class="p">;</span> 	<span class="cm">/* SortGroupClause列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">sortClause</span><span class="p">;</span>		<span class="cm">/* SortGroupClause列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">limitOffset</span><span class="p">;</span>		<span class="cm">/* Offset跳过元组数目 (int8 表达式) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">limitCount</span><span class="p">;</span>		<span class="cm">/* Limit返回元组数目 (int8 表达式) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">rowMarks</span><span class="p">;</span>          <span class="cm">/* RowMarkClause列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">setOperations</span><span class="p">;</span>		<span class="cm">/* 如果是UNION/INTERSECT/EXCEPT的顶层查询，
</span></span></span><span class="line"><span class="cl"><span class="cm">	                                   则为集合操作列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">constraintDeps</span><span class="p">;</span> 	<span class="cm">/* 确认查询语义是否合法时，所依赖约束对象的OID列表 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Query</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>图3.3 查询树一例</strong></p>
<p><img src="/img/fig-3-03.png" alt="QueyTree" loading="lazy" /></p>
<p>简要介绍一下上图中的查询树：</p>
<ul>
<li><code>targetlist</code> 是查询结果中**列（Column）**的列表。在本例中该列表包含两列：<code>id</code> 和<code>data</code>。如果在输入的查询树中使用了<code>*</code>（星号），那么分析器会将其显式替换为所有具体的列。</li>
<li>范围表<code>rtable</code>是该查询所用到关系的列表。本例中该变量包含了表<code>tbl_a</code>的信息，如该表的表名与<code>oid</code>。</li>
<li>连接树<code>jointree</code>存储着<code>FROM</code>和<code>WHERE</code>子句的相关信息。</li>
<li>排序子句<code>sortClause</code>是<code>SortGroupClause</code>结构体的列表。</li>
</ul>
<p><a href="http://www.postgresql.org/docs/current/static/querytree.html" target="_blank" rel="noopener">官方文档</a>描述了查询树的细节。</p>
<h3>3.1.3 重写器（Rewriter）<span class="hx-absolute -hx-mt-20" id="313-重写器rewriter"></span>
    <a href="#313-%e9%87%8d%e5%86%99%e5%99%a8rewriter" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>PostgreSQL的<a href="https://www.postgresql.org/docs/current/static/rules.html" target="_blank" rel="noopener">规则系统</a>正是基于重写器实现的；当需要时，重写器会根据存储在<code>pg_rules</code>中的规则对查询树进行转换。规则系统本身也是一个很有趣的系统，不过本章略去了关于规则系统和重写器的描述，以免内容过于冗长。</p>
<blockquote>
  <h4>视图<span class="hx-absolute -hx-mt-20" id="视图"></span>
    <a href="#%e8%a7%86%e5%9b%be" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>在PostgreSQL中，<a href="https://www.postgresql.org/docs/current/static/rules-views.html" target="_blank" rel="noopener">视图</a>是基于规则系统实现的。当使用<a href="https://www.postgresql.org/docs/current/static/sql-createview.html" target="_blank" rel="noopener"><code>CREATE VIEW</code></a>命令定义一个视图时，PostgreSQL就会创建相应的规则，并存储到系统目录中。</p>
<p>假设下面的视图已经被定义，而<code>pg_rule</code>中也存储了相应的规则。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">sampledb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">employees_list</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sampledb</span><span class="o">-#</span><span class="w">   </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">department</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">sampledb</span><span class="o">-#</span><span class="w">      </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>当执行一个包含该视图的查询，解析器会创建一颗如图3.4(a)所示的语法解析树。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">sampledb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees_list</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在该阶段，重写器会基于<code>pg_rules</code>中存储的视图规则将<code>rangetable</code>节点重写为一颗查询子树，与子查询相对应。</p>
<p><strong>图3.4 重写阶段一例</strong></p>
<p><img src="/img/fig-3-04.png" alt="rewriter" loading="lazy" /></p>
<p>因为PostgreSQL使用这种机制实现视图，直到9.2版本，视图都是不能更新的。虽然9.3版本后可以对视图进行更新，但对视图的更新仍然存在很多限制，具体细节请参考<a href="https://www.postgresql.org/docs/current/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS" target="_blank" rel="noopener">官方文档</a>。</p>
</blockquote>
<h3>3.1.4 计划器与执行器<span class="hx-absolute -hx-mt-20" id="314-计划器与执行器"></span>
    <a href="#314-%e8%ae%a1%e5%88%92%e5%99%a8%e4%b8%8e%e6%89%a7%e8%a1%8c%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>计划器从重写器获取一颗<strong>查询树（query tree）</strong>，基于查询树生成一颗能被执行器高效执行的（查询）<strong>计划树（plan tree）</strong>。</p>
<p>在PostgreSQL中，计划器是完全<strong>基于代价估计（cost-based）<strong>的；它不支持基于规则的优化与</strong>提示（hint）</strong>。计划器是RDBMS中最为复杂的部分，因此本章的后续内容会对计划器做一个概述。</p>
<blockquote>
  <h4><code>pg_hint_plan</code><span class="hx-absolute -hx-mt-20" id="pg_hint_plan"></span>
    <a href="#pg_hint_plan" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>PostgreSQL不支持SQL中的<strong>提示（hint）</strong>，并且永远也不会去支持。如果你想在查询中使用提示，可以考虑使用<code>pg_hint_plan</code>扩展，细节请参考<a href="http://pghintplan.osdn.jp/pg_hint_plan.html" target="_blank" rel="noopener">官方站点</a>。</p>
</blockquote>
<p>与其他RDBMS类似，PostgreSQL中的<a href="https://www.postgresql.org/docs/current/static/sql-explain.html" target="_blank" rel="noopener"><code>EXPLAIN</code></a>命令会显示命令的计划树。下面给出了一个具体的例子。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                           
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">182</span><span class="p">.</span><span class="mi">34</span><span class="p">..</span><span class="mi">183</span><span class="p">.</span><span class="mi">09</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">300</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="k">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_a</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">170</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">300</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>图3.5展示了结果相应的计划树。</p>
<p><strong>图3.5 一个简单的计划树以及其与EXPLAIN命令的关系</strong></p>
<p><img src="/img/fig-3-05.png" alt="planTree" loading="lazy" /></p>
<p>计划树由许多称为**计划节点（plan node）**的元素组成，这些节点挂在<code>PlannedStmt</code>结构对应的计划树上。这些元素的定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h%e4%b8%ad" target="_blank" rel="noopener"><code>plannodes.h</code></a>中，第3.3.3节与第3.5.4.2会解释相关细节。</p>
<p>每个计划节点都包含着执行器进行处理所必需的信息，在单表查询的场景中，执行器会按照从终端节点往根节点的顺序依次处理这些节点。</p>
<p>比如图3.5中的计划树就是一个列表，包含一个排序节点和一个顺序扫描节点；因而执行器会首先对表<code>tbl_a</code>执行顺序扫描，并对获取的结果进行排序。</p>
<p>执行器会通过<a href="/ch8" >第8章</a>将介绍的缓冲区管理器来访问数据库集簇的表和索引。当处理一个查询时，执行器会使用预先分配的内存空间，比如<code>temp_buffers</code>和<code>work_mem</code>，必要时还会创建临时文件。</p>
<p><strong>图3.6 执行器，缓冲管理器，临时文件之间的关系</strong></p>
<p><img src="/img/fig-3-06.png" alt="dd" loading="lazy" /></p>
<p>除此之外，当访问元组的时候，PostgreSQL还会使用并发控制机制来维护运行中事务的一致性和隔离性。<a href="/ch5" >第五章</a>介绍了并发控制机制。</p>
<h2>3.2 单表查询的代价估计<span class="hx-absolute -hx-mt-20" id="32-单表查询的代价估计"></span>
    <a href="#32-%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e4%bb%a3%e4%bb%b7%e4%bc%b0%e8%ae%a1" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>PostgreSQL的查询优化是基于**代价（Cost）**的。代价是一个无量纲的值，它并不是一种绝对的性能指标，但可以作为比较各种操作代价时的相对性能指标。</p>
<p><a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/path/costsize.c" target="_blank" rel="noopener"><code>costsize.c</code></a>中的函数用于估算各种操作的代价。所有被执行器执行的操作都有着相应的代价函数。例如，函数<code>cost_seqscan()</code> 和 <code>cost_index()</code>分别用于估算顺序扫描和索引扫描的代价。</p>
<p>在PostgreSQL中有三种代价：<strong>启动（start-up）</strong> ， <strong>运行（run）<strong>和</strong>总和（total）</strong>。<strong>总代价</strong>是<strong>启动代价</strong>和<strong>运行代价</strong>的和；因此只有启动代价和运行代价是单独估计的。</p>
<ol>
<li><strong>启动代价（start-up）</strong>：在读取到第一条元组前花费的代价，比如索引扫描节点的<strong>启动代价</strong>就是读取目标表的索引页，取到第一个元组的代价</li>
<li><strong>运行代价（run）</strong>： 获取全部元组的代价</li>
<li><strong>总代价（total）</strong>：前两者之和</li>
</ol>
<p><a href="https://www.postgresql.org/docs/current/static/sql-explain.html" target="_blank" rel="noopener"><code>EXPLAIN</code></a>命令显示了每个操作的启动代价和总代价，下面是一个简单的例子：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">145</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在第4行显示了顺序扫描的相关信息。代价部分包含了两个值：0.00和145.00。在本例中，启动代价和总代价分别为0.00和145.00。</p>
<p>在本节中，我们将详细介绍顺序扫描，索引扫描和排序操作的代价是如何估算的。</p>
<p>在接下来的内容中，我们使用下面这个表及其索引作为例子。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="nb">int</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">tbl_data_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">),</span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">ANALYZE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_pkey&#34;</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_data_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h3>3.2.1 顺序扫描<span class="hx-absolute -hx-mt-20" id="321-顺序扫描"></span>
    <a href="#321-%e9%a1%ba%e5%ba%8f%e6%89%ab%e6%8f%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>顺序扫描的代价是通过函数<code>cost_seqscan()</code>估计的。本节将研究顺序扫描代价是如何估计的，以下面的查询为例：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8000</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在顺序扫描中，启动代价等于0，而运行代价由以下公式定义：
</p>
$$
\begin{align}
  \verb|run_cost| 
  &= \verb|cpu_run_cost| + \verb|disk_run_cost | \\
  &= (\verb|cpu_tuple_cost| + \verb|cpu_operator_cost|) × N_{\verb|tuple|} + \verb|seq_page_cost| × N_{\verb|page|},
\end{align}
$$<p>
其中<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-SEQ-PAGE-COST" target="_blank" rel="noopener"><code>seq_page_cost</code></a>，<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-TUPLE-COST" target="_blank" rel="noopener"><code>cpu_tuple_cost</code></a>和<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-OPERATOR-COST" target="_blank" rel="noopener"><code>cpu_operator_cost</code></a>是在<em>postgresql.conf</em> 中配置的参数，默认值分别为1.0，0.01和0.0025。$N_{\verb|tuple|}$ 和$N_{\verb|page|}$ 分别是表中的元组总数与页面总数，这两个值可以使用以下查询获取。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">relpages</span><span class="p">,</span><span class="w"> </span><span class="n">reltuples</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">relname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tbl&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">relpages</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">reltuples</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="mi">45</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
$$
\begin{equation}\tag{1}
	N_{\verb|tuple|}=10000
\end{equation}
$$$$
\begin{equation}\tag{2}
	N_{\verb|page|}=45
\end{equation}
$$<p>因此：
</p>
$$
\begin{align}
 \verb|run_cost| 
 	    &= (0.01 + 0.0025) × 10000 + 1.0 × 45 = 170.0.
\end{align}
$$<p>最终：
</p>
$$
\verb|total_cost| = 0.0 + 170.0 = 170.0
$$<p>作为验证，下面是该查询的<code>EXPLAIN</code>结果：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                       
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">170</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">8000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在第4行中可以看到，启动代价和总代价分别是0.00和170.0，且预计全表扫描返回行数为8000条（元组）。</p>
<p>在第5行显示了一个顺序扫描的过滤器<code>Filter:(id &lt; 8000)</code>。更精确地说，它是一个<strong>表级过滤谓词（table level filter predicate）</strong>。注意这种类型的过滤器只会在读取所有元组的时候使用，它并不会减少需要扫描的表页面数量。</p>
<blockquote>
  <p>从优化运行代价的角度来看，PostgreSQL假设所有的物理页都是从存储介质中获取的；即，PostgreSQL不会考虑扫 描的页面是否来自共享缓冲区。</p>
</blockquote>
<h3>3.2.2 索引扫描<span class="hx-absolute -hx-mt-20" id="322-索引扫描"></span>
    <a href="#322-%e7%b4%a2%e5%bc%95%e6%89%ab%e6%8f%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>尽管PostgreSQL支持很多<a href="https://www.postgresql.org/docs/current/static/indexes-types.html" target="_blank" rel="noopener">索引方法</a>，比如B树，<a href="https://www.postgresql.org/docs/current/static/gist.html" target="_blank" rel="noopener">GiST</a>，<a href="https://www.postgresql.org/docs/current/static/gin.html" target="_blank" rel="noopener">GIN</a>和<a href="https://www.postgresql.org/docs/current/static/brin.html" target="_blank" rel="noopener">BRIN</a>，不过索引扫描的代价估计都使用一个共用的代价函数：<code>cost_index()</code>。</p>
<p>本节将研究索引扫描的代价是如何估计的，以下列查询为例。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在估计该查询的代价之前，下面的查询能获取$N_{\verb|index|,\verb|page|}$和$N_{\verb|index|,\verb|tuple|}$的值：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">relpages</span><span class="p">,</span><span class="w"> </span><span class="n">reltuples</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_class</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">relname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tbl_data_idx&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">relpages</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">reltuples</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">       </span><span class="mi">30</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">10000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
$$
\begin{equation}\tag{3}
	N_{\verb|index|,\verb|tuple|} = 10000
\end{equation}
$$$$
\begin{equation}\tag{4}
	N_{\verb|index|,\verb|page|} = 30
\end{equation}
$$<h4>3.2.2.1 启动代价<span class="hx-absolute -hx-mt-20" id="3221-启动代价"></span>
    <a href="#3221-%e5%90%af%e5%8a%a8%e4%bb%a3%e4%bb%b7" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>索引扫描的启动代价就是读取索引页以访问目标表的第一条元组的代价，由下面的公式定义：
</p>
$$
\begin{equation}
\verb| start-up_cost| = \{\mathrm{ceil}(\log_2 (N_{\verb|index|,\verb|tuple|}))
		 + (H_{\verb|index|} + 1) × 50\} × \verb|cpu_operator_cost|
\end{equation}
$$<p>
其中$H_{\verb|index|}$是索引树的高度。</p>
<p>在本例中，套用公式(3)，$N_{\verb|index,tuple|}$是10000；$H_{\verb|index|}$是1；$\verb|cpu_operator_cost|$是0.0025（默认值）。因此
</p>
$$
\begin{equation}\tag{5}
 \verb|start-up_cost| = \{\mathrm{ceil}(\log_2(10000)) + (1 + 1) × 50\} × 0.0025 = 0.285
\end{equation}
$$<h4>3.2.2.2 运行代价<span class="hx-absolute -hx-mt-20" id="3222-运行代价"></span>
    <a href="#3222-%e8%bf%90%e8%a1%8c%e4%bb%a3%e4%bb%b7" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>索引扫描的运行代价是表和索引的CPU代价与IO代价之和。
</p>
$$
\begin{align}
 \verb|run_cost| &= (\verb|index_cpu_cost| + \verb|table_cpu_cost|) 
 	    	  + (\verb|index_io_cost| + \verb|table_io_cost|).
\end{align}
$$<blockquote>
  <p>如果使用<a href="https://www.postgresql.org/docs/10/static/indexes-index-only-scans.html" target="_blank" rel="noopener">仅索引扫描</a>，则不会估计<code>table_cpu_cost</code>与<code>table_io_cost</code>，仅索引扫描将在<a href="/ch7" >第七章</a>中介绍。</p>
</blockquote>
<p>前三个代价（即<code>index_cpu_cost</code>，<code>table_cpu_cost</code>和<code>index_io_cost</code>）如下所示：</p>
$$
\begin{align}
 \verb|index_cpu_cost| &= \verb|Selectivity| × N_{\verb|index|,\verb|tuple|} × (\verb|cpu_index_tuple_cost| + \verb|qual_op_cost|) \\
 \verb|table_cpu_cost| &= \verb|Selectivity| × N_{\verb|tuple|}× \verb|cpu_tuple_cost| \\
 \verb|index_io_cost|   &= \mathrm{ceil}(\verb|Selectivity| × N_{\verb|index|,\verb|page|}) ×\verb|random_page_cost|
\end{align}
$$<p>以上公式中的<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-INDEX-TUPLE-COST" target="_blank" rel="noopener"><code>cpu_index_tuple_cost</code></a>和<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST" target="_blank" rel="noopener"><code>random_page_cost</code></a>在<em>postgresql.conf</em>中配置（默认值分别为0.005和4.0）。$\verb|qual_op_cost|$粗略来说就是索引求值的代价，默认值是0.0025，这里不再展开。**选择率（Selectivity）**是一个0到1之间的浮点数，代表查询指定的<code>WHERE</code>子句在索引中搜索范围的比例。举个例子，$(\verb|Selectivity| × N_{\verb|tuple|})$就是需要读取的表元组数量，$(\verb|Selectivity| × N_{\verb|index|,\verb|tuple|})$就是需要读取的索引元组数量，诸如此类。</p>
<blockquote>
  <h4>选择率（Selectivity）<span class="hx-absolute -hx-mt-20" id="选择率selectivity"></span>
    <a href="#%e9%80%89%e6%8b%a9%e7%8e%87selectivity" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>查询谓词的选择率是通过**直方图界值（histogram_bounds）<strong>与</strong>高频值（Most Common Value, MCV）**估计的，这些信息都存储在系统目录<code>pg_statistics</code>中，并可通过<code>pg_stats</code>视图查询。这里通过一个具体的例子来简要介绍选择率的计算方法，细节可以参考<a href="https://www.postgresql.org/docs/10/static/row-estimation-examples.html" target="_blank" rel="noopener">官方文档</a>。</p>
<p>表中每一列的高频值都在<code>pg_stats</code>视图的<code>most_common_vals</code>和<code>most_common_freqs</code>中成对存储。</p>
<ul>
<li><strong>高频值（most_common_vals）</strong>：该列上最常出现的取值列表</li>
<li><strong>高频值频率（most_common_freqs）</strong>：高频值相应出现频率的列表</li>
</ul>
<p>下面是一个简单的例子。表<code>countries</code>有两列：一列<code>country</code>存储国家名，一列<code>continent</code>存储该国所属大洲。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">countries</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.countries&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">Column</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-----------+------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">country</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">text</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;continent_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">continent</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">continent</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;number of countries&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">-#</span><span class="w">     </span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">countries</span><span class="p">)::</span><span class="nb">real</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;number of countries / all countries&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">-#</span><span class="w">       </span><span class="k">FROM</span><span class="w"> </span><span class="n">countries</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s2">&#34;number of countries&#34;</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">continent</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">countries</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">countries</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">countries</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------+---------------------+-------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Africa</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="mi">53</span><span class="w"> </span><span class="o">|</span><span class="w">                   </span><span class="mi">0</span><span class="p">.</span><span class="mi">274611398963731</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Europe</span><span class="w">        </span><span class="o">|</span><span class="w">                  </span><span class="mi">47</span><span class="w"> </span><span class="o">|</span><span class="w">                   </span><span class="mi">0</span><span class="p">.</span><span class="mi">243523316062176</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Asia</span><span class="w">          </span><span class="o">|</span><span class="w">                  </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w">                   </span><span class="mi">0</span><span class="p">.</span><span class="mi">227979274611399</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">North</span><span class="w"> </span><span class="n">America</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w">                   </span><span class="mi">0</span><span class="p">.</span><span class="mi">119170984455959</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Oceania</span><span class="w">       </span><span class="o">|</span><span class="w">                  </span><span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">0</span><span class="p">.</span><span class="mi">0725388601036269</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">South</span><span class="w"> </span><span class="n">America</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="mi">0</span><span class="p">.</span><span class="mi">0621761658031088</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>考虑下面的查询，该查询带有<code>WHERE</code>条件<code>continent = 'Asia'</code>。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">countries</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">continent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Asia&#39;</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这时候，计划器使用<code>continent</code>列上的高频值来估计索引扫描的代价，列上的<code>most_common_vals</code>与 <code>most_common_freqs</code>如下所示：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Expanded</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">on</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">most_common_vals</span><span class="p">,</span><span class="w"> </span><span class="n">most_common_freqs</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stats</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">-#</span><span class="w">                  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;countries&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">attname</span><span class="o">=</span><span class="s1">&#39;continent&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="p">[</span><span class="w"> </span><span class="n">RECORD</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">]</span><span class="c1">-----+-----------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">most_common_vals</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="err">{</span><span class="n">Africa</span><span class="p">,</span><span class="n">Europe</span><span class="p">,</span><span class="n">Asia</span><span class="p">,</span><span class="s2">&#34;North America&#34;</span><span class="p">,</span><span class="n">Oceania</span><span class="p">,</span><span class="s2">&#34;South America&#34;</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">most_common_freqs</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">{</span><span class="mi">0</span><span class="p">.</span><span class="mi">274611</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">243523</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">227979</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">119171</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0725389</span><span class="p">,</span><span class="mi">0</span><span class="p">.</span><span class="mi">0621762</span><span class="err">}</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>与<code>most_common_vals</code>中<code>Asia</code>值对应的<code>most_common_freqs</code>为0.227979。因此0.227979会在估算中被用作选择率。</p>
<p>如果高频值不可用，就会使用目标列上的直方图界值来估计代价。</p>
<ul>
<li>**直方图值（histogram_bounds）**是一系列值，这些值将列上的取值划分为数量大致相同的若干个组。</li>
</ul>
<p>下面是一个具体的例子。这是表<code>tbl</code>中<code>data</code>列上的直方图界值；</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">histogram_bounds</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stats</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tbl&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">attname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        			     	      </span><span class="n">histogram_bounds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="err">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">600</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="mi">800</span><span class="p">,</span><span class="mi">900</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1100</span><span class="p">,</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1300</span><span class="p">,</span><span class="mi">1400</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="mi">1600</span><span class="p">,</span><span class="mi">1700</span><span class="p">,</span><span class="mi">1800</span><span class="p">,</span><span class="mi">1900</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2100</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">2200</span><span class="p">,</span><span class="mi">2300</span><span class="p">,</span><span class="mi">2400</span><span class="p">,</span><span class="mi">2500</span><span class="p">,</span><span class="mi">2600</span><span class="p">,</span><span class="mi">2700</span><span class="p">,</span><span class="mi">2800</span><span class="p">,</span><span class="mi">2900</span><span class="p">,</span><span class="mi">3000</span><span class="p">,</span><span class="mi">3100</span><span class="p">,</span><span class="mi">3200</span><span class="p">,</span><span class="mi">3300</span><span class="p">,</span><span class="mi">3400</span><span class="p">,</span><span class="mi">3500</span><span class="p">,</span><span class="mi">3600</span><span class="p">,</span><span class="mi">3700</span><span class="p">,</span><span class="mi">3800</span><span class="p">,</span><span class="mi">3900</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="mi">4100</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">4200</span><span class="p">,</span><span class="mi">4300</span><span class="p">,</span><span class="mi">4400</span><span class="p">,</span><span class="mi">4500</span><span class="p">,</span><span class="mi">4600</span><span class="p">,</span><span class="mi">4700</span><span class="p">,</span><span class="mi">4800</span><span class="p">,</span><span class="mi">4900</span><span class="p">,</span><span class="mi">5000</span><span class="p">,</span><span class="mi">5100</span><span class="p">,</span><span class="mi">5200</span><span class="p">,</span><span class="mi">5300</span><span class="p">,</span><span class="mi">5400</span><span class="p">,</span><span class="mi">5500</span><span class="p">,</span><span class="mi">5600</span><span class="p">,</span><span class="mi">5700</span><span class="p">,</span><span class="mi">5800</span><span class="p">,</span><span class="mi">5900</span><span class="p">,</span><span class="mi">6000</span><span class="p">,</span><span class="mi">6100</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">6200</span><span class="p">,</span><span class="mi">6300</span><span class="p">,</span><span class="mi">6400</span><span class="p">,</span><span class="mi">6500</span><span class="p">,</span><span class="mi">6600</span><span class="p">,</span><span class="mi">6700</span><span class="p">,</span><span class="mi">6800</span><span class="p">,</span><span class="mi">6900</span><span class="p">,</span><span class="mi">7000</span><span class="p">,</span><span class="mi">7100</span><span class="p">,</span><span class="mi">7200</span><span class="p">,</span><span class="mi">7300</span><span class="p">,</span><span class="mi">7400</span><span class="p">,</span><span class="mi">7500</span><span class="p">,</span><span class="mi">7600</span><span class="p">,</span><span class="mi">7700</span><span class="p">,</span><span class="mi">7800</span><span class="p">,</span><span class="mi">7900</span><span class="p">,</span><span class="mi">8000</span><span class="p">,</span><span class="mi">8100</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">8200</span><span class="p">,</span><span class="mi">8300</span><span class="p">,</span><span class="mi">8400</span><span class="p">,</span><span class="mi">8500</span><span class="p">,</span><span class="mi">8600</span><span class="p">,</span><span class="mi">8700</span><span class="p">,</span><span class="mi">8800</span><span class="p">,</span><span class="mi">8900</span><span class="p">,</span><span class="mi">9000</span><span class="p">,</span><span class="mi">9100</span><span class="p">,</span><span class="mi">9200</span><span class="p">,</span><span class="mi">9300</span><span class="p">,</span><span class="mi">9400</span><span class="p">,</span><span class="mi">9500</span><span class="p">,</span><span class="mi">9600</span><span class="p">,</span><span class="mi">9700</span><span class="p">,</span><span class="mi">9800</span><span class="p">,</span><span class="mi">9900</span><span class="p">,</span><span class="mi">10000</span><span class="err">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>默认情况下，直方图界值会将列上的取值划分入100个桶。图3.7展示了这些桶及其对应的直方图界值。桶从0开始编号，每个桶保存了（大致）相同数量的元组。直方图界值就是相应桶的边界。比如，直方图界值的第0个值是1，意即这是<code>bucket_0</code>中的最小值。第1个值是100，意即<code>bucket_1</code>中的最小值是100，等等。</p>
<p><strong>图3.7 桶和直方图界值</strong></p>
<p><img src="/img/fig-3-07.png" alt="" loading="lazy" /></p>
<p>然后本节例子中选择率计算如下所示。假设查询带有<code>WHERE</code>子句<code>data &lt; 240</code>，而值240落在第二个桶中。在本例中可以通过线性插值推算出相应的选择率。因此查询中<code>data</code>列的选择率可以套用下面的公式计算：
</p>
$$
> \verb|Selectivity| = \frac{2+(240-hb[2])/(hb[3]-hb[2])}{100}=\frac{2+(240-200)/(300-200)}{100}=\frac{2+40/100}{100}=0.024    \ (6)
> $$
</blockquote>
<p>因此，根据公式(1)，(3)，(4)和(6)，有
</p>
$$
\begin{equation}\tag{7}
	\verb|index_cpu_cost| = 0.024× 10000 × (0.005+0.0025)=1.8
\end{equation}
$$<p>
</p>
$$
\begin{equation}\tag{8}
\verb|table_cpu_cost| = 0.024 × 10000 × 0.01 = 2.4
\end{equation}
$$$$
\begin{equation}\tag{9}
\verb|index_io_cost| = \mathrm{ceil}(0.024 × 30) × 4.0 = 4.0
\end{equation}
$$<p>$\verb|table_io_cost|$ 由下面的公式定义：
</p>
$$
\begin{equation}
\verb|table_io_cost| = \verb|max_io_cost| + \verb|indexCorerelation|^2 × (\verb|min_io_cost|-\verb|max_io_cost|)
\end{equation}
$$<p>$\verb|max_io_cost_io_cost|$ 是最差情况下的I/O代价，即，随机扫描所有数据页的代价；这个代价由以下公式定义：
</p>
$$
\begin{equation}
\verb|max_io_cost| = N_{\verb|page|} × \verb|random_page_cost|
\end{equation}
$$<p>在本例中，由(2)，$N_{\verb|page|}=45$，得
</p>
$$
\begin{equation}\tag{10}
\verb|max_io_cost| = 45 × 4.0 = 180.0
\end{equation}
$$<p>$\verb|min_io_cost|$是最优情况下的I/O代价，即，顺序扫描选定的数据页；这个代价由以下公式定义：
</p>
$$
\begin{equation}
\verb|min_io_cost| = 1 × \verb|random_page_cost| + (\mathrm{ceil}(\verb|Selectivity| × N_{\verb|page|})-1) × \verb|seq_page_cost|
\end{equation}
$$<p>
在本例中，
</p>
$$
\begin{equation} \tag{11}
\verb|min_io_cost| \ = 1 × 4.0 + (\mathrm{ceil}(0.024 × 45)-1) × 1.0
\end{equation}
$$<p>下文详细介绍$\verb|indexCorrelation|$，在本例中，
</p>
$$
\begin{equation} \tag{12}
	\verb|indexCorrelation| = 1.0
\end{equation}
$$<p>由(10)，(11)和(12)，得
</p>
$$
\begin{equation} \tag{13}
\verb|table_io_cost| = 180.0+1.0^2 × (5.0-180.0)=5.0
\end{equation}
$$<p>综上，由(7)，(8)，(9)和(13)得
</p>
$$
\begin{equation}\tag{14}
\verb|run_cost| = (1.8+2.4)+(4.0+5.0)=13.2
\end{equation}
$$<blockquote>
  <h5>索引相关性（index correlation）<span class="hx-absolute -hx-mt-20" id="索引相关性index-correlation"></span>
    <a href="#%e7%b4%a2%e5%bc%95%e7%9b%b8%e5%85%b3%e6%80%a7index-correlation" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>索引相关性是列值在物理上的顺序和逻辑上的顺序的统计相关性（引自官方文档）。索引相关性的取值范围从$-1$到$+1$。下面的例子有助于理解索引扫描和索引相关性的关系。</p>
<p>表<code>tbl_corr</code>有5个列：两个列为文本类型，三个列为整数类型。这三个整数列保存着从1到12的数字。在物理上表<code>tbl_corr</code>包含三个页，每页有4条元组。每个数字列有一个名如<code>index_col_asc</code>的索引。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_corr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_corr&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">Column</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">col</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nb">text</span><span class="w">    </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">col_asc</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">col_desc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">col_rand</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">text</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_corr_asc_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">col_asc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_corr_desc_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">col_desc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_corr_rand_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">col_rand</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="n">col_asc</span><span class="p">,</span><span class="n">col_desc</span><span class="p">,</span><span class="n">col_rand</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">-#</span><span class="w">                         </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_corr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">col</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">col_asc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">col_desc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">col_rand</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------+---------+----------+----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Tuple_1</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_2</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">11</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_3</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_4</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_5</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_6</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_7</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_8</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_9</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_10</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_11</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">11</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tuple_12</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">12</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这些列的索引相关性如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">tablename</span><span class="p">,</span><span class="n">attname</span><span class="p">,</span><span class="w"> </span><span class="n">correlation</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stats</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tbl_corr&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">attname</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">correlation</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-----------+----------+-------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">tbl_corr</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">col_asc</span><span class="w">  </span><span class="o">|</span><span class="w">           </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">tbl_corr</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">col_desc</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="o">-</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">tbl_corr</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">col_rand</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="p">.</span><span class="mi">125874</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>当执行下列查询时，由于所有的目标元组都在第一页中，PostgreSQL只会读取第一页，如图3.8(a)所示。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_corr</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">col_asc</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>而执行下列查询时则不然，PostgreSQL需要读所有的页，如图3.8(b)所示。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_corr</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">col_rand</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如此可知，索引相关性是一种统计上的相关性。在索引扫描代价估计中，索引相关性体现了索引顺序和物理元组顺序扭曲程度给随机访问性能造成的影响大小。</p>
<p><strong>图3.8 索引相关性</strong></p>
<p><img src="/img/fig-3-08.png" alt="indexcor" loading="lazy" /></p>
</blockquote>
<h4>3.2.2.3 整体代价<span class="hx-absolute -hx-mt-20" id="3223-整体代价"></span>
    <a href="#3223-%e6%95%b4%e4%bd%93%e4%bb%a3%e4%bb%b7" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>由(3)和(14)可得
</p>
$$
\begin{equation}\tag{15}
	\verb|total_cost| = 0.285 + 13.2 = 13.485
\end{equation}
$$<p>作为确认，上述<code>SELECT</code>查询的<code>EXPLAIN</code>结果如下所示：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_data_idx</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">13</span><span class="p">.</span><span class="mi">49</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">240</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在第4行可以看到启动代价和总代价分别是0.29和13.49，预估有240条元组被扫描。</p>
<p>在第5行显示了一个索引条件<code>Index Cond:(data &lt; 240)</code>。更准确地说，这个条件叫做<strong>访问谓词（access predicate）</strong>，它表达了索引扫描的开始条件与结束条件。</p>
<blockquote>
  <p>根据<a href="https://use-the-index-luke.com/sql/explain-plan/postgresql/filter-predicates" target="_blank" rel="noopener">这篇文章</a>，PostgreSQL中的<code>EXPLAIN</code>命令不会区分<strong>访问谓词（access predicate）<strong>和</strong>索引过滤谓词（index filter predicate）</strong>。因此当分析<code>EXPLAIN</code>的输出时，即使看到了“IndexCond”，也应当注意一下预估返回行数。</p>
</blockquote>
<blockquote>
  <h5><code>seq_page_cost</code>和<code>random_page_cost</code><span class="hx-absolute -hx-mt-20" id="seq_page_cost和random_page_cost"></span>
    <a href="#seq_page_cost%e5%92%8crandom_page_cost" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p><a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-SEQ-PAGE-COST" target="_blank" rel="noopener"><code>seq_page_cost</code></a>和<a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST" target="_blank" rel="noopener"><code>random_page_cost</code></a>的默认值分别为1.0和4.0。这意味着PostgreSQL假设随机扫描比顺序扫描慢4倍；显然，PostgreSQL的默认值是基于HDD（普通硬盘）设置的。</p>
<p>另一方面，近年来SSD得到了广泛的应用，<code>random_page_cost</code>的默认值就显得太大了。使用SSD时如果仍然采用<code>random_page_cost</code>的默认值，则计划器有可能会选择低效的计划。因此当使用SSD时最好将<code>random_page_cost</code>的值设为1.0。</p>
<p><a href="https://amplitude.engineering/how-a-single-postgresql-config-change-improved-slow-query-performance-by-50x-85593b8991b0" target="_blank" rel="noopener">这篇文章</a>报告了使用<code>random_page_cost</code>默认值导致的问题。</p>
</blockquote>
<h3>3.2.3 排序<span class="hx-absolute -hx-mt-20" id="323-排序"></span>
    <a href="#323-%e6%8e%92%e5%ba%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p><strong>排序路径（sort path）</strong> 会在排序操作中被使用。排序操作包括<code>ORDER BY</code>，归并连接的预处理操作，以及其他函数。函数<code>cost_sort()</code>用于估计排序操作的代价。</p>
<p>如果能在工作内存中放下所有元组，那么排序操作会选用快速排序算法。否则的话则会创建临时文件，使用文件归并排序算法。</p>
<p>排序路径的启动代价就是对目标表的排序代价，因此代价就是$O(N_{\verb|sort|}× \log_2(N_{\verb|sort|})$，这里$N_{\verb|sort|}$就是待排序的元组数。排序路径的运行代价就是读取已经排好序的元组的代价，因而代价就是$O(N_{sort})$。</p>
<p>本节将研究以下查询排序代价的估计过程。假设该查询只使用工作内存，不使用临时文件。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在本例中，启动代价由以下公式定义：
</p>
$$
\begin{equation}
\verb|start-up_cost| = \verb|C|+ \verb|comparison_cost| × N_{\verb|sort|} × \log_2(N_{\verb|sort|})
\end{equation}
$$<p>这里$C$就是上一次扫描的总代价，即上次索引扫描的总代价；由(15)可得C等于13.485；$N_{\verb|sort|}=240$；$\verb|comparison_cost|$ 定义为$2 × \verb|cpu_operator_cost|$。因此有</p>
$$
\begin{equation}
\verb|start-up_cost| = 13.485+(2×0.0025)×240.0×\log_2(240.0)=22.973
\end{equation}
$$<p>运行代价是在内存中读取排好序的元组的代价，即：
</p>
$$
\begin{equation}
\verb|run_cost| = \verb|cpu_operator_cost| × N_{\verb|sort|} = 0.0025 × 240 = 0.6
\end{equation}
$$<p>
综上：
</p>
$$
\begin{equation}
\verb|total_cost|=22.973+0.6=23.573
\end{equation}
$$<p>
作为确认，以上<code>SELECT</code>查询的<code>EXPLAIN</code>命令结果如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">22</span><span class="p">.</span><span class="mi">97</span><span class="p">..</span><span class="mi">23</span><span class="p">.</span><span class="mi">57</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">240</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_data_idx</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">13</span><span class="p">.</span><span class="mi">49</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">240</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在第4行可以看到启动代价和运行代价分别为22.97和23.57。</p>
<h2>3.3 创建单表查询的计划树<span class="hx-absolute -hx-mt-20" id="33-创建单表查询的计划树"></span>
    <a href="#33-%e5%88%9b%e5%bb%ba%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2%e7%9a%84%e8%ae%a1%e5%88%92%e6%a0%91" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>计划器非常复杂，故本节仅描述最简单的情况，即单表查询的计划树创建过程。更复杂的查询，换而言之即多表查询，其计划树创建过程将在第3.6节中阐述。</p>
<p>PostgreSQL中的计划器会执行三个处理步骤：</p>
<ol>
<li>执行预处理</li>
<li>在所有可能的访问路径中，找出代价最小的访问路径</li>
<li>按照代价最小的路径，创建计划树</li>
</ol>
<p><strong>访问路径（access path）<strong>是估算代价时的处理单元；比如，顺序扫描，索引扫描，排序以及各种连接操作都有其对应的</strong>路径</strong>。访问路径只在计划器创建查询计划树的时候使用。最基本的访问路径数据结构就是<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/relation.h" target="_blank" rel="noopener"><code>relation.h</code></a>中定义的<code>Path</code>结构体。它就相当于是顺序扫描。所有其他的访问路径都基于该结构，下面会介绍细节。</p>
<p>计划器为了处理上述步骤，会在内部创建一个<code>PlannerInfo</code>数据结构。在该数据结构中包含着查询树，查询所涉及关系信息，访问路径等等。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">PathKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeTag</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EquivalenceClass</span> <span class="o">*</span><span class="n">pk_eclass</span><span class="p">;</span> <span class="cm">/* 值是否有序 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Oid</span> <span class="n">pk_opfamily</span><span class="p">;</span>             <span class="cm">/* 用于定义顺序的B树操作符族 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pk_strategy</span><span class="p">;</span>             <span class="cm">/* 排序方向(ASC or DESC) */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">pk_nulls_first</span><span class="p">;</span>         <span class="cm">/* NULL是否排序在常规值之前？ */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">PathKey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Path</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeTag</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeTag</span> <span class="n">pathtype</span><span class="p">;</span>          <span class="cm">/* 标识 scan/join 方法的标签 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">RelOptInfo</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>        <span class="cm">/* 路径所基于的关系 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PathTarget</span> <span class="o">*</span><span class="n">pathtarget</span><span class="p">;</span>    <span class="cm">/* Vars/Exprs的列表, 代价, 宽度 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ParamPathInfo</span> <span class="o">*</span><span class="n">param_info</span><span class="p">;</span> <span class="cm">/* 参数化信息, 如果没有则为NULL */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">parallel_aware</span><span class="p">;</span>       <span class="cm">/* 涉及到并行相关的逻辑？ */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">parallel_safe</span><span class="p">;</span>        <span class="cm">/* 是否能作为并行执行计划的一部分? */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">parallel_workers</span><span class="p">;</span>      <span class="cm">/* 期待的并行工作进程数量； 0表示没有并行 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 估计路径的尺寸或代价 (更多详情参考costsize.c) */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">rows</span><span class="p">;</span>       <span class="cm">/* 预估结果元组数目 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cost</span> <span class="n">startup_cost</span><span class="p">;</span> <span class="cm">/* 获取任何元组前需要花费的代价 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cost</span> <span class="n">total_cost</span><span class="p">;</span>   <span class="cm">/* 总代价 (假设获取所有元组所需代价) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">pathkeys</span><span class="p">;</span>    <span class="cm">/* 路径输出的排序顺序 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* pathkeys 是PathKey节点的列表，PathKey定义见上面 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">PlannerInfo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeTag</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Query</span> <span class="o">*</span><span class="n">parse</span><span class="p">;</span>                    <span class="cm">/* 被计划的查询 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PlannerGlobal</span> <span class="o">*</span><span class="n">glob</span><span class="p">;</span>             <span class="cm">/* 当前计划器运行时的全局信息 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Index</span> <span class="n">query_level</span><span class="p">;</span>               <span class="cm">/* 最外层查询为1 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">PlannerInfo</span> <span class="o">*</span><span class="n">parent_root</span><span class="p">;</span> <span class="cm">/* 最外层查询为NULL */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* plan_params包含着当前计划中的查询层次需要对低层查询暴露的表达式。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * outer_params包含着PARAM_EXEC参数中的paramId列表，这些参数是外
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 部查询层次对当前查询层次所暴露的。*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">plan_params</span><span class="p">;</span> <span class="cm">/* PlannerParamItems的列表, 见下 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Bitmapset</span> <span class="o">*</span><span class="n">outer_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* simple_rel_array 持有着指向“基础关系”与“其他关系”的指针 (详情参考
</span></span></span><span class="line"><span class="cl"><span class="cm">     * RelOptInfo的注释)。它由rangetable index所索引（因此第0项总是废值）。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 当RTE并不与基础关系相对应，譬如连接的RTE，或未引用的视图RTE，或该
</span></span></span><span class="line"><span class="cl"><span class="cm">     * RelOptInfo还没有产生时，里面的项目可能为NULL。*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">RelOptInfo</span> <span class="o">**</span><span class="n">simple_rel_array</span><span class="p">;</span> <span class="cm">/* 所有单个关系的RelOptInfos */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">simple_rel_array_size</span><span class="p">;</span>            <span class="cm">/* 数组分配的大小 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* simple_rte_array 与simple_rel_array 长度相同，且持有指向关联范围表项的指针。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这使得我们能避免执行rt_fetch(), 当需要展开很大的继承集时会很慢。 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">RangeTblEntry</span> <span class="o">**</span><span class="n">simple_rte_array</span><span class="p">;</span> <span class="cm">/* rangetable的数组 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* all_baserels是所有查询所涉及基本关系的关系ID列表（但不含“其他关系”的ID）
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 也就是说，最终连接时，所需构建的关系标识符。该字段是由make_one_rel计算的。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 计算发生于计算Paths之前。*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">Relids</span> <span class="n">all_baserels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* nullable_baserels 是在进行外连接的jointree中那些可空的基础关系的ID集合。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这些关系可能在WHERE子句，SELECT目标列表或其他地方产生空值。该字段由函数
</span></span></span><span class="line"><span class="cl"><span class="cm">     * deconstruct_jointree负责计算。*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">Relids</span> <span class="n">nullable_baserels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* join_rel_list是一个列表，在计划过程中连接关系的RelOptInfos都放在这里。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 对于比较小的问题，我们只是简单的扫过这个列表来完成查找。但当连接很多关系时，
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 我们会使用散列表来加速查询。散列表当且仅当join_rel_hash不为空时存在且
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 有效。注意即使用散列表查找时，我们依然会维护列表，这会简化GEQO的相关问题。*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">join_rel_list</span><span class="p">;</span>        <span class="cm">/* 连接关系的RelOptInfos */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">HTAB</span> <span class="o">*</span><span class="n">join_rel_hash</span><span class="p">;</span> <span class="cm">/* 连接关系的散列表，可选 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 当使用动态规划进行连接搜索时，join_rel_level[k]是第k层的连接关系RelOptInfos列表。
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 新的连接关系RelOptInfos会自动添加到join_rel_level[join_cur_level]中，
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 而join_cur_level为当前层级。如果没用到动态规划，join_rel_level则为空。*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">**</span><span class="n">join_rel_level</span><span class="p">;</span>    <span class="cm">/* 连接关系RelOptInfo的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">join_cur_level</span><span class="p">;</span>       <span class="cm">/* 待追加列表的序号 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">init_plans</span><span class="p">;</span>         <span class="cm">/* 查询的初始SubPlans */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">cte_plan_ids</span><span class="p">;</span>       <span class="cm">/* 子计划的ID列表，每个CTE对应一个 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">multiexpr_params</span><span class="p">;</span>   <span class="cm">/* MULTIEXPR子查询输出用到的双层嵌套参数列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">eq_classes</span><span class="p">;</span>         <span class="cm">/* 活跃的EquivalenceClasses列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">canon_pathkeys</span><span class="p">;</span>     <span class="cm">/* &#34;标准&#34; PathKeys 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">left_join_clauses</span><span class="p">;</span>  <span class="cm">/* RestrictInfos列表，用于左连接子句 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">right_join_clauses</span><span class="p">;</span> <span class="cm">/* RestrictInfos列表，用于右连接子句 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">full_join_clauses</span><span class="p">;</span>  <span class="cm">/* RestrictInfos列表，用于完全连接子句 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">join_info_list</span><span class="p">;</span>     <span class="cm">/* SpecialJoinInfos 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">append_rel_list</span><span class="p">;</span>    <span class="cm">/* AppendRelInfos 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">rowMarks</span><span class="p">;</span>           <span class="cm">/* PlanRowMarks 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">placeholder_list</span><span class="p">;</span>   <span class="cm">/* PlaceHolderInfos 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">fkey_list</span><span class="p">;</span>          <span class="cm">/* ForeignKeyOptInfos 的列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">query_pathkeys</span><span class="p">;</span>     <span class="cm">/* query_planner()期望的pathkeys */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">group_pathkeys</span><span class="p">;</span>     <span class="cm">/* groupClause的pathkeys, 如果有的话 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">window_pathkeys</span><span class="p">;</span>    <span class="cm">/* 底部窗口的pathkeys, 如果有的话 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">distinct_pathkeys</span><span class="p">;</span>  <span class="cm">/* distinctClause的pathkeys, 如果有的话 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">sort_pathkeys</span><span class="p">;</span>      <span class="cm">/* sortClause的pathkeys, 如果有的话 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">initial_rels</span><span class="p">;</span>       <span class="cm">/* 我们现在正在尝试连接的RelOptInfos */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 使用fetch_upper_rel()来获取任意特定的上层关系 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">upper_rels</span><span class="p">[</span><span class="n">UPPERREL_FINAL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="cm">/* upper-rel RelOptInfos */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* grouping_planner针对上层处理过程选择的目标列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">PathTarget</span> <span class="o">*</span><span class="n">upper_targets</span><span class="p">[</span><span class="n">UPPERREL_FINAL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* grouping_planner会将最终处理过后的targetlist回传至此。在最终计划最顶层的目标列表中会用到 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">processed_tlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* create_plan()期间填充的字段，定义于setrefs.c */</span>
</span></span><span class="line"><span class="cl">    <span class="n">AttrNumber</span> <span class="o">*</span><span class="n">grouping_map</span><span class="p">;</span>    <span class="cm">/* 针对GroupingFunc的修补 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">minmax_aggs</span><span class="p">;</span>           <span class="cm">/* MinMaxAggInfos列表 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryContext</span> <span class="n">planner_cxt</span><span class="p">;</span>   <span class="cm">/* 持有PlannerInfo的上下文 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">total_table_pages</span><span class="p">;</span>    <span class="cm">/* 查询涉及到所有表的页面总数 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">tuple_fraction</span><span class="p">;</span>       <span class="cm">/* 传递给查询计划器的tuple_fraction */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">limit_tuples</span><span class="p">;</span>         <span class="cm">/* 传递给查询计划器的limit_tuples */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasInheritedTarget</span><span class="p">;</span>     <span class="cm">/* 若parse-&gt;resultRelation为继承的子关系则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasJoinRTEs</span><span class="p">;</span>            <span class="cm">/* 如果任意RTEs为RTE_JOIN类别则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasLateralRTEs</span><span class="p">;</span>         <span class="cm">/* 如果任意RTEs被标记为LATERAL则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasDeletedRTEs</span><span class="p">;</span>         <span class="cm">/* 如果任意RTEs从连接树中被删除则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasHavingQual</span><span class="p">;</span>          <span class="cm">/* 如果havingQual非空则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasPseudoConstantQuals</span><span class="p">;</span> <span class="cm">/* 如果任意RestrictInfo包含
</span></span></span><span class="line"><span class="cl"><span class="cm">    								pseudoconstant = true则为真 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasRecursion</span><span class="p">;</span>           <span class="cm">/* 如果计划中包含递归WITH项则为真 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 当hasRecursion为真时，会使用以下字段： */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">wt_param_id</span><span class="p">;</span>                 <span class="cm">/* 工作表上PARAM_EXEC的ID */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">Path</span> <span class="o">*</span><span class="n">non_recursive_path</span><span class="p">;</span> <span class="cm">/* 非递归项的路径 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 这些字段是createplan.c的工作变量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Relids</span> <span class="n">curOuterRels</span><span class="p">;</span>  <span class="cm">/* 当前节点外部的关系 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span> <span class="o">*</span><span class="n">curOuterParams</span><span class="p">;</span> <span class="cm">/* 尚未赋值的NestLoopParams */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 可选的join_search_hook私有数据, 例如, GEQO */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">join_search_private</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">PlannerInfo</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>本节会通过一个具体的例子，来描述如何基于查询树创建计划树。</p>
<h3>3.3.1 预处理<span class="hx-absolute -hx-mt-20" id="331-预处理"></span>
    <a href="#331-%e9%a2%84%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在创建计划树之前，计划器对先<code>PlannerInfo</code>中的查询树进行一些预处理。</p>
<p>预处理有很多步骤，本节只讨论和单表查询处理相关的主要步骤。其他预处理操作将在3.6节中描述。</p>
<ol>
<li>
<p>简化<strong>目标列表（target list）</strong>，<code>LIMIT</code>子句等；</p>
<p>例如，表达式<code>2+2</code>会被重写为<code>4</code>，这是由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/clauses.c" target="_blank" rel="noopener"><code>clauses.c</code></a>中<code>eval_const_expressions()</code>函数负责的。</p>
</li>
<li>
<p>布尔表达式的规范化</p>
<p>例如，<code>NOT(NOT a)</code>会被重写为<code>a</code></p>
</li>
<li>
<p>压平与/或表达式</p>
<p>SQL标准中的AND/OR是二元操作符；但在PostgreSQL内部它们是多元操作符。而计划器总是会假设所有的嵌套AND/OR都应当被压平。</p>
<p>这里有一个具体的例子。考虑这样一个布尔表达式<code>(id = 1) OR (id = 2) OR (id = 3)</code>，图3.9(a) 展示了使用二元表达式时的查询树，预处理会将这些二元算子简化压平为一个三元算子，如图3.9(b)所示。</p>
<p><strong>图3.9. 压平布尔表达式的例子</strong></p>
<p><img src="/img/fig-3-09.png" alt="扁平化" loading="lazy" /></p>
</li>
</ol>
<h3>3.3.2 找出代价最小的访问路径<span class="hx-absolute -hx-mt-20" id="332-找出代价最小的访问路径"></span>
    <a href="#332-%e6%89%be%e5%87%ba%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>计划器对所有可能的访问路径进行代价估计，然后选择代价最小的那个。具体来说，计划器会执行以下几个步骤：</p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>数据结构，存储访问路径及其代价。</p>
<p><code>RelOptInfo</code>结构体是通过<code>make_one_rel()</code>函数创建的，并存储于<code>PlannerInfo</code>结构体的<code>simple_rel_array</code>字段中，如图3.10所示。在初始状态时<code>RelOptInfo</code>持有着<code>baserestrictinfo</code>变量，如果存在相应索引，还会持有<code>indexlist</code>变量。<code>baserestrictinfo</code>存储着查询的<code>WHERE子</code>句，而<code>indexlist</code>存储着目标表上相关的索引。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="n">RelOptKind</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">RELOPT_BASEREL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">RELOPT_JOINREL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">RELOPT_OTHER_MEMBER_REL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">RELOPT_UPPER_REL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">RELOPT_DEADREL</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">RelOptKind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">RelOptInfo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NodeTag</span>		<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">RelOptKind</span>	<span class="n">reloptkind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 本RelOptInfo包含的所有关系 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Relids</span>		<span class="n">relids</span><span class="p">;</span>			<span class="cm">/* 基本关系的ID集合 (范围表索引) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 由计划器生成的预估尺寸 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span>		<span class="n">rows</span><span class="p">;</span>			<span class="cm">/* 预估结果元组数目 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 计划器标记位，每个关系一份 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">consider_startup</span><span class="p">;</span>	    <span class="cm">/* 保留启动代价最低的路径？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">consider_param_startup</span><span class="p">;</span> <span class="cm">/* 同上, 针对参数化路径？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">consider_parallel</span><span class="p">;</span>	    <span class="cm">/* 考虑并行路径？ */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 扫描当前关系的默认结果目标列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">PathTarget</span> <span class="o">*</span><span class="n">reltarget</span><span class="p">;</span>		<span class="cm">/* Vars/Exprs, 代价, 宽度的列表 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 物化相关信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">pathlist</span><span class="p">;</span>			    <span class="cm">/* Path 结构体列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">ppilist</span><span class="p">;</span>			    <span class="cm">/* pathlist中使用的ParamPathInfos */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">partial_pathlist</span><span class="p">;</span>		<span class="cm">/* 部分路径 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Path</span> <span class="o">*</span><span class="n">cheapest_startup_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Path</span> <span class="o">*</span><span class="n">cheapest_total_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Path</span> <span class="o">*</span><span class="n">cheapest_unique_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	    <span class="o">*</span><span class="n">cheapest_parameterized_paths</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 基础关系与连接关系都需要的 参数化信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* (参见 lateral_vars 与 lateral_referencers) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Relids</span>		<span class="n">direct_lateral_relids</span><span class="p">;</span>	<span class="cm">/* 直接以LATERAL方式引用的关系 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Relids</span>		<span class="n">lateral_relids</span><span class="p">;</span> 	    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 关于基础关系的信息 (连接关系不会设置这些字段！) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Index</span>		<span class="n">relid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="n">reltablespace</span><span class="p">;</span>	    <span class="cm">/* 表空间 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">RTEKind</span>		<span class="n">rtekind</span><span class="p">;</span>		    <span class="cm">/* RELATION, SUBQUERY, 或 FUNCTION */</span>
</span></span><span class="line"><span class="cl">	<span class="n">AttrNumber</span>	<span class="n">min_attr</span><span class="p">;</span>		    <span class="cm">/* 关系属性的最小值 (通常&lt;0) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">AttrNumber</span>	<span class="n">max_attr</span><span class="p">;</span>		    <span class="cm">/* 关系属性的最大值 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Relids</span>	   	<span class="o">*</span><span class="n">attr_needed</span><span class="p">;</span>		<span class="cm">/* 被索引的数组 [min_attr .. max_attr] */</span>
</span></span><span class="line"><span class="cl">	<span class="n">int32</span>	   	<span class="o">*</span><span class="n">attr_widths</span><span class="p">;</span>	   	<span class="cm">/* 被索引的数组 [min_attr .. max_attr] */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">lateral_vars</span><span class="p">;</span>	   	<span class="cm">/* 关系所引用的LATERAL Vars 与 PHVs */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Relids</span>		<span class="n">lateral_referencers</span><span class="p">;</span><span class="cm">/* 侧面引用本表的关系 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">indexlist</span><span class="p">;</span>		    <span class="cm">/* IndexOptInfo列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlockNumber</span> <span class="n">pages</span><span class="p">;</span>			    <span class="cm">/* 来自pg_class的页面数估计值 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span>		<span class="n">tuples</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span>		<span class="n">allvisfrac</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PlannerInfo</span> <span class="o">*</span><span class="n">subroot</span><span class="p">;</span>		    <span class="cm">/* 如有子查询 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">subplan_params</span><span class="p">;</span> 	<span class="cm">/* 如有子查询 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>		    <span class="n">rel_parallel_workers</span><span class="p">;</span>	<span class="cm">/* 期望的并行工作进程数量 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 有关外部表与外部表连接的相关信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>			<span class="n">serverid</span><span class="p">;</span>		<span class="cm">/* 外部表与外部表连接相应的服务器ID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>			<span class="n">userid</span><span class="p">;</span>			<span class="cm">/* 用于检查访问权限的用户标识 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">useridiscurrent</span><span class="p">;</span><span class="cm">/* 当前用户是否能合法进行JOIN */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">FdwRoutine</span> <span class="o">*</span><span class="n">fdwroutine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span>	   	<span class="o">*</span><span class="n">fdw_private</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 被各种扫描与连接所使用 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">baserestrictinfo</span><span class="p">;</span>	<span class="cm">/* RestrictInfo结构体列表 (如果存在基础关系) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">QualCost</span>	<span class="n">baserestrictcost</span><span class="p">;</span>	<span class="cm">/* 求值上述限制条件的代价 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">joininfo</span><span class="p">;</span>		    <span class="cm">/* RestrictInfo 结构体列表，涉及到本表的连接会用到 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">has_eclass_joins</span><span class="p">;</span>	<span class="cm">/* T 意味着joininfo不完整 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">RelOptInfo</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>估计所有可能访问路径的代价，并将访问路径添加至<code>RelOptInfo</code>结构中。</p>
<p>这一处理过程的细节如下：</p>
<ol>
<li>创建一条路径，估计该路径中顺序扫描的代价，并将其写入路径中。将该路径添加到<code>RelOptInfo</code>结构的<code>pathlist</code>变量中。</li>
<li>如果目标表上存在相关的索引，则为每个索引创建相应的索引访问路径。估计所有索引扫描的代价，并将代价写入相应路径中。然后将索引访问路径添加到<code>pathlist</code>变量中。</li>
<li>如果可以进行<a href="https://wiki.postgresql.org/wiki/Bitmap_Indexes" target="_blank" rel="noopener">位图扫描</a>，则创建一条位图扫描访问路径。估计所有的位图扫描的代价，并将代价写入到路径中。然后将位图扫描路径添加到<code>pathlist</code>变量中。</li>
</ol>
</li>
<li>
<p>从<code>RelOptInfo</code>的<code>pathlist</code>中，找出代价最小的访问路径。</p>
</li>
<li>
<p>如有必要，估计<code>LIMIT</code>，<code>ORDER BY</code>和<code>AGGREGATE</code>操作的代价。</p>
</li>
</ol>
<p>为了更加清晰的理解计划器的执行过程，下面给出了两个具体的例子。</p>
<h4>3.3.2.1 例1<span class="hx-absolute -hx-mt-20" id="3321-例1"></span>
    <a href="#3321-%e4%be%8b1" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>首先来研究一个不带索引的简单单表查询；该查询同时包含<code>WHERE</code>和<code>ORDER BY</code>子句。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">300</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>图3.10和图3.11展示了本例中计划器的处理过程。</p>
<p><strong>图3.10 如何得到例1中代价最小的路径</strong></p>
<p><img src="/img/fig-3-10.png" alt="" loading="lazy" /></p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>结构，将其保存在<code>PlannerInfo</code>结构的<code>simple_rel_array</code>字段中。</p>
</li>
<li>
<p>在<code>RelOptInfo</code>结构的<code>baserestrictinfo</code>字段中，添加一条<code>WHERE</code>子句。</p>
<p><code>WHERE</code>子句<code>id&lt;300</code>会经由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/initsplan.c" target="_blank" rel="noopener"><code>initsplan.c</code></a>中定义的<code>distribute_restrictinfo_to_rels()</code>函数，添加至列表变量<code>baserestrictinfo</code>中。另外由于目标表上没有相关索引，<code>RelOptInfo</code>的<code>indexlist</code>字段为空。</p>
</li>
<li>
<p>为了满足排序要求，<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c" target="_blank" rel="noopener"><code>planner.c</code></a>中的<code>standard_qp_callback()</code>函数会在<code>PlannerInfo</code>的<code>sor_pathkeys</code>字段中添加一个<code>pathkey</code>。</p>
<p><code>Pathkey</code>是表示路径排序顺序的数据结构。本例因为查询包含一条<code>ORDER BY</code>子句，且该子句中的列为<code>data</code>，故<code>data</code>会被包装为<code>pathkey</code>，放入列表变量<code>sort_pathkeys</code>中。</p>
</li>
<li>
<p>创建一个<code>Path</code>结构，并使用<code>cost_seqscan</code>函数估计顺序扫描的代价，并将代价写入<code>Path</code>中。然后使用<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/pathnode.c" target="_blank" rel="noopener"><code>pathnode.c</code></a>中定义的<code>add_path()</code>函数，将该路径添加至<code>RelOptInfo</code>中。</p>
<p>如之前所提到过的，<code>Path</code>中同时包含启动代价和总代价，都是由<code>cost_seqscan</code>函数所估计的。</p>
</li>
</ol>
<p>在本例中，因为目标表上没有索引，计划器只估计了顺序扫描的代价，因此最小代价是自动确定的。</p>
<p><strong>图3.11 如何得到例1中代价最小的路径（接图3.10）</strong></p>
<p><img src="/img/fig-3-11.png" alt="" loading="lazy" /></p>
<ol start="5">
<li>
<p>创建一个新的<code>RelOptInfo</code>结构，用于处理<code>ORDER BY</code>子句。</p>
<p>注意新的<code>RelOptInfo</code>没有<code>baserestrictinfo</code>字段，该信息已经被<code>WHERE</code>子句所持有。</p>
</li>
<li>
<p>创建一个排序路径，并添加到新的<code>RelOptInfo</code>中；然后让<code>SortPath</code>的<code>subpath</code>字段指向顺序扫描的路径。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">SortPath</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span>	<span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span>	<span class="o">*</span><span class="n">subpath</span><span class="p">;</span>		<span class="cm">/* 代表输入来源的子路径 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SortPath</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>SortPath</code>结构包含两个<code>Path</code>结构：<code>path</code>与<code>subpath</code>；<code>path</code>中存储了排序算子本身的相关信息，而<code>subpath</code>则指向之前得到的代价最小的路径。</p>
<p>注意顺序扫描路径中<code>parent</code>字段，该字段指向之前的<code>RelOptInfo</code>结构体（也就是在<code>baserestrictinfo</code>中存储着<code>WHERE</code>子句的那个<code>RelOptInfo</code>）。因此在下一步创建计划树的过程中，尽管新的<code>RelOptInfo</code>结构并未包含<code>baserestrictinfo</code>，但计划器可以创建一个包含<code>Filter</code>的顺序扫描节点，将<code>WHERE</code>子句作为过滤条件。</p>
</li>
</ol>
<p>这里已经获得了代价最小的访问路径，然后就可以基于此生成一颗计划树。3.3.3节描述了相关的细节。</p>
<h4>3.3.2.2 例2<span class="hx-absolute -hx-mt-20" id="3322-例2"></span>
    <a href="#3322-%e4%be%8b2" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>下面我们将研究另一个单表查询的例子，这一次表上有两个索引，而查询带有一个<code>WHERE</code>子句。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_2_pkey&#34;</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_2_data_idx&#34;</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">240</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>图3.12到3.14展示了本例中计划器的处理过程。</p>
<ol>
<li>
<p>创建一个<code>RelOptInfo</code>结构体</p>
</li>
<li>
<p>在<code>baserestrictinfo</code>中添加一个<code>WHERE</code>子句；并将目标表上的索引（们）添加到<code>indexlist</code>中。</p>
<p>在本例中，<code>WHERE</code>子句<code>'id &lt;240'</code>会被添加至<code>baserestrictinfo</code>中，而两个索引：<code>tbl_2_pkey</code>和<code>tbl_2_data_idx</code>会被添加至<code>RelOptInfo</code>的列表变量<code>indexlist</code>中。</p>
</li>
<li>
<p>创建一条路径，估计其顺序扫描代价，并添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
</li>
</ol>
<p><strong>图3.12 如何得到例2中代价最小的路径</strong></p>
<p><img src="/img/fig-3-12.png" alt="" loading="lazy" /></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">IndexPath</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Path</span>			<span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IndexOptInfo</span> 	<span class="o">*</span><span class="n">indexinfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   		<span class="o">*</span><span class="n">indexclauses</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   		<span class="o">*</span><span class="n">indexquals</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   		<span class="o">*</span><span class="n">indexqualcols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   		<span class="o">*</span><span class="n">indexorderbys</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   		<span class="o">*</span><span class="n">indexorderbycols</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ScanDirection</span> 	<span class="n">indexscandir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Cost</span>			<span class="n">indextotalcost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Selectivity</span> 	<span class="n">indexselectivity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IndexPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * IndexOptInfo
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      用于计划/优化的信息，每个索引对应一个。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		indexkeys[], indexcollations[], opfamily[], 以及 opcintype[]
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		每个字段都有 ncolumns 个项.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		sortopfamily[], reverse_sort[], 以及 nulls_first[] 类似，也都有
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		ncolumns 个项, 当且仅当该索引是有序的，否则这些指针都为空。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		indexkeys[] 数组中的零值表示该索引列是一个表达式，而每个这种列在indexprs
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      中都会有一个对应的元素。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      对于有序索引，reverse_sort[] 以及 nulls_first[] 描述了正向索引扫描时
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      索引的排序顺序。当进行反向索引扫描时，就会产生相反的顺序。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		indexprs 与 indpred 会通过prepqual.c 中的 eval_const_expressions() 
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      用于简单地与WHERE子句匹配，indpred使用简单的合取范式。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		indextlist 是 TargetEntry的列表，标识着索引建在哪些列上。对于简单的列，
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      它会提供基本关系中与之对应的Var，对于表达式列，它还会指向indexprs对应元素。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      相对应的Var。
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		当IndexOptInfo创建时，这里大多数字段都会被填充 (plancat.c)，但indrestrictinfo 
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      与predOK会在稍后通过check_index_predicates()设置。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">IndexOptInfo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NodeTag</span>		<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="n">indexoid</span><span class="p">;</span>		<span class="cm">/* 索引关系的OID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="n">reltablespace</span><span class="p">;</span>	<span class="cm">/* 索引所属的表空间 (不是表) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">RelOptInfo</span> 	<span class="o">*</span><span class="n">rel</span><span class="p">;</span>			<span class="cm">/* 索引对应的表，反向链接 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 索引尺寸的统计 (来自pg_class和其他地方) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlockNumber</span> <span class="n">pages</span><span class="p">;</span>			<span class="cm">/* 索引中的磁盘页面数 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span>		<span class="n">tuples</span><span class="p">;</span>			<span class="cm">/* 索引中的元组数量 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>		    <span class="n">tree_height</span><span class="p">;</span>	<span class="cm">/* 索引树的高度，未知则为 -1  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 索引描述符信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>		    <span class="n">ncolumns</span><span class="p">;</span>		<span class="cm">/* 索引中列的数量 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>		    <span class="o">*</span><span class="n">indexkeys</span><span class="p">;</span>		<span class="cm">/* 索引中列的序号，或者0 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="o">*</span><span class="n">indexcollations</span><span class="p">;</span>	<span class="cm">/* 索引列上排序规则的OID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="o">*</span><span class="n">opfamily</span><span class="p">;</span>		<span class="cm">/* 列上运算符族的OID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="o">*</span><span class="n">opcintype</span><span class="p">;</span>		<span class="cm">/* 运算符族输入数据类型的OID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="o">*</span><span class="n">sortopfamily</span><span class="p">;</span>	<span class="cm">/* 如果这些列有序，B树算子族的OID */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>	   	<span class="o">*</span><span class="n">reverse_sort</span><span class="p">;</span>	<span class="cm">/* 排序顺序是反向降序的吗？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>	   	<span class="o">*</span><span class="n">nulls_first</span><span class="p">;</span>	<span class="cm">/* 排序顺序中，空值是排在最前面的吗？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>	   	<span class="o">*</span><span class="n">canreturn</span><span class="p">;</span>		<span class="cm">/* 在仅索引扫描中，哪些索引列可以被返回？ */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>		    <span class="n">relam</span><span class="p">;</span>			<span class="cm">/* 访问方法的OID (在 pg_am 中) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">indexprs</span><span class="p">;</span>		<span class="cm">/* 非平凡的索引列，即表达式 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">indpred</span><span class="p">;</span>		<span class="cm">/* 如果是部分索引，则为谓词，否则为空 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">indextlist</span><span class="p">;</span>	<span class="cm">/* 表示索引列的目标列表 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">indrestrictinfo</span><span class="p">;</span>	<span class="cm">/* 父关系的baserestrictinfo列表 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">predOK</span><span class="p">;</span>			    <span class="cm">/* 如果查询与索引谓词匹配则为真 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">unique</span><span class="p">;</span>			    <span class="cm">/* 唯一索引则为真 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">immediate</span><span class="p">;</span>		    <span class="cm">/* 唯一约束是否是立即强制实施的？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hypothetical</span><span class="p">;</span>		<span class="cm">/* 如果索引并非真实存在则为真。 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 剩下这些字段是从索引访问方法的API结构里复制过来的 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amcanorderbyop</span><span class="p">;</span>     <span class="cm">/* 访问方法是否支持按算子结果排序？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amoptionalkey</span><span class="p">;</span>		<span class="cm">/* 查询是否可以忽略第一列中的键？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amsearcharray</span><span class="p">;</span>		<span class="cm">/* 访问方法是否能处理ScalarArrayOpExpr限定条件? */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amsearchnulls</span><span class="p">;</span>		<span class="cm">/* 访问方法是否能搜索空项或非空项？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amhasgettuple</span><span class="p">;</span>		<span class="cm">/* 访问方法是否有amgettuple接口？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">amhasgetbitmap</span><span class="p">;</span> 	<span class="cm">/* 访问方法是否有amgetbitmap接口？ */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 相比include amapi.h，我们直接在这里用这种方式声明 amcostestimate  */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">amcostestimate</span><span class="p">)</span> <span class="p">();</span>	<span class="cm">/* 访问方法的代价估计器 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IndexOptInfo</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ol start="4">
<li>
<p>创建一个<code>IndexPath</code>，估计索引扫描的代价，并通过<code>add_path()</code>函数将<code>IndexPath</code>添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>在本例中有两个索引：<code>tbl_2_pkey</code>与<code>tbl_2_data_index</code>，这些索引会按先后顺序依次处理。</p>
<p>一条针对<code>tbl_2_pkey</code>的<code>IndexPath</code>会先被创建出来，并进行启动代价与总代价的评估。在本例中，<code>tbl_2_pkey</code>是<code>id</code>列上的索引，而<code>WHERE</code>子句也包含该<code>id</code>列；因此<code>WHERE</code>子句会被存储在<code>IndexPath</code>的<code>indexclauses</code>字段中。</p>
</li>
<li>
<p>创建另一个<code>IndexPath</code>，估计另一种索引扫描的代价，并将该<code>IndexPath</code>添加到<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>接下来，与<code>tbl_2_data_idx</code>相应的<code>IndexPath</code>会被创建出来，并进行代价估计。本例中<code>tbl_2_data_idx</code>并没有相关的<code>WHERE</code>子句；因此其<code>indexclauses</code>为空。</p>
</li>
</ol>
<blockquote>
  <p>注意<code>add_path()</code>函数并不总是真的会将路径添加到路径列表中。这一操作相当复杂，故这里就省去了具体描述。详细细节可以参考<code>add_path()</code>函数的注释。</p>
</blockquote>
<p><strong>图3.13 如何得到例2中代价最小的路径（接图3.12）</strong></p>
<p><img src="/img/fig-3-13.png" alt="" loading="lazy" /></p>
<ol start="6">
<li>
<p>创建一个新的<code>RelOptInfo</code>结构</p>
</li>
<li>
<p>将代价最小的路径，添加到新<code>RelOptInfo</code>的<code>pathlist</code>中。</p>
<p>本例中代价最小的路径是使用<code>tbl_2_pkey</code>的索引路径；故将该路径添加到新的<code>RelOptInfo</code>中。</p>
</li>
</ol>
<p><strong>图3.14 如何得到例2中代价最小的路径（接图3.13）</strong></p>
<p><img src="/img/fig-3-14.png" alt="" loading="lazy" /></p>
<h3>3.3.3 创建计划树<span class="hx-absolute -hx-mt-20" id="333-创建计划树"></span>
    <a href="#333-%e5%88%9b%e5%bb%ba%e8%ae%a1%e5%88%92%e6%a0%91" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在最后一步中，计划器按照代价最小的路径生成一颗计划树。 </p>
<p>计划树的根节点是定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h" target="_blank" rel="noopener"><code>plannodes.h</code></a>中的<code>PlannedStmt</code>结构，包含19个字段，其中有4个代表性字段：</p>
<ul>
<li>**<code>commandType</code>**存储操作的类型，诸如<code>SELECT</code>，<code>UPDATE</code>和<code>INSERT</code>。</li>
<li>**<code>rtable</code>**存储范围表的列表（<code>RangeTblEntry</code>的列表）。</li>
<li>**<code>relationOids</code>**存储与查询相关表的<code>oid</code>。</li>
<li>**<code>plantree</code>**存储着一颗由计划节点组成的计划树，每个计划节点对应着一种特定操作，诸如顺序扫描，排序和索引扫描。</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *		PlannedStmt 节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 计划器的输出是一颗计划树，PlannedStmt是计划树的根节点。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PlannedStmt存储着执行器所需的“一次性”信息。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ----------------*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">PlannedStmt</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NodeTag</span>		<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CmdType</span>		<span class="n">commandType</span><span class="p">;</span>		<span class="cm">/* 增|删|改|查 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint32</span>		<span class="n">queryId</span><span class="p">;</span>			<span class="cm">/* 查询标识符 (复制自Query) */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasReturning</span><span class="p">;</span>		<span class="cm">/* 增|删|改是否带有RETURNING? */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">hasModifyingCTE</span><span class="p">;</span>	<span class="cm">/* WITH子句中是否出现了增|删|改？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">canSetTag</span><span class="p">;</span>			<span class="cm">/* 我是否设置了命令结果标记？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">transientPlan</span><span class="p">;</span>		<span class="cm">/* 当TransactionXmin变化时重新进行计划? */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">dependsOnRole</span><span class="p">;</span>		<span class="cm">/* 执行计划是否特定于当前的角色？ */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">parallelModeNeeded</span><span class="p">;</span>	<span class="cm">/* 需要并行模式才能执行？ */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Plan</span> <span class="o">*</span><span class="n">planTree</span><span class="p">;</span>			<span class="cm">/* 计划节点树 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">rtable</span><span class="p">;</span>			<span class="cm">/* RangeTblEntry节点的列表 */</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="cm">/* 目标关系上用于增|删|改的范围表索引 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">resultRelations</span><span class="p">;</span>   <span class="cm">/* RT索引的整数列表, 或NIL */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Node</span>	   	<span class="o">*</span><span class="n">utilityStmt</span><span class="p">;</span>		<span class="cm">/* 如为DECLARE CURSOR则非空 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">subplans</span><span class="p">;</span>			<span class="cm">/* SubPlan表达式的计划树 expressions */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Bitmapset</span>  	<span class="o">*</span><span class="n">rewindPlanIDs</span><span class="p">;</span>		<span class="cm">/* 需要REWIND的子计划的索引序号 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">rowMarks</span><span class="p">;</span>			<span class="cm">/* PlanRowMark列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">relationOids</span><span class="p">;</span>		<span class="cm">/* 计划所依赖的关系OID列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">invalItems</span><span class="p">;</span>		<span class="cm">/* 其他依赖，诸如PlanInvalItems */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">nParamExec</span><span class="p">;</span>			<span class="cm">/* 使用的PARAM_EXEC参数数量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">PlannedStmt</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p> 如上所述，计划树包含各式各样的计划节点。<code>PlanNode</code>是所有计划节点的基类，其他计划节点都会包含<code>PlanNode</code>结构。比如顺序扫描节点<code>SeqScanNode</code>，包含一个<code>PlanNode</code>和一个整型变量<code>scanrelid</code>。<code>PlanNode</code>包含14个字段。下面是7个代表性字段：</p>
<ul>
<li><code>startup_cost</code>和<code>total_cost</code>是该节点对应操作的预估代价。</li>
<li><code>rows</code>是计划器预计扫描的行数。</li>
<li><code>targetlist</code>保存了该查询树中目标项的列表。</li>
<li><code>qual</code>储存了限定条件的列表。</li>
<li><code>lefttree</code>和<code>righttree</code>用于添加子节点。</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 计划节点(Plan Node)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 所有的计划节点都&#34;派生&#34;自Plan结构，将其作为自己的第一个字段。这样确保了当其强制转换为Plan
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 结构时所有东西都能正常工作。(当作为通用参数传入执行器时，节点指针会很频繁地转换为Plan*)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 我们从来不会真的去实例化任何Plan节点，它只是所有Plan类型节点的公共抽象父类。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Plan</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">NodeTag</span>		<span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 计划的预估执行开销 ( 详情见 costsize.c )	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Cost</span>		<span class="n">startup_cost</span><span class="p">;</span>	<span class="cm">/* 获取第一条元组前的代价 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Cost</span>		<span class="n">total_cost</span><span class="p">;</span>		<span class="cm">/* 获取所有元组的代价 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 计划器对该计划步骤返回结果大小的估计 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">double</span>		<span class="n">plan_rows</span><span class="p">;</span>		<span class="cm">/* 计划预期产出的行数 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">plan_width</span><span class="p">;</span>		<span class="cm">/* 以字节计的行宽 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 并行查询所需的信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>		<span class="n">parallel_aware</span><span class="p">;</span> <span class="cm">/* 是否涉及到并行逻辑？ */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 所有计划类型的公有结构化数据 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">plan_node_id</span><span class="p">;</span>	<span class="cm">/* 在整个计划树范围内唯一的标识 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">targetlist</span><span class="p">;</span>	<span class="cm">/* 该节点需要计算的目标列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">qual</span><span class="p">;</span>			<span class="cm">/* 隐式合取化处理的 限制条件 列表 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Plan</span> <span class="o">*</span><span class="n">lefttree</span><span class="p">;</span>		<span class="cm">/* 输入的查询树 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">Plan</span> <span class="o">*</span><span class="n">righttree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   	<span class="o">*</span><span class="n">initPlan</span><span class="p">;</span>	<span class="cm">/* Init Plan 节点 (无关子查询表达式) */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* “参数变化驱动”的重扫描 相关的管理信息
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * extParam包含着所有外部PARAM_EXEC参数的参数ID列表，这些参数会影响当前计划节点
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 及其子节点。这里不包括该节点initPlans时setParam的相关参数，但会包括其extParams
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * allParam包含了所有extParam的参数ID列表，以及影响当前节点的参数ID。（即，
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在initPlans中setParams的参数）。注意这里包含了*所有*会影响本节点的PARAM_EXEC参数
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Bitmapset</span>	<span class="o">*</span><span class="n">extParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Bitmapset</span>  	<span class="o">*</span><span class="n">allParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 扫描节点(Scan nodes)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ----------- */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Scan</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Plan</span>		<span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Index</span>		<span class="n">scanrelid</span><span class="p">;</span>		<span class="cm">/* relid 是访问范围表的索引 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Scan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	顺序扫描节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ---------------- */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">Scan</span> <span class="n">SeqScan</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>下面是两颗计划树，分别与前一小节中的两个例子对应。</p>
<h4>3.3.3.1 例1<span class="hx-absolute -hx-mt-20" id="3331-例1"></span>
    <a href="#3331-%e4%be%8b1" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>第一个例子是3.3.2.1节例1对应的计划树。图3.11所示的代价最小的路径，是由一个排序路径和一个顺序扫描路径组合而成。根路径是排序路径，而其子路径为顺序扫描路径。尽管这里忽略了大量细节，但是从代价最小的路径中生成计划树的过程是显而易见的。在本例中，一个 <code>SortNode</code>被添加到<code>PlannedStmt</code>结构中，而<code>SortNode</code>的左子树上则挂载了一个<code>SeqScanNode</code>，如图3.15(a)所示。</p>
<p>在<code>SortNode</code>中，左子树<code>lefttree</code>指向<code>SeqScanNode</code>。</p>
<p>在<code>SeqScanNode</code>中，<code>qual</code>保存了<code>WHERE</code>子句：<code>'id&lt;300'</code>。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Sort</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Plan</span>		<span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">numCols</span><span class="p">;</span>			<span class="cm">/* 排序键 列的数目 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">AttrNumber</span> 	<span class="o">*</span><span class="n">sortColIdx</span><span class="p">;</span>		<span class="cm">/* 它们在目标列表中的位置序号 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>			<span class="o">*</span><span class="n">sortOperators</span><span class="p">;</span>		<span class="cm">/* 排序所赖运算符的OID  */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Oid</span>			<span class="o">*</span><span class="n">collations</span><span class="p">;</span>		<span class="cm">/* collation的OID  */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>	   	<span class="o">*</span><span class="n">nullsFirst</span><span class="p">;</span>		<span class="cm">/* NULLS FIRST/LAST 方向 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Sort</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>图3.15. 计划树的例子</strong></p>
<p><img src="/img/fig-3-15.png" alt="" loading="lazy" /></p>
<h4>3.3.3.2 例2<span class="hx-absolute -hx-mt-20" id="3332-例2"></span>
    <a href="#3332-%e4%be%8b2" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>第二个例子是3.3.2.2节例2对应的计划树。其代价最小的路径为索引扫描路径，如图3.14所示。因此计划树由单个<code>IndexScanNode</code>独立组成，如图3.15(b)所示。</p>
<p>在本例中，<code>WHERE</code>子句<code>id &lt; 240</code>是一个访问谓词，它储存在<code>IndexScanNode</code>的<code>indexqual</code>字段中。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* 索引扫描节点 */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Scan</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Plan</span>          <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Index</span>         <span class="n">scanrelid</span><span class="p">;</span>         <span class="cm">/* relid 是范围表上的索引ID */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Scan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">IndexScan</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Scan</span>          <span class="n">scan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Oid</span>           <span class="n">indexid</span><span class="p">;</span>            <span class="cm">/* 待扫描的索引OID */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>          <span class="o">*</span><span class="n">indexqual</span><span class="p">;</span>         <span class="cm">/* 索引限定条件的列表 (通常是OpExprs) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>          <span class="o">*</span><span class="n">indexqualorig</span><span class="p">;</span>     <span class="cm">/* 同上，但使用原始形式 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>          <span class="o">*</span><span class="n">indexorderby</span><span class="p">;</span>      <span class="cm">/* 索引的ORDER BY表达式 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>          <span class="o">*</span><span class="n">indexorderbyorig</span><span class="p">;</span>  <span class="cm">/* 同上，但使用原始形式 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>          <span class="o">*</span><span class="n">indexorderbyops</span><span class="p">;</span>   <span class="cm">/* ORDER BY表达式用到的排序运算符的OID */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScanDirection</span> <span class="n">indexorderdir</span><span class="p">;</span>      <span class="cm">/* 正序扫描还是逆序扫描，或者根本不在乎 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">IndexScan</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h2>3.4 执行器如何工作<span class="hx-absolute -hx-mt-20" id="34-执行器如何工作"></span>
    <a href="#34-%e6%89%a7%e8%a1%8c%e5%99%a8%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>在单表查询的例子中，执行器从计划树中取出计划节点，按照自底向上的顺序进行处理，并调用节点相应的处理函数。</p>
<p>每个计划节点都有相应的函数，用于执行节点对应的操作。这些函数在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/" target="_blank" rel="noopener"><code>src/backend/executor</code></a>目录中。例如，执行顺序扫描的的函数（<code>SeqScan</code>）定义于<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c" target="_blank" rel="noopener"><code>nodeSeqscan.c</code></a>中；执行索引扫描的函数（<code>IndexScanNode</code>）定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c" target="_blank" rel="noopener"><code>nodeIndexScan.c</code></a>中；<code>SortNode</code>节点对应的排序函数定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c" target="_blank" rel="noopener"><code>nodeSort.c</code></a>中，诸如此类。</p>
<p>当然，理解执行器如何工作的最好方式，就是阅读<code>EXPLAIN</code>命令的输出。因为PostgreSQL的<code>EXPLAIN</code>命令几乎就是照着计划树输出的。下面以3.3.3节的例1为例。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=</span><span class="err">#</span> <span class="n">EXPLAIN</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">tbl_1</span> <span class="n">WHERE</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                          <span class="n">QUERY</span> <span class="n">PLAN</span>                           
</span></span><span class="line"><span class="cl"><span class="o">---------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"> <span class="nf">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mf">182.34</span><span class="p">.</span><span class="mf">.183.09</span> <span class="n">rows</span><span class="o">=</span><span class="mi">300</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">Sort</span> <span class="nl">Key</span><span class="p">:</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">   <span class="o">-&gt;</span>  <span class="n">Seq</span> <span class="n">Scan</span> <span class="n">on</span> <span class="nf">tbl_1</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mf">0.00</span><span class="p">.</span><span class="mf">.170.00</span> <span class="n">rows</span><span class="o">=</span><span class="mi">300</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nl">Filter</span><span class="p">:</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">4</span> <span class="n">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>我们可以自底向上阅读<code>EXPLAIN</code>的结果，来看一看执行器是如何工作的。</p>
<p><strong>第6行</strong>：首先，执行器通过<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSeqscan.c" target="_blank" rel="noopener"><code>nodeSeqscan.c</code></a>中定义的函数执行顺序扫描操作。</p>
<p><strong>第4行</strong>：然后，执行器通过<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c" target="_blank" rel="noopener"><code>nodeSort.c</code></a>中定义的函数，对顺序扫描的结果进行排序。</p>
<blockquote>
  <h3>临时文件<span class="hx-absolute -hx-mt-20" id="临时文件"></span>
    <a href="#%e4%b8%b4%e6%97%b6%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>执行器在处理查询时会使用工作内存（<code>work_mem</code>）和临时缓冲区（<code>temp_buffers</code>），两者都于内存中分配。如果查询无法在内存中完成，就会用到临时文件。</p>
<p>使用带有<code>Analyze</code>选项的<code>EXPLAIN</code>，待解释的命令会真正执行，并显示实际结果行数，实际执行时间和实际内存用量。下面是一个具体的例子：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=</span><span class="err">#</span> <span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> <span class="n">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">data</span> <span class="n">FROM</span> <span class="n">tbl_25m</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                          <span class="n">QUERY</span> <span class="n">PLAN</span>                                                        
</span></span><span class="line"><span class="cl"><span class="o">----------------------------------------------------------------------</span>
</span></span><span class="line"><span class="cl"> <span class="nf">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mf">3944070.01</span><span class="p">.</span><span class="mf">.3945895.01</span> <span class="n">rows</span><span class="o">=</span><span class="mi">730000</span> <span class="n">width</span><span class="o">=</span><span class="mi">4104</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mf">885.648</span><span class="p">.</span><span class="mf">.1033.746</span> <span class="n">rows</span><span class="o">=</span><span class="mi">730000</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">Sort</span> <span class="nl">Key</span><span class="p">:</span> <span class="n">id</span>
</span></span><span class="line"><span class="cl">   <span class="n">Sort</span> <span class="nl">Method</span><span class="p">:</span> <span class="n">external</span> <span class="n">sort</span>  <span class="nl">Disk</span><span class="p">:</span> <span class="mi">10000</span><span class="n">kB</span>
</span></span><span class="line"><span class="cl">   <span class="o">-&gt;</span>  <span class="n">Seq</span> <span class="n">Scan</span> <span class="n">on</span> <span class="nf">tbl_25m</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mf">0.00</span><span class="p">.</span><span class="mf">.10531.00</span> <span class="n">rows</span><span class="o">=</span><span class="mi">730000</span> <span class="n">width</span><span class="o">=</span><span class="mi">4104</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.024</span><span class="p">.</span><span class="mf">.102.548</span> <span class="n">rows</span><span class="o">=</span><span class="mi">730000</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="n">Planning</span> <span class="nl">time</span><span class="p">:</span> <span class="mf">1.548</span> <span class="n">ms</span>
</span></span><span class="line"><span class="cl"> <span class="n">Execution</span> <span class="nl">time</span><span class="p">:</span> <span class="mf">1109.571</span> <span class="nf">ms</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">6</span> <span class="n">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在第6行，<code>EXPLAIN</code>命令显示出执行器使用了10000KB的临时文件。</p>
<p>临时文件会被临时创建于<code>base/pg_tmp</code>子目录中，并遵循如下命名规则</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;pgsql_tmp&#34;</span><span class="o">}</span> + <span class="o">{</span>创建本文件的Postgres进程PID<span class="o">}</span> . <span class="o">{</span>从0开始的序列号<span class="o">}</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>比如，临时文件<code>pgsql_tmp8903.5</code>是<code>pid</code>为<code>8903</code>的<code>postgres</code>进程创建的第6个临时文件</p>
</blockquote>
<h2>3.5 连接<span class="hx-absolute -hx-mt-20" id="35-连接"></span>
    <a href="#35-%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	PostgreSQL 中支持三种**连接（JOIN）**操作：<strong>嵌套循环连接（Nested Loop Join）</strong>，<strong>归并连接（Merge Join）</strong> ，<strong>散列连接（Hash Join）</strong>。在PostgreSQL中，嵌套循环连接与归并连接有几种变体。</p>
<p>​	在下文中，我们会假设读者已经对这三种操作的基本行为有了解。如果读者对这些概念不熟悉，可以参阅[<a href="https://www.amazon.com/dp/0073523321" target="_blank" rel="noopener">1</a>, <a href="https://www.amazon.com/dp/0321523067" target="_blank" rel="noopener">2</a>]。PostgreSQL支持一种针对数据倾斜的<strong>混合散列连接（hybrid hash join）</strong>，关于这方面的资料不多，因此这里会详细描述该操作。</p>
<p>​	需要注意的是，这三种**连接方法（join method）**都支持PostgreSQL中所有的连接操作，诸如<code>INNER JOIN</code>，<code>LEFT/RIGHT OUTER JOIN</code>，<code>FULL OUTER JOIN</code>等；但是为了简单起见，这里只关注<code>NATURAL INNER JOIN</code>。</p>
<h3>3.5.1 嵌套循环连接（Nested Loop Join）<span class="hx-absolute -hx-mt-20" id="351-嵌套循环连接nested-loop-join"></span>
    <a href="#351-%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5nested-loop-join" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p><strong>嵌套循环连接</strong>是最为基础的连接操作，任何**连接条件（join condition）**都可以使用这种连接方式。PostgreSQL支持嵌套循环连接及其五种变体。</p>
<h4>3.5.1.1 嵌套循环连接<span class="hx-absolute -hx-mt-20" id="3511-嵌套循环连接"></span>
    <a href="#3511-%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>嵌套循环连接无需任何启动代价，因此：
</p>
$$
\verb|start-up_cost| = 0
$$<p>
运行代价与内外表尺寸的乘积成比例；即$\verb|runcost|$是$O(N_{\verb|outer|}× N_{\verb|inner|})$，这里$N_{\verb|outer|}$和$N_{\verb|inner|}$分别是外表和内表的元组条数。更准确的说，$\verb|run_cost|$的定义如下：
</p>
$$
\begin{equation}
\verb|run_cost|=(\verb|cpu_operator_cost|+ \verb|cpu_tuple_cost|)× N_{\verb|outer|}× N_{\verb|inner|} + C_{\verb|inner|}× N_{\verb|outer|}+C_{\verb|outer|}
\end{equation}
$$<p>
这里$C_{\verb|outer|}$和$C_{\verb|inner|}$分别是内表和外表顺序扫描的代价；</p>
<p><strong>图3.16 嵌套循环连接</strong></p>
<p><img src="/img/fig-3-16.png" alt="" loading="lazy" /></p>
<p>嵌套循环连接的代价总是会被估计，但实际中很少会使用这种连接操作，因为它有几种更高效的变体，下面将会讲到。</p>
<h4>3.5.1.2 物化嵌套循环连接<span class="hx-absolute -hx-mt-20" id="3512-物化嵌套循环连接"></span>
    <a href="#3512-%e7%89%a9%e5%8c%96%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>在上面描述的嵌套循环连接中，每当读取一条外表中的元组时，都需要扫描内表中的所有元组。为每条外表元组对内表做全表扫描，这一过程代价高昂，PostgreSQL支持一种<strong>物化嵌套循环连接（materialized nested loop join）</strong> ，可以减少内表全表扫描的代价。</p>
<p>在运行嵌套循环连接之前，执行器会使用**临时元组存储（temporary tuple storage）**模块对内表进行一次扫描，将内表元组加载到工作内存或临时文件中。在处理内表元组时，临时元组存储比缓冲区管理器更为高效，特别是当所有的元组都能放入工作内存中时。</p>
<p>图 3.17说明了物化嵌套循环连接的处理过程。扫描物化元组在内部被称为<strong>重扫描（rescan）</strong>。</p>
<p><strong>图3.17 物化嵌套循环连接</strong></p>
<p><img src="/img/fig-3-17.png" alt="" loading="lazy" /></p>
<blockquote>
  <h4>临时元组存储<span class="hx-absolute -hx-mt-20" id="临时元组存储"></span>
    <a href="#%e4%b8%b4%e6%97%b6%e5%85%83%e7%bb%84%e5%ad%98%e5%82%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>PostgreSQL内部提供了临时元组存储的模块，可用于各种操作：物化表，创建混合散列连接的批次，等等。该模块包含一系列函数，都在<a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/sort/tuplestore.c" target="_blank" rel="noopener"><code>tuplestore.c</code></a>中。这些函数用于从工作内存或临时文件读写元组。使用工作内存还是临时文件取决于待存储元组的总数。</p>
</blockquote>
<p>下面给出一个具体的例子，并研究一下执行器是如何处理物化嵌套循环连接的计划树并估计其代价的。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                              </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                               
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-----------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="n">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">750230</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">Join</span><span class="w"> </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">145</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Materialize</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">98</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">73</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>上面显示了执行器要进行的操作，执行器对这些计划节点的处理过程如下：</p>
<p>第7行：执行器使用顺序扫描，物化内部表<code>tbl_b</code>。</p>
<p>第4行：执行器执行嵌套循环连接操作，外表是<code>tbl_a</code>，内表是物化的<code>tbl_b</code>。</p>
<p>下面来估算“物化”操作（第7行）与“嵌套循环”（第4行）的代价。假设物化的内部表元组都在工作内存中。</p>
<p><strong>物化（Materialize）</strong>:</p>
<p>物化操作没有启动代价；因此，
</p>
$$
\begin{equation}
      \verb|start-up_cost| = 0
\end{equation}
$$<p>
其运行代价定义如下：
</p>
$$
\verb|run_cost| = 2 × \verb|cpu_operator_cost| × N_{\verb|inner|};
$$<p>
因此：
</p>
$$
\verb|run_cost|=2× 0.0025× 5000=25.0
$$<p>
此外，
</p>
$$
\verb|total_cost| = (\verb|start-up_cost|+ \verb|total_cost_of_seq_scan|)+ \verb|run_cost|
$$<p>
因此，
</p>
$$
\verb|total_cost| = (0.0+73.0)+25.0=98.0
$$<p>
<strong>(物化)嵌套循环</strong>:</p>
<p>嵌套循环没有启动代价，因此：
</p>
$$
\verb|start-up_cost|=0
$$<p>
在估计运行代价之前，先来看一下重扫描的代价，重扫描的代价定义如下：
</p>
$$
\verb|rescan_cost| = \verb|cpu_operator_cost| × N_{\verb|inner|}
$$<p>
这本例中：
</p>
$$
\verb|rescan_cost| = (0.0025)× 5000=12.5
$$<p>
运行代价由以下公式定义：
$$
\verb|run_cost| =(\verb|cpu_operator_cost| + \verb|cpu_tuple_cost|)× N_{\verb|inner|}× N_{\verb|outer|} \</p>
<ul>
<li>\verb|recan_cost|× (N_{\verb|outer|}-1) + C^{\verb|total|}<em>{\verb|outer|,\verb|seqscan|} + C^{\verb|total|}</em>{\verb|materialize|}，
$$
这里 $C^{\verb|total|}_{\verb|outer|,\verb|seqscan|}$代表外部表的全部扫描代价，$C^{\verb|total|}_{\verb|materialize|}$代表物化代价；因此
$$
\verb|run_cost| = ( 0.0025 + 0.01 ) × 5000 × 10000 + 12.5 ×(10000−1)+145.0+98.0=750230.5
$$</li>
</ul>
<h4>3.5.1.3 索引嵌套循环连接<span class="hx-absolute -hx-mt-20" id="3513-索引嵌套循环连接"></span>
    <a href="#3513-%e7%b4%a2%e5%bc%95%e5%b5%8c%e5%a5%97%e5%be%aa%e7%8e%af%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>如果内表上有索引，且该索引能用于搜索满足连接条件的元组。那么计划器在为外表的每条元组搜索内表中的匹配元组时，会考虑使用索引进行直接搜索，以替代顺序扫描。这种变体叫做<strong>索引嵌套循环连接（indexed nested loop join）</strong>，如图3.18所示。尽管这种变体叫做索引&quot;嵌套循环连接&quot;，但该算法基本上只需要在在外表上循环一次，因此连接操作执行起来相当高效。</p>
<p><strong>图3.18 索引嵌套循环连接</strong></p>
<p><img src="/img/fig-3-18.png" alt="" loading="lazy" /></p>
<p>下面是索引嵌套循环连接的一个具体例子。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="n">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">1935</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">73</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">36</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>第6行展示了访问内表中元组的代价。即在内表中查找满足第七行连接条件<code>(id = b.id)</code>的元组的代价。</p>
<p>在第7行的索引条件<code>(id = b.id)</code>中，<code>b.id</code>是连接条件中的外表属性的值。每当顺序扫描外表取回一条元组时，就会依第6行所示的索引搜索路径，查找内表中需要与之连接的元组。换而言之，外表元组的值作为参数传入内表的索引扫描中，索引扫描路径会查找满足连接条件的内表元组。这种索引路径被称为<strong>参数化（索引）路径（parameterized (index) path）</strong>，细节见PostgreSQ源码：<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/README" target="_blank" rel="noopener"><code>backend/optimizer/README</code></a>。</p>
<p>该嵌套循环连接的启动代价，等于第6行中索引扫描的代价，因此：
</p>
$$
\verb|start-up_cost| = 0.285
$$<p>
索引嵌套循环扫描的总代价由下列公式所定义：
</p>
$$
\verb|total_cost|= (\verb|cpu_tuple_cost| + C^{\verb|total|}_{\verb|inner,parameterized|} )× N_{\verb|outer|}+C^{\verb|run|}_{\verb|outer,seqscan|}
$$<p>
这里$C^{\verb|total|}_{\verb|inner,parameterized|}$是参数化内表索引扫描的整体代价，</p>
<p>在本例中：
</p>
$$
\verb|total_cost|=(0.01+0.3625)× 5000 + 73.0 = 1935.5
$$<p>
而运行代价为：
</p>
$$
\verb|run_cost| = 1935.5-0.285=1935.215
$$<p>
如上所示，索引嵌套扫描的整体代价是$O(N_{\verb|outer|})$。</p>
<h4>3.5.1.4 其他变体<span class="hx-absolute -hx-mt-20" id="3514-其他变体"></span>
    <a href="#3514-%e5%85%b6%e4%bb%96%e5%8f%98%e4%bd%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>如果在外表上存在一个与连接条件相关的索引，那么在外表上也可以以索引扫描替代顺序扫描。特别是，当<code>WHERE</code>子句中的访问谓词可以使用该索引时，能缩小外表上的搜索范围，嵌套循环连接的代价可能会急剧减少。</p>
<p>当使用外表索引扫描时，PostgreSQL支持三种嵌套循环连接的变体，如图3.19所示。</p>
<p><strong>图3.19 嵌套循环连接的三种变体，使用外表索引扫描</strong></p>
<p><img src="/img/fig-3-19.png" alt="out" loading="lazy" /></p>
<p>这些连接的<code>EXPLAIN</code>结果如下：</p>
<ol>
<li>
<p>使用外表索引扫描的嵌套循环连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_mergejoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="n">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">93</span><span class="p">.</span><span class="mi">81</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">30</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用外表索引扫描的物化嵌套循环连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_mergejoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="n">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">99</span><span class="p">.</span><span class="mi">76</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">Join</span><span class="w"> </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">97</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">39</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Materialize</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">55</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">9</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">9</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用外表索引扫描的索引嵌套循环连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_mergejoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_d</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w">  </span><span class="mi">40</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                   </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Nested</span><span class="w"> </span><span class="n">Loop</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">57</span><span class="p">..</span><span class="mi">173</span><span class="p">.</span><span class="mi">06</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">20</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_a_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">97</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">39</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_d_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_d</span><span class="w"> </span><span class="n">d</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">..</span><span class="mi">4</span><span class="p">.</span><span class="mi">20</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h3>3.5.2 归并连接（Merge Join）<span class="hx-absolute -hx-mt-20" id="352-归并连接merge-join"></span>
    <a href="#352-%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5merge-join" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>与嵌套循环连接不同的是，**归并连接（Merge Join）**只能用于自然连接与等值连接。</p>
<p>函数<code>initial_cost_mergejoin()</code>和<code>final_cost_mergejoin()</code>用于估计归并连接的代价。</p>
<p>因为精确估计归并连接的代价非常复杂，因此这里略过不提，只会说明归并连接算法的工作流程。归并连接的启动成本是内表与外表排序成本之和，因此其启动成本为：
</p>
$$
O(N_{\verb|outer|} \log_2(N_{\verb|outer|}) + N_{\verb|inner|} \log_2(N_{\verb|inner|}))
$$<p>
这里$N_{\verb|outer|}$和$N_{\verb|inner|}$是分别是外表和内表的元组条数，而运行代价是$O(N_{\verb|outer|}+N_{\verb|inner|})$。</p>
<p>与嵌套循环连接类似，归并连接在PostgreSQL中有4种变体。</p>
<h4>3.5.2.1 归并连接<span class="hx-absolute -hx-mt-20" id="3521-归并连接"></span>
    <a href="#3521-%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>图3.20是归并连接的概念示意图。</p>
<p><strong>图3.20 归并连接</strong></p>
<p><img src="/img/fig-3-20.png" alt="" loading="lazy" /></p>
<p>如果所有元组都可以存储在内存中，那么排序操作就能在内存中进行，否则会使用临时文件。</p>
<p>下面是一个具体的例子，一个归并连接的<code>EXPLAIN</code>输出如下所示。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                               </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Merge</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">944</span><span class="p">.</span><span class="mi">71</span><span class="p">..</span><span class="mi">984</span><span class="p">.</span><span class="mi">71</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Merge</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">809</span><span class="p">.</span><span class="mi">39</span><span class="p">..</span><span class="mi">834</span><span class="p">.</span><span class="mi">39</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">145</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">135</span><span class="p">.</span><span class="mi">33</span><span class="p">..</span><span class="mi">137</span><span class="p">.</span><span class="mi">83</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>第9行：执行器对内表<code>tbl_b</code>进行排序，使用顺序扫描（第11行）。</li>
<li>第6行：执行器对外表<code>tbl_a</code>进行排序，使用顺序扫描（第8行）。</li>
<li>第4行：执行器执行归并连接操作，外表是排好序的<code>tbl_a</code>，内表是排好序的<code>tbl_b</code>。</li>
</ul>
<h4>3.5.2.2 物化归并连接<span class="hx-absolute -hx-mt-20" id="3522-物化归并连接"></span>
    <a href="#3522-%e7%89%a9%e5%8c%96%e5%bd%92%e5%b9%b6%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>与嵌套循环连接类似，归并连接还支持<strong>物化归并连接（Materialized Merge Join）</strong>，物化内表，使内表扫描更为高效。</p>
<p><strong>图3.21 物化归并连接</strong></p>
<p><img src="/img/fig-3-21.png" alt="" loading="lazy" /></p>
<p>这里是物化归并连接的<code>EXPLAIN</code>结果，很容易发现，与普通归并连接的差异是第9行：<code>Materialize</code>。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                     
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Merge</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">10466</span><span class="p">.</span><span class="mi">08</span><span class="p">..</span><span class="mi">10578</span><span class="p">.</span><span class="mi">58</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">2064</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Merge</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">6708</span><span class="p">.</span><span class="mi">39</span><span class="p">..</span><span class="mi">6733</span><span class="p">.</span><span class="mi">39</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">1032</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="n">a</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">1529</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">1032</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Materialize</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">3757</span><span class="p">.</span><span class="mi">69</span><span class="p">..</span><span class="mi">3782</span><span class="p">.</span><span class="mi">69</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">1032</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">3757</span><span class="p">.</span><span class="mi">69</span><span class="p">..</span><span class="mi">3770</span><span class="p">.</span><span class="mi">19</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">1032</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">1193</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">5000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">1032</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>第10行：执行器对内表<code>tbl_b</code>进行排序，使用顺序扫描（第12行）。</li>
<li>第9行：执行器对<code>tbl_b</code>排好序的结果进行物化。</li>
<li>第6行：执行器对外表<code>tbl_a</code>进行排序，使用顺序扫描（第8行）。</li>
<li>第4行：执行器执行归并连接操作，外表是排好序的<code>tbl_a</code>，内表是物化的排好序的<code>tbl_b</code>。</li>
</ul>
<h4>3.5.2.3 其他变体<span class="hx-absolute -hx-mt-20" id="3523-其他变体"></span>
    <a href="#3523-%e5%85%b6%e4%bb%96%e5%8f%98%e4%bd%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>与嵌套循环连接类似，当外表上可以进行索引扫描时，归并连接也存在相应的变体。</p>
<p><strong>图3.22 归并连接的三种变体，使用外表索引扫描</strong></p>
<p><img src="/img/fig-3-22.png" alt="" loading="lazy" /></p>
<p>这些连接的<code>EXPLAIN</code>结果如下。</p>
<ol>
<li>
<p>使用外表索引扫描的归并连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_nestloop</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                      </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                      
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Merge</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">135</span><span class="p">.</span><span class="mi">61</span><span class="p">..</span><span class="mi">322</span><span class="p">.</span><span class="mi">11</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Merge</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">318</span><span class="p">.</span><span class="mi">29</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">135</span><span class="p">.</span><span class="mi">33</span><span class="p">..</span><span class="mi">137</span><span class="p">.</span><span class="mi">83</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">7</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用外表索引扫描的物化归并连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_nestloop</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4500</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                      </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                      
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Merge</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">421</span><span class="p">.</span><span class="mi">84</span><span class="p">..</span><span class="mi">672</span><span class="p">.</span><span class="mi">09</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">4500</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Merge</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">318</span><span class="p">.</span><span class="mi">29</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Materialize</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">421</span><span class="p">.</span><span class="mi">55</span><span class="p">..</span><span class="mi">444</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">4500</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Sort</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">421</span><span class="p">.</span><span class="mi">55</span><span class="p">..</span><span class="mi">432</span><span class="p">.</span><span class="mi">80</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">4500</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Sort</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">4500</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用外表索引扫描的索引归并连接</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_hashjoin</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">enable_nestloop</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_d</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                      </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                                      
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Merge</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">57</span><span class="p">..</span><span class="mi">226</span><span class="p">.</span><span class="mi">07</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Merge</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_c_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="p">..</span><span class="mi">318</span><span class="p">.</span><span class="mi">29</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Index</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">tbl_d_pkey</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_d</span><span class="w"> </span><span class="n">d</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">..</span><span class="mi">41</span><span class="p">.</span><span class="mi">78</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">Index</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h3>3.5.3 散列连接（Hash Join）<span class="hx-absolute -hx-mt-20" id="353-散列连接hash-join"></span>
    <a href="#353-%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5hash-join" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>与归并连接类似，**散列连接（Hash Join）**只能用于自然连接与等值连接。</p>
<p>PostgreSQL中的散列连接的行为因表的大小而异。 如果目标表足够小（确切地讲，内表大小不超过工作内存的25％），那么散列连接就是简单的<strong>两阶段内存散列连接（two-phase in-memory hash join）</strong> ； 否则，将会使用带倾斜批次的<strong>混合散列连接（hybrid hash join）</strong>。</p>
<p>本小节将介绍PostgreSQL中这两种散列连接的执行过程。</p>
<p>这里省略了代价估算的部分，因为它很复杂。粗略来说，假设向散列表插入与搜索时没有遇到冲突，那么启动和运行成本复杂度都是$O(N_{\verb|outer|} + N_{\verb|inner|})$。</p>
<h4>3.5.3.1 内存散列连接<span class="hx-absolute -hx-mt-20" id="3531-内存散列连接"></span>
    <a href="#3531-%e5%86%85%e5%ad%98%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>下面将描述内存中的散列连接。</p>
<p>内存中的散列连接是在<code>work_mem</code>中处理的，在PostgreSQL中，散列表区域被称作<strong>处理批次（batch）</strong>。 一个处理批次会有多个<strong>散列槽(hash slots)</strong>，内部称其为<strong>桶（buckets）</strong>，桶的数量由<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeHash.c" target="_blank" rel="noopener"><code>nodeHash.c</code></a>中定义的<code>ExecChooseHashTableSize()</code>函数所确定。 桶的数量总是2的整数次幂。</p>
<p>内存散列连接有两个阶段：**构建（build）<strong>阶段和</strong>探测（probe）**阶段。 在构建阶段，内表中的所有元组都会被插入到batch中；在探测阶段，每条外表元组都会与处理批次中的内表元组比较，如果满足连接条件，则将两条元组连接起来。</p>
<p>为了理解该操作的过程，下面是一个具体的例子。 假设该查询中的连接操作使用散列连接。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_outer</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">outer</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_inner</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">inner</span><span class="p">.</span><span class="n">attr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">outer</span><span class="p">.</span><span class="n">attr2</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>散列连接的过程如图3.23和3.24所示。</p>
<p><strong>图3.23 内存散列连接的构建阶段</strong></p>
<p><img src="/img/fig-3-23.png" alt="" loading="lazy" /></p>
<ol>
<li>
<p>在工作内存上创建一个处理批次。</p>
<p>在本例中，处理批次有八个桶；即桶的数量是2的3次方。</p>
</li>
<li>
<p>将内表的第一个元组插入批次的相应的桶中。</p>
<p>具体过程如下：</p>
<ol>
<li>
<p>找出元组中涉及连接条件的属性，计算其散列键。</p>
<p>在本例中，因为<code>WHERE</code>子句是<code>inner.attr1 = outer.attr2</code>，因此内置的散列函数会对第一条元组的属性<code>attr1</code>取散列值，用作散列键。</p>
</li>
<li>
<p>将第一条元组插入散列键相应的桶中。</p>
<p>假设第一条元组的散列键以二进制记法表示为<code>0x000 ... 001</code>，即其末三**位（bit）**为<code>001</code>。 在这种情况下，该元组会被插入到键为<code>001</code>的桶中。</p>
</li>
</ol>
<p>在本文中，构建处理批次的插入操作会用运算符 ⊕ 表示。</p>
</li>
<li>
<p>插入内表中的其余元组。</p>
</li>
</ol>
<p><strong>图3.24. 内存散列连接的探测阶段</strong></p>
<p><img src="/img/fig-3-24.png" alt="" loading="lazy" /></p>
<ol start="4">
<li>
<p>依外表的第一条元组进行探测。</p>
<p>详情如下：</p>
<ol>
<li>
<p>找出第一条外表元组中涉及连接条件的属性，计算其散列键。</p>
<p>在这个例子中，假设第一条元组的属性<code>attr2</code>的散列键是<code>0x000 ... 100</code>，即其末三**位（bit）**为<code>100</code>。 最后三位是<code>100</code>。</p>
</li>
<li>
<p>将外表中第一条元组与批次中的内表元组进行比较。如果满足连接条件，则连接内外表元组。</p>
<p>因为第一个元组的散列键的末三位为<code>100</code>，执行器找出键为<code>100</code>的桶中的所有内表元组，并对内外表元组两侧相应的属性进行比较。这些属性由连接条件（在<code>WHERE</code>子句中）所指明。</p>
<p>如果满足连接条件，执行器会连接外表中的第一条元组与内表中的相应元组。如果不满足则执行器不做任何事情。</p>
<p>在本例中，键为<code>100</code>的桶中有<code>Tuple_C</code>。如果<code>Tuple_C</code>的<code>attr1</code>等于第一条元组（<code>Tuple_W</code>）的<code>attr2</code>，则<code>Tuple_C</code>和<code>Tuple_W</code>将被连接，并保存至内存或临时文件中。</p>
</li>
</ol>
<p>在本文中，处理批次的探测操作用运算符 ⊗ 表示。</p>
</li>
<li>
<p>依次对外表中的其他元组执行探测。</p>
</li>
</ol>
<h4>3.5.3.2 带倾斜的混合散列连接<span class="hx-absolute -hx-mt-20" id="3532-带倾斜的混合散列连接"></span>
    <a href="#3532-%e5%b8%a6%e5%80%be%e6%96%9c%e7%9a%84%e6%b7%b7%e5%90%88%e6%95%a3%e5%88%97%e8%bf%9e%e6%8e%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>当内表的元组无法全部存储在工作内存中的单个处理批次时，PostgreSQL使用带倾斜批次的混合散列连接算法，该算法是混合散列连接的一种变体。</p>
<p>首先，这里会描述混合散列连接的基本概念。在第一个构建和探测阶段，PostgreSQL准备多个批次。与桶的数目类似，处理批次的数目由函数<code>ExecChooseHashTableSize()</code>决定，也总是2的整数次幂。工作内存中只会分配一个处理批次，而其他批次作都以临时文件的形式创建。属于这些批次的元组将通过临时元组存储功能，被写入到相应的文件中。</p>
<p>图3.25说明了如何将元组存储在四个（$ 2 ^ 2 $）处理批次中。在本例中元组散列键的最后五个比特位决定了元组所属的批次与桶，因为处理批次的数量为$2^2$，而桶的数量为$2^3$，因此需要5个比特位来表示，其中前两位决定了元组所属的批次，而后三位决定了元组在该批次中所属的桶。例如：<code>Batch_0</code>存储着散列键介于$\textcolor{red}{00}000$与$\textcolor{red}{00}111$的元组；而<code>Batch_1</code>存储着散列键介于$\textcolor{red}{01}000$与$\textcolor{red}{01}111$的元组，依此类推。</p>
<p><strong>图3.25 混合散列连接中的多个处理批次</strong></p>
<p><img src="/img/fig-3-25.png" alt="" loading="lazy" /></p>
<p>在混合散列连接中，构建与探测阶段的执行次数与处理批次的数目相同，因为内外表元组都被存至相同数量的处理批次中。在第一轮构建与探测阶段中，除了处理第一个处理批次，还会创建所有的处理批次。另一方面，第二轮及后续的处理批次都需要读写临时文件，这属于代价巨大的操作。因此PostgreSQL还准备了一个名为<strong>skew</strong>的特殊处理批次，即倾斜批次，以便在第一轮中高效处理尽可能多的元组。</p>
<p>这个特殊的倾斜批次中的内表元组在连接条件内表一侧属性上的取值，会选用外表连接属性上的高频值（MCV）。因此在第一轮处理中能与外表中尽可能多的元组相连接。这种解释不太好理解，因此下面给出了一个具体的例子。</p>
<p>假设有两个表：客户表<code>customers</code>与购买历史表<code>purchase_history</code>。<code>customers</code>由两个属性组成：<code>name</code>和<code>address</code>； <code>purchase_history</code>由两个属性组成：<code>customer_name</code>和<code>buying_item</code>。<code>customers</code>有10,000行，而<code>purchase_history</code>表有1,000,000行。前10％的客户进行了70％的购买。</p>
<p>理解了这些假设，让我们考虑当执行以下查询时，带倾斜的混合散列连接的第一轮是如何执行的。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_history</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">h</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">.</span><span class="n">customer_name</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如果<code>customers</code>是内表，而<code>purchase_history</code>是外表，则PostgreSQL将使用<code>purchase_history</code>表的高频值值，将前10％的<code>customers</code>元组存储于倾斜批次中。 请注意这里引用的是外表上的高频值，而插入倾斜批次的是内表元组。 在第一轮的探测阶段，外表（<code>purchase_history</code>）中70％的元组将与倾斜批次中存储的元组相连接。 因此，外表分布越是不均匀，第一轮中越是可以处理尽可能多的元组。</p>
<p>接下来会介绍带倾斜批次的混合散列连接的工作原理，如图3.26至3.29所示。</p>
<p><strong>图3.26 混合散列连接的构建阶段的第一轮</strong></p>
<p><img src="/img/fig-3-26.png" alt="" loading="lazy" /></p>
<ol>
<li>
<p>在工作内存中创建一个处理批次，以及一个倾斜批次。</p>
</li>
<li>
<p>创建处理批次相应的临时文件，用于存储排好序的内表元组。</p>
<p>在本例中，内表被分割为四个批次，因此创建了三个批次文件。</p>
</li>
<li>
<p>为内表的第一条元组执行构建操作。</p>
<p>细节如下：</p>
<ol>
<li>
<p>如果第一条元组应当插入倾斜批次中，则将其插入倾斜批次；否则继续下一步。</p>
<p>在该例中，如果第一条元组属于前10％的客户，则将其插入到倾斜批次中。</p>
</li>
<li>
<p>计算第一条元组的散列键，然后将其插入相应的处理批次。</p>
</li>
</ol>
</li>
<li>
<p>对内表其余元组依次执行构建操作。</p>
</li>
</ol>
<p><strong>图3.27 混合散列连接，探测阶段第一轮</strong></p>
<p><img src="/img/fig-3-27.png" alt="" loading="lazy" /></p>
<ol start="5">
<li>
<p>创建临时处理批次文件，用于外表排序。</p>
</li>
<li>
<p>为外表的第一条元组执行探测操作，如果外表第一条元组上相应字段取值为MCV，则在倾斜批次上进行探测，否则进行第七步。</p>
<p>在本例中，如果第一条元组是前10％客户的购买数据，则它会与倾斜批次中的内表元组进行比较。</p>
</li>
<li>
<p>为外表的第一条元组执行探测操作。</p>
<p>操作的内容取决于该元组散列键的取值。如果该元组属于<code>Batch_0</code>则直接完成探测操作；否则将其插入相应的外表处理批次中。</p>
</li>
<li>
<p>为外表的其余元组执行探测操作。</p>
<p>注意在本例中，外表中70％的元组已经在第一轮中的倾斜批次中处理了。</p>
</li>
</ol>
<p><strong>图3.28 构建阶段与探测阶段，第二轮</strong></p>
<p><img src="/img/fig-3-28.png" alt="" loading="lazy" /></p>
<ol start="9">
<li>
<p>移除倾斜批次与<code>Batch_0</code>，为下一轮处理批次腾地方。</p>
</li>
<li>
<p>为批次文件<code>batch_1_in</code>中的内表元组执行构建操作。</p>
</li>
<li>
<p>为批次文件<code>batch_1_out</code>中的外表元组依次执行探测操作。</p>
</li>
</ol>
<p><strong>图3.29 构建阶段与探测阶段，第三轮及后续</strong></p>
<p><img src="/img/fig-3-29.png" alt="" loading="lazy" /></p>
<ol start="12">
<li>
<p>为批次文件<code>batch_2_in</code>与<code>batch_2_out</code>执行构建操作与探测操作。</p>
</li>
<li>
<p>为批次文件<code>batch_3_in</code>与<code>batch_3_out</code>执行构建操作与探测操作。</p>
</li>
</ol>
<h3>3.5.4 连接访问路径与连接节点<span class="hx-absolute -hx-mt-20" id="354-连接访问路径与连接节点"></span>
    <a href="#354-%e8%bf%9e%e6%8e%a5%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84%e4%b8%8e%e8%bf%9e%e6%8e%a5%e8%8a%82%e7%82%b9" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h4>3.5.4.1 连接访问路径<span class="hx-absolute -hx-mt-20" id="3541-连接访问路径"></span>
    <a href="#3541-%e8%bf%9e%e6%8e%a5%e8%ae%bf%e9%97%ae%e8%b7%af%e5%be%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>嵌套循环连接的访问路径由<code>JoinPath</code>结构表示，其他连接访问路径，诸如<code>MergePath</code>与<code>HashPath</code>都基于其实现。</p>
<p>下图列出了所有的连接访问路径，细节略过不提。</p>
<p><strong>图3.30 Join访问路径</strong></p>
<p><img src="/img/fig-3-30.png" alt="" loading="lazy" /></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">JoinPath</span> <span class="n">NestPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="n">JoinType</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 根据SQL JOIN语法确定的标准连接种类，解析器只允许输出这几种取值。
</span></span></span><span class="line"><span class="cl"><span class="cm">         * (例如JoinExpr节点) */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_INNER</span><span class="p">,</span>           <span class="cm">/* 仅包含匹配的元组对 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_LEFT</span><span class="p">,</span>            <span class="cm">/* 匹配元组对 + 未匹配的左表元组 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_FULL</span><span class="p">,</span>            <span class="cm">/* 匹配元组对 + 未匹配的左右表元组  */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_RIGHT</span><span class="p">,</span>           <span class="cm">/* 匹配元组对 + 未匹配的右表元组  */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 关系理论中的半连接(semijoin)与否定半连接(anti-semijoin)并没有用SQL JOIN
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 语法来表示，而是用另一种风格标准来表示(举个例子，EXISTS)。计划器会认出这些情景
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 并将其转换为连接。因此计划器与执行器必须支持这几种取值。注意：对于JOIN_SEMI的
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 输出而言，连接到哪一条右表元组是不确定的。而对于JOIN_ANTI的输出而言，会保证使用
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 空值进行行扩展。*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_SEMI</span><span class="p">,</span>            <span class="cm">/* 左表元组的一份拷贝，如果该元组有相应匹配 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_ANTI</span><span class="p">,</span>            <span class="cm">/* 右表元组的一份拷贝，如果该元组有相应匹配 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 这几种代码用于计划器内部，执行器并不支持。(其实大多数时候计划器也不会用)   */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_UNIQUE_OUTER</span><span class="p">,</span>    <span class="cm">/* 左表路径必须是UNIQUE的 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">JOIN_UNIQUE_INNER</span>     <span class="cm">/* 右表路径必须是UNIQUE的 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">JoinType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">JoinPath</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Path</span>	   <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinType</span>   <span class="n">jointype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Path</span>	   <span class="o">*</span><span class="n">outerjoinpath</span><span class="p">;</span>		<span class="cm">/* 连接外表一侧的路径 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">Path</span>	   <span class="o">*</span><span class="n">innerjoinpath</span><span class="p">;</span>		<span class="cm">/* 连接内表一侧的路径 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">joinrestrictinfo</span><span class="p">;</span>	<span class="cm">/* 连接所适用的限制信息 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 参考RelOptInfo与ParamPathInfo才能理解为什么JoinPath需要有joinrestrictinfo
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 且不能合并到RelOptInfo中。 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">JoinPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">MergePath</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinPath</span>   <span class="n">jpath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">path_mergeclauses</span><span class="p">;</span>	<span class="cm">/* 归并所需的连接子句 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">outersortkeys</span><span class="p">;</span>		<span class="cm">/* 用于外表显式排序的键，如果存在 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">List</span>	   <span class="o">*</span><span class="n">innersortkeys</span><span class="p">;</span>		<span class="cm">/* 用于内表显式排序的键，如果存在 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>	   <span class="n">materialize_inner</span><span class="p">;</span>	<span class="cm">/* 为内表执行物化过程? */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">MergePath</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h4>3.5.4.2 连接节点<span class="hx-absolute -hx-mt-20" id="3542-连接节点"></span>
    <a href="#3542-%e8%bf%9e%e6%8e%a5%e8%8a%82%e7%82%b9" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>本小节列出了三种连接节点：<code>NestedLoopNode</code>，<code>MergeJoinNode</code> 和<code>HashJoinNode</code>，它们都基于<code>JoinNode</code>实现，细节略过不提。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *        连接节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * jointype:    连接左右子树元组的规则
</span></span></span><span class="line"><span class="cl"><span class="cm"> * joinqual:    来自 JOIN/ON 或 JOIN/USING 的连接限定条件
</span></span></span><span class="line"><span class="cl"><span class="cm"> *                (plan.qual 包含了来自WHERE子句的条件)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 当jointype为INNER时，joinqual 与 plan.qual 在语义上可以互换。对于OUTER而言这两者
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 则无法互换；只有joinqual会被用于匹配判定，以及是否需要生成空值扩展的元组。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (但 plan.qual 仍然会在实际返回一条元组前生效。)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 对于外连接而言，只有joinquals能被用于归并连接或散列连接的连接条件。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Join</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Plan</span>        <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">JoinType</span>    <span class="n">jointype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>        <span class="o">*</span><span class="n">joinqual</span><span class="p">;</span>    <span class="cm">/* 连接条件 (除 plan.qual 外) */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Join</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *        嵌套循环连接节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * nestParams的列表标识出了执行器所需的参数，这些参数从外表子计划中的当前行获取，
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 并传入内表子计划中用于执行。当前我们限制这些值为简单的Vars，但也许某一天这一限制
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 会放松。（注意在创建执行计划期间，paramval实际上可能是一个PlaceHolderVar表达式；
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 但当其进入执行器时，它必须转换为varno为OUTER_VAR的Var。）
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ----------------*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">NestLoop</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Join</span>       <span class="n">join</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>       <span class="o">*</span><span class="n">nestParams</span><span class="p">;</span>   <span class="cm">/* NestLoopParam 节点的列表*/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">NestLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">NestLoopParam</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeTag</span>   <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>       <span class="n">paramno</span><span class="p">;</span>        <span class="cm">/* 需要配置的PARAM_EXEC参数数量 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span>       <span class="o">*</span><span class="n">paramval</span><span class="p">;</span>      <span class="cm">/* 需要赋值给Param的外表变量 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">NestLoopParam</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *        归并连接节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 待归并列上期待的顺序是通过一个btree运算符族的OID，一个排序规则的OID，一个方向字段
</span></span></span><span class="line"><span class="cl"><span class="cm"> * （BTLessStrategyNumber 或 * BTGreaterStrategyNumber)，以及一个 NULL FIRST
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 标记位描述的。注意归并语句的两侧可能是不同的数据类型，但它们会按照共同的运算符族与排序
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 规则，以同样的方式排序。每个归并子句中的算子必须为相应运算符族中的等值运算。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ---------------- */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">MergeJoin</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Join</span>    <span class="n">join</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>    <span class="o">*</span><span class="n">mergeclauses</span><span class="p">;</span>        <span class="cm">/* mergeclauses 是一颗表达式树 */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 这些字段都是数组，但与mergeclauses列表有着同样的长度： */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Oid</span>     <span class="o">*</span><span class="n">mergeFamilies</span><span class="p">;</span>      <span class="cm">/* B树运算符族的OID列表，每条子句一个 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Oid</span>     <span class="o">*</span><span class="n">mergeCollations</span><span class="p">;</span>    <span class="cm">/* 排序规则的OID列表，每条子句一个 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>     <span class="o">*</span><span class="n">mergeStrategies</span><span class="p">;</span>    <span class="cm">/* 顺序(ASC 或 DESC)的列表，每条子句一个 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>    <span class="o">*</span><span class="n">mergeNullsFirst</span><span class="p">;</span>    <span class="cm">/* 空值顺序，每条子句一个  */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">MergeJoin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ----------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *        散列连接节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ---------------- */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">HashJoin</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Join</span>    <span class="n">join</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span>    <span class="o">*</span><span class="n">hashclauses</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">HashJoin</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h2>3.6 创建多表查询计划树<span class="hx-absolute -hx-mt-20" id="36-创建多表查询计划树"></span>
    <a href="#36-%e5%88%9b%e5%bb%ba%e5%a4%9a%e8%a1%a8%e6%9f%a5%e8%af%a2%e8%ae%a1%e5%88%92%e6%a0%91" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>本节将说明多表查询计划树的创建过程。</p>
<h3>3.6.1 预处理<span class="hx-absolute -hx-mt-20" id="361-预处理"></span>
    <a href="#361-%e9%a2%84%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>预处理由<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c" target="_blank" rel="noopener"><code>planner.c</code></a>中定义的<code>subquery_planner()</code>函数执行。第3.3.1节已经描述了单表查询的预处理。本节将描述多表查询的预处理；尽管这块内容很多，但这里只会挑其中一部分来讲。</p>
<ol>
<li>
<p>对CTE进行计划与转换</p>
<p>如果存在<code>WITH</code>列表，计划器就会通过<code>SS_process_ctes()</code>函数对每个<code>WITH</code>查询进行处理。</p>
</li>
<li>
<p>上拉子查询</p>
<p>如果<code>FROM</code>子句带有一个子查询，且该子查询没用用到<code>GROUP BY</code>，<code>HAVING</code>，<code>ORDER BY</code>，<code>LIMIT</code>和<code>DISTINCT</code>，<code>INTERSECT</code>或<code>EXCEPT</code>，那么计划器会使用<code>pull_up_subqueries()</code>函数将其转换为连接形式。例如下面一个<code>FROM</code>子句含子查询的查询就可以被转换为自然连接查询。自不必说，这种转换是在查询树上进行的。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_b</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	 	       	     </span><span class="err">↓</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>将外连接转为内连接</p>
<p>如果可能的话，计划器会将<code>OUTER JOIN</code>查询转换为<code>INNER JOIN</code>查询。</p>
</li>
</ol>
<h3>3.6.2 获取代价最小的路径<span class="hx-absolute -hx-mt-20" id="362-获取代价最小的路径"></span>
    <a href="#362-%e8%8e%b7%e5%8f%96%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%b7%af%e5%be%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>为了获取最佳计划树，计划器必须考虑各个索引与各种连接方法之间的所有可能组合。 如果表的数量超过某个水平，该过程的代价就会因为组合爆炸而变得非常昂贵，以至于根本不可行。</p>
<p>幸运的是，如果表的数量小于12张，计划器可以使用动态规划来获取最佳计划； 否则计划器会使用遗传算法。详情如下：</p>
<blockquote>
  <h4>基因查询优化器<span class="hx-absolute -hx-mt-20" id="基因查询优化器"></span>
    <a href="#%e5%9f%ba%e5%9b%a0%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>当执行一个多表连接查询时，大量时间耗费在了优化查询计划上。 为了应对这种情况，PostgreSQL实现了一个有趣的功能：<a href="https://www.postgresql.org/docs/current/static/geqo.html" target="_blank" rel="noopener">基因查询优化器</a>。 这种近似算法能在合理时间内确定一个合理的计划。 因此在查询优化阶段，如果参与连接的表数量超过参数<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-GEQO-THRESHOLD" target="_blank" rel="noopener"><code>geqo_threshold</code></a>指定的阈值（默认值为12），PostgreSQL将使用遗传算法来生成查询计划。</p>
</blockquote>
<p>使用动态规划确定最佳计划树的过程，其步骤如下：</p>
<ul>
<li>
<p>第一层</p>
<p>获得每张表上代价最小的路径，代价最小的路径存储在表相应的<code>RelOptInfo</code>结构中。</p>
</li>
<li>
<p>第二层</p>
<p>从所有表中选择两个表，为每种组合找出代价最低的路径。</p>
<p>举个例子，如果总共有两张表，表<code>A</code>与表<code>B</code>，则表<code>A</code>和<code>B</code>表连接的各种路径中，代价最小的那条即为最终想要的答案。在下文中，两个表的<code>RelOptInfo</code>记做${A,B}$。</p>
<p>如果有三个表，则需要获取${A,B}, {A,C},{B,C}$三种组合里各自代价最小的路径。</p>
</li>
<li>
<p>第三层及其后</p>
<p>继续进行同样的处理，直到层级等于表数量。</p>
</li>
</ul>
<p>通过这种方式，在每个层级都能解决最小代价问题的一部分，且其结果能被更高层级的计算复用，从而使代价最小的计划树能够被高效地计算出来。</p>
<p><strong>图3.31 如何使用动态规划获取代价最小的访问路径</strong></p>
<p><img src="/img/fig-3-31.png" alt="" loading="lazy" /></p>
<p>接下来会针对下面的查询，解释计划器是如何获取代价最小的计划的。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_a&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_a_pkey&#34;</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_b&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">400</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h4>3.6.2.1 第一层的处理<span class="hx-absolute -hx-mt-20" id="3621-第一层的处理"></span>
    <a href="#3621-%e7%ac%ac%e4%b8%80%e5%b1%82%e7%9a%84%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>在第一层中，计划器会为查询中涉及的关系创建相应的<code>RelOptInfo</code>结构，并估计每个关系上的最小代价。 在这一步中，<code>RelOptInfo</code>结构会被添加至该查询对应<code>PlannerInfo</code>的<code>simple_rel_arrey</code>数组字段中。</p>
<p><strong>图3.32 第一层处理后的<code>PlannerInfo</code>与<code>RelOptInfo</code></strong></p>
<p><img src="/img/fig-3-32.png" alt="" loading="lazy" /></p>
<p>表<code>tbl_a</code>的<code>RelOptInfo</code>有三条访问路径，它们被添加至<code>RelOptInfo</code>的路径列表中。这三条路径分别被三个指针所链接，即三个指向代价最小路径的指针：启动代价最小的路径，总代价最小的路径，参数化代价最小的路径。 启动代价最小的路径与总代价最小的路径涵义显而易见，因此，这里只会说一下<strong>参数化索引扫描代价最小的路径（cheapest parameterized index scan path）</strong>。</p>
<p>如3.5.1.3节所述，计划器会考虑为索引嵌套循环连接使用<strong>参数化路径（parameterized path）</strong>（极少数情况下也会用于带外表索引扫描的索引化归并连接）。参数化索引扫描代价最小的路径，就是所有参数化路径中代价最小的那个。</p>
<p>表<code>tbl_b</code>的<code>RelOptInfo</code>仅有顺序扫描访问路径，因为<code>tbl_b</code>上没有相关索引。</p>
<h4>3.6.2.2 第二层的处理<span class="hx-absolute -hx-mt-20" id="3622-第二层的处理"></span>
    <a href="#3622-%e7%ac%ac%e4%ba%8c%e5%b1%82%e7%9a%84%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>在第二层中，计划器会在<code>PlannerInfo</code>的<code>join_rel_list</code>字段中创建一个<code>RelOptInfo</code>结构。 然后估计所有可能连接路径的代价，并且选择代价最小的那条访问路径。 <code>RelOptInfo</code>会将最佳访问路径作为总代价最小的路径， 如图3.33所示。</p>
<p><strong>图3.33 第二层处理后的<code>PlannerInfo</code>和<code>RelOptInfo</code></strong></p>
<p><img src="/img/fig-3-33.png" alt="" loading="lazy" /></p>
<p>表3.1展示了本例中连接访问路径的所有组合。本例中查询的连接类型为<strong>等值连接（equi-join）</strong>，因而对全部三种连接算法进行评估。 为方便起见，这里引入了一些有关访问路径的符号：</p>
<ul>
<li><code>SeqScanPath(table)</code>表示表<code>table</code>上的顺序扫描路径。</li>
<li><code>Materialized -&gt; SeqScanPath(table)</code>表示表<code>table</code>上的物化顺序扫描路径。</li>
<li><code>IndexScanPath(table,attribute)</code>表示按表<code>table</code>中属性<code>attribute</code>上的索引扫描路径。</li>
<li><code>ParameterizedIndexScanPath(table,attribute1,attribute2)</code>表示表<code>table</code>中属性<code>attribute1</code>上的参数化索引路径，并使用外表上的属性<code>attribute2</code>参数化。</li>
</ul>
<p><strong>表 3.1 此示例中的所有连接访问路径组合</strong></p>
<p><strong>嵌套循环连接</strong></p>
<table>
  <thead>
      <tr>
          <th>外表路径</th>
          <th>内表路径</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td><code>Materialized -&gt; SeqScanPath(tbl_b)</code></td>
          <td>物化嵌套循环链接</td>
      </tr>
      <tr>
          <td><code>IndexScanPath(tbl_a,id)</code></td>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td>嵌套循环连接，走外表索引</td>
      </tr>
      <tr>
          <td><code>IndexScanPath(tbl_a,id)</code></td>
          <td><code>Materialized -&gt; SeqScanPath(tbl_b)</code></td>
          <td>物化嵌套循环连接，走外表索引</td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td><code>Materialized -&gt; SeqScanPath(tbl_a)</code></td>
          <td>物化嵌套循环连接</td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td><code>ParametalizedIndexScanPath(tbl_a, id, tbl_b.id)</code></td>
          <td>索引嵌套循环连接</td>
      </tr>
  </tbody>
</table>
<p><strong>归并连接</strong></p>
<table>
  <thead>
      <tr>
          <th>外表路径</th>
          <th>内表路径</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>IndexScanPath(tbl_a,id)</code></td>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td>用外表索引做归并连接</td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>哈希连接</strong></p>
<table>
  <thead>
      <tr>
          <th>外表路径</th>
          <th>内表路径</th>
          <th>备注</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>SeqScanPath(tbl_b)</code></td>
          <td><code>SeqScanPath(tbl_a)</code></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>例如在嵌套循环连接的部分总共评估了七条连接路径。 第一条表示在外表<code>tbl_a</code>和内表<code>tbl_b</code>上都使用顺序扫描路径；第二条表示在外表<code>tbl_a</code>上使用路径顺序扫描路径，而在内表<code>tbl_b</code>上使用物化顺序扫描路径，诸如此类。</p>
<p>计划器最终从估计的连接访问路径中选择代价最小的那条，并且将其添加至<code>RelOptInfo{tbl_a,tbl_b}</code>的路径列表中，如图3.33所示。</p>
<p>在本例中，如下面<code>EXPLAIN</code>的结果所示，计划器选择了在内表<code>tbl_b</code>和外表<code>tbl_c</code>上进行散列连接。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">400</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                              </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">                              
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">90</span><span class="p">.</span><span class="mi">50</span><span class="p">..</span><span class="mi">277</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">400</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Hash</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">145</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">10000</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Hash</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">400</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="n">b</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">85</span><span class="p">.</span><span class="mi">50</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">400</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h3>3.6.3 获取三表查询代价最小的路径<span class="hx-absolute -hx-mt-20" id="363-获取三表查询代价最小的路径"></span>
    <a href="#363-%e8%8e%b7%e5%8f%96%e4%b8%89%e8%a1%a8%e6%9f%a5%e8%af%a2%e4%bb%a3%e4%bb%b7%e6%9c%80%e5%b0%8f%e7%9a%84%e8%b7%af%e5%be%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>涉及三个表的查询，其代价最小的路径的获取过程如下所示：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_a&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_b&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="err">\</span><span class="n">d</span><span class="w"> </span><span class="n">tbl_c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">Table</span><span class="w"> </span><span class="s2">&#34;public.tbl_c&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Modifiers</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------+---------+-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">data</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Indexes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;tbl_c_pkey&#34;</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl_a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tbl_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">-#</span><span class="w">                </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>
<p>第一层：</p>
<p>计划器估计所有表上各自开销最小的路径，并将该信息存储在表相应的<code>RelOptInfos</code>结构<code>{tbl_a}</code>，<code>{tbl_b}</code>，<code>{tbl_c}</code>中。</p>
</li>
<li>
<p>第二层：</p>
<p>计划器从三个表中选出两个，列出所有组合，分别评估每种组合里代价最小的路径。然后，规划器将信息存储在组合相应的<code>RelOptInfos</code>结构中：<code>{tbl_a,tbl_b}</code>，<code>{tbl_b,tbl_c}</code>和<code>{tbl_a,tbl_c}</code>中。</p>
</li>
<li>
<p>第三层：</p>
<p>计划器根据所有已获取的<code>RelOptInfos</code>，选择代价最小的路径。更确切地说，计划器会考虑三种<code>RelOptInfos</code>组合：<code>{tbl_a,{tbl_b,tbl_c}}</code>，<code>{tbl_b,{tbl_a,tbl_c}}</code>和<code>{tbl_c,{tbl_a,tbl_b}}</code>，而<code>{tbl_a,tbl_b,tbl_c}</code>如下所示：</p>
</li>
</ul>
$$
\begin{equation}
  \{\verb|tbl_a|,\verb|tbl_b|,\verb|tbl_c|\} = \\ \mathrm{min}(\{\verb|tbl_a|,\{\verb|tbl_b|,\verb|tbl_c|\}\}, \{\verb|tbl_b|,\{\verb|tbl_a|,\verb|tbl_c|\}\}, \{\verb|tbl_c|,\{\verb|tbl_a|,\verb|tbl_b|\}\}).
\end{equation}
$$<p>​	计划器会估算这里面所有可能连接路径的代价。</p>
<p>在处理<code>{tbl_c,{tbl_a,tbl_b}}</code>对应的<code>RelOptInfo</code>时，计划器会估计<code>tbl_c</code>和<code>{tbl_a,tbl_b}</code>连接代价最小的路径。本例中<code>{tbl_a,tbl_b}</code>已经选定为内表为<code>tbl_a</code>且外表为<code>tbl_b</code>的散列连接。如先前小节所述，在估计时三种连接算法及其变体都会被评估，即嵌套循环连接及其变体，归并连接及其变体，散列连接及其变体。</p>
<p>计划器以同样的方式处理<code>{tbl_a,{tbl_b,tbl_c}}</code>与<code>{tbl_b,{tbl_a,tbl_c}}</code>对应的<code>RelOptInfo</code>，并最终从所有估好的路径中选择代价最小的访问路径。</p>
<p>该查询的<code>EXPLAIN</code>命令结果如下所示：</p>
<p><img src="/img/fig-3-34.png" alt="" loading="lazy" /></p>
<p>最外层的连接是索引嵌套循环连接（第5行），第13行显示了内表上的参数化索引扫描，外表则是一个散列连接的结果该散列连接的内表是<code>tbl_a</code>，外表是<code>tbl_b</code>（第7-12行）。 因此，执行程序首先执行<code>tbl_a</code>和<code>tbl_b</code>上的散列连接，再执行索引嵌套循环连接。</p>
<h2>参考文献<span class="hx-absolute -hx-mt-20" id="参考文献"></span>
    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><ul>
<li>[1] Abraham Silberschatz, Henry F. Korth, and S. Sudarshan, &ldquo;<a href="https://www.amazon.com/dp/0073523321" target="_blank" rel="noopener">Database System Concepts</a>&rdquo;, McGraw-Hill Education, ISBN-13: 978-0073523323</li>
<li>[2] Thomas M. Connolly, and Carolyn E. Begg, &ldquo;<a href="https://www.amazon.com/dp/0321523067" target="_blank" rel="noopener">Database Systems</a>&rdquo;, Pearson, ISBN-13: 978-0321523068</li>
</ul>

        </div>
        <div class="hx-mt-16"></div>
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/ch2/"
        title="2. 进程和内存架构"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-pr-4 rtl:hx-pl-4"
      ><svg class="hx-inline hx-h-5 hx-shrink-0 ltr:hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>2. 进程和内存架构</a><a
        href="/ch4/"
        title="4. 外部数据包装器与并行查询"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-ml-auto ltr:hx-pl-4 ltr:hx-text-right rtl:hx-mr-auto rtl:hx-pr-4 rtl:hx-text-left"
      >4. 外部数据包装器与并行查询<svg class="hx-inline hx-h-5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div><div class="hx-mt-6 hx-text-xs">© 2024 Hextra.</div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>
<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/zh.search.js" integrity=""></script><link type="text/css" rel="stylesheet" href="/lib/katex/katex.min.7e5db7914b97e596a36c1abb67ccc7f174f8bb71d38c9a88c55b262ed1737f97.css" integrity="sha256-fl23kUuX5ZajbBq7Z8zH8XT4u3HTjJqIxVsmLtFzf5c=" />
<script defer src="/lib/katex/katex.min.9f45307c5794ed247a0d095f3a62e52ef2215a67b2327203a7fd919959ae79d1.js" integrity="sha256-n0UwfFeU7SR6DQlfOmLlLvIhWmeyMnIDp/2RmVmuedE="></script>
<script defer src="/lib/katex/auto-render.min.7b57d427ac6270677daf8d8380ded2cc73336f9149a167b8e1fe0d6ef66604ae.js" integrity="sha256-e1fUJ6xicGd9r42DgN7SzHMzb5FJoWe44f4NbvZmBK4="></script>
<script defer src="/lib/katex/mhchem.min.f0ca03df194b8c3d6017ff455db6a0ef98857905663fa311a6cded788b15340b.js" integrity="sha256-8MoD3xlLjD1gF/9FXbag75iFeQVmP6MRps3teIsVNAs="></script>
<script>
  
  
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\begin{equation}", right: "\\end{equation}", display: true },
        {left: "\\begin{align}", right: "\\end{align}", display: true},
        {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
        {left: "\\begin{gather}", right: "\\end{gather}", display: true},
        {left: "\\begin{CD}", right: "\\end{CD}", display: true},
        { left: "\\[", right: "\\]", display: true },
      ],
      throwOnError: false,
    });
  });
</script>

  </body>
</html>
