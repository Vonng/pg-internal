<!DOCTYPE html>
<html lang="zh"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>5. 并发控制 – PG技术内幕</title>
  <meta name="description" content="当多个事务同时在数据库中运行时，并发控制是一种用于维持一致性与隔离性的技术，一致性与隔离性是ACID的两个属性。
从宽泛的意义上来讲，有三种并发控制技术：多版本并发控制（Multi-version Concurrency Control, MVCC），严格两阶段锁定（Strict Two-Phase Locking, S2PL）和乐观并发控制（Optimistic Concurrency Control, OCC），每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰快照隔离（Snapshot Isolation，SI）。" /><link rel="canonical" href="http://localhost:1313/ch5/" itemprop="url" />

<meta property="og:title" content="5. 并发控制" />
<meta property="og:description" content="当多个事务同时在数据库中运行时，并发控制是一种用于维持一致性与隔离性的技术，一致性与隔离性是ACID的两个属性。
从宽泛的意义上来讲，有三种并发控制技术：多版本并发控制（Multi-version Concurrency Control, MVCC），严格两阶段锁定（Strict Two-Phase Locking, S2PL）和乐观并发控制（Optimistic Concurrency Control, OCC），每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰快照隔离（Snapshot Isolation，SI）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/ch5/" /><meta property="article:section" content="" />



  <meta itemprop="name" content="5. 并发控制">
  <meta itemprop="description" content="当多个事务同时在数据库中运行时，并发控制是一种用于维持一致性与隔离性的技术，一致性与隔离性是ACID的两个属性。
从宽泛的意义上来讲，有三种并发控制技术：多版本并发控制（Multi-version Concurrency Control, MVCC），严格两阶段锁定（Strict Two-Phase Locking, S2PL）和乐观并发控制（Optimistic Concurrency Control, OCC），每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰快照隔离（Snapshot Isolation，SI）。">
  <meta itemprop="wordCount" content="20681">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="5. 并发控制">
  <meta name="twitter:description" content="当多个事务同时在数据库中运行时，并发控制是一种用于维持一致性与隔离性的技术，一致性与隔离性是ACID的两个属性。
从宽泛的意义上来讲，有三种并发控制技术：多版本并发控制（Multi-version Concurrency Control, MVCC），严格两阶段锁定（Strict Two-Phase Locking, S2PL）和乐观并发控制（Optimistic Concurrency Control, OCC），每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰快照隔离（Snapshot Isolation，SI）。">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-mr-2 hx-block dark:hx-hidden" src="/images/logo.svg" alt="PG技术内幕" height="20" width="20" />
        <img class="hx-mr-2 hx-hidden dark:hx-block" src="/images/logo-dark.svg" alt="PG技术内幕" height="20" width="20" />
        <span class="hx-mr-2 hx-font-extrabold hx-inline hx-select-none" title="PG技术内幕">PG技术内幕</span>
    </a><a
            title="Documentation"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Documentation</span>
          </a><a
            title="Versions"
            href=""
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Versions</span>
          </a><a
            title="Blog"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Blog</span>
          </a><a
            title="About"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">About</span>
          </a><a
            title="Showcase"
            href="/showcase"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Showcase</span>
          </a><div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/imfing/hextra" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex max-w-full'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-sticky">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch3/"
    
  >3. 查询处理
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch5/"
    
  >5. 并发控制
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              ></a>
            </li>
          <li>
              <a
                href="#51-%e4%ba%8b%e5%8a%a1%e6%a0%87%e8%af%86"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.1 事务标识</a>
            </li>
          <li>
              <a
                href="#52-%e5%85%83%e7%bb%84%e7%bb%93%e6%9e%84"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.2 元组结构</a>
            </li>
          <li>
              <a
                href="#53-%e5%85%83%e7%bb%84%e7%9a%84%e5%a2%9e%e5%88%a0%e6%94%b9"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.3 元组的增删改</a>
            </li>
          <li>
              <a
                href="#54-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97clog"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.4 提交日志（clog）</a>
            </li>
          <li>
              <a
                href="#55-%e4%ba%8b%e5%8a%a1%e5%bf%ab%e7%85%a7"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.5 事务快照</a>
            </li>
          <li>
              <a
                href="#56-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5%e8%a7%84%e5%88%99"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.6 可见性检查规则</a>
            </li>
          <li>
              <a
                href="#57-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.7 可见性检查</a>
            </li>
          <li>
              <a
                href="#58-%e9%98%b2%e6%ad%a2%e4%b8%a2%e5%a4%b1%e6%9b%b4%e6%96%b0"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.8 防止丢失更新</a>
            </li>
          <li>
              <a
                href="#59-%e5%8f%af%e4%b8%b2%e8%a1%8c%e5%8c%96%e5%bf%ab%e7%85%a7%e9%9a%94%e7%a6%bb"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.9 可串行化快照隔离</a>
            </li>
          <li>
              <a
                href="#510-%e6%89%80%e9%9c%80%e7%9a%84%e7%bb%b4%e6%8a%a4%e8%bf%9b%e7%a8%8b"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >5.10 所需的维护进程</a>
            </li>
          <li>
              <a
                href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >参考文献</a>
            </li>
          </ul>
  </li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch9/"
    
  >9. 预写式日志
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
    </ul>

    <ul class="hx-flex hx-flex-col hx-gap-1 max-md:hx-hidden">
        
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch3/"
    
  >3. 查询处理
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch5/"
    
  >5. 并发控制
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch9/"
    
  >9. 预写式日志
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
        
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
      </ul>
    </div>
  
  
    <div class="  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#postgresql%e4%b8%ad%e7%9a%84%e4%ba%8b%e5%8a%a1%e9%9a%94%e7%a6%bb%e7%ad%89%e7%ba%a7">PostgreSQL中的事务隔离等级
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#51-%e4%ba%8b%e5%8a%a1%e6%a0%87%e8%af%86">5.1 事务标识
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#52-%e5%85%83%e7%bb%84%e7%bb%93%e6%9e%84">5.2 元组结构
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#53-%e5%85%83%e7%bb%84%e7%9a%84%e5%a2%9e%e5%88%a0%e6%94%b9">5.3 元组的增删改
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#531-%e6%8f%92%e5%85%a5">5.3.1 插入
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pageinspect">pageinspect
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#532-%e5%88%a0%e9%99%a4">5.3.2 删除
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#533-%e6%9b%b4%e6%96%b0">5.3.3 更新
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#534-%e7%a9%ba%e9%97%b2%e7%a9%ba%e9%97%b4%e6%98%a0%e5%b0%84">5.3.4 空闲空间映射
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pg_freespacemap">pg_freespacemap
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#54-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97clog">5.4 提交日志（clog）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#541-%e4%ba%8b%e5%8a%a1%e7%8a%b6%e6%80%81">5.4.1 事务状态
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#542-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c">5.4.2 提交日志如何工作
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#543-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97%e7%9a%84%e7%bb%b4%e6%8a%a4">5.4.3 提交日志的维护
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#55-%e4%ba%8b%e5%8a%a1%e5%bf%ab%e7%85%a7">5.5 事务快照
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%86%85%e7%bd%ae%e5%87%bd%e6%95%b0txid_current_snapshot%e5%8f%8a%e5%85%b6%e6%96%87%e6%9c%ac%e8%a1%a8%e7%a4%ba">内置函数txid_current_snapshot及其文本表示
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#56-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5%e8%a7%84%e5%88%99">5.6 可见性检查规则
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#561--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%baaborted">5.6.1 t_xmin的状态为ABORTED
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#562--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%bain_progress">5.6.2 t_xmin的状态为IN_PROGRESS
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#563--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%bacommitted">5.6.3 t_xmin的状态为COMMITTED
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#57-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5">5.7 可见性检查
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#571-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5">5.7.1 可见性检查
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%8f%90%e7%a4%ba%e4%bd%8dhint-bits">提示位（Hint Bits）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#572-postgresql%e5%8f%af%e9%87%8d%e5%a4%8d%e8%af%bb%e7%ad%89%e7%ba%a7%e4%b8%ad%e7%9a%84%e5%b9%bb%e8%af%bb">5.7.2 PostgreSQL可重复读等级中的幻读
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#58-%e9%98%b2%e6%ad%a2%e4%b8%a2%e5%a4%b1%e6%9b%b4%e6%96%b0">5.8 防止丢失更新
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#581-%e5%b9%b6%e5%8f%91update%e5%91%bd%e4%bb%a4%e7%9a%84%e8%a1%8c%e4%b8%ba">5.8.1 并发UPDATE命令的行为
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bc%aa%e4%bb%a3%e7%a0%81execupdate">伪代码：ExecUpdate
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-12 rtl:hx-pr-12 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%a5%e5%85%88%e6%9b%b4%e6%96%b0%e8%80%85%e4%b8%ba%e5%87%86--%e4%bb%a5%e5%85%88%e6%8f%90%e4%ba%a4%e8%80%85%e4%b8%ba%e5%87%86">以先更新者为准 / 以先提交者为准
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#582-%e4%be%8b%e5%ad%90">5.8.2 例子
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%be%8b1">例1
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%be%8b2">例2
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%be%8b3">例3
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#59-%e5%8f%af%e4%b8%b2%e8%a1%8c%e5%8c%96%e5%bf%ab%e7%85%a7%e9%9a%94%e7%a6%bb">5.9 可串行化快照隔离
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#591-ssi%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%9f%ba%e6%9c%ac%e7%ad%96%e7%95%a5">5.9.1 SSI实现的基本策略
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#592-postgresql%e7%9a%84ssi%e5%ae%9e%e7%8e%b0">5.9.2 PostgreSQL的SSI实现
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#siread%e9%94%81">SIREAD锁
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%af%bb-%e5%86%99%e5%86%b2%e7%aa%81">读-写冲突
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#593-ssi%e7%9a%84%e5%8e%9f%e7%90%86">5.9.3 SSI的原理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#594-%e5%81%87%e9%98%b3%e6%80%a7%e7%9a%84%e4%b8%b2%e8%a1%8c%e5%8c%96%e5%bc%82%e5%b8%b8">5.9.4 假阳性的串行化异常
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#510-%e6%89%80%e9%9c%80%e7%9a%84%e7%bb%b4%e6%8a%a4%e8%bf%9b%e7%a8%8b">5.10 所需的维护进程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#5101--%e5%86%bb%e7%bb%93%e5%a4%84%e7%90%86">5.10.1  冻结处理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae">参考文献
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400"><a class="hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50" href="https://github.com/Vonng/pg-internal/edit/main/content/ch5.md" target="_blank" rel="noreferrer">Edit this page</a>
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
        <div class="content">
          <h1>5. 并发控制</h1>
          <p>当多个事务同时在数据库中运行时，<strong>并发控制</strong>是一种用于维持<strong>一致性</strong>与<strong>隔离性</strong>的技术，一致性与隔离性是ACID的两个属性。</p>
<p>从宽泛的意义上来讲，有三种并发控制技术：<strong>多版本并发控制（Multi-version Concurrency Control, MVCC）</strong>，<strong>严格两阶段锁定（Strict Two-Phase Locking, S2PL）<strong>和</strong>乐观并发控制（Optimistic Concurrency Control, OCC）</strong>，每种技术都有多种变体。在MVCC中，每个写操作都会创建一个新版本的数据项，并保留其旧版本。当事务读取数据对象时，系统会选择其中的一个版本，通过这种方式来确保各个事务间相互隔离。 MVCC的主要优势在于“读不会阻塞写，而写也不会阻塞读”，相反的例子是，基于S2PL的系统在写操作发生时会阻塞相应对象上的读操作，因为写入者获取了对象上的排他锁。 PostgreSQL和一些RDBMS使用一种MVCC的变体，名曰<strong>快照隔离（Snapshot Isolation，SI）</strong>。</p>
<p>一些RDBMS（例如Oracle）使用回滚段来实现快照隔离SI。当写入新数据对象时，旧版本对象先被写入回滚段，随后用新对象覆写至数据区域。 PostgreSQL使用更简单的方法：新数据对象被直接插入到相关表页中。读取对象时，PostgreSQL根据<strong>可见性检查规则（visibility check rules）</strong>，为每个事务选择合适的对象版本作为响应。</p>
<p>SI中不会出现在ANSI SQL-92标准中定义的三种异常：脏读，不可重复读和幻读。但SI无法实现真正的可串行化，因为在SI中可能会出现串行化异常：例如<strong>写偏差（write skew）<strong>和</strong>只读事务偏差（Read-only Transaction Skew）</strong>。需要注意的是：ANSI SQL-92标准中可串行化的定义与现代理论中的定义<strong>并不相同</strong>。为了解决这个问题，PostgreSQL从9.1版本之后添加了<strong>可串行化快照隔离（SSI，Serializable Snapshot Isolation）</strong>，SSI可以检测串行化异常，并解决这种异常导致的冲突。因此，9.1版本之后的PostgreSQL提供了真正的<code>SERIALIZABLE</code>隔离等级（此外SQL Server也使用SSI，而Oracle仍然使用SI）。</p>
<p>本章包括以下四个部分：</p>
<ul>
<li>
<p>第1部分：第5.1~5.3节。</p>
<p>这一部分介绍了理解后续部分所需的基本信息。</p>
<p>第5.1和5.2节分别描述了事务标识和元组结构。第5.3节展示了如何插入，删除和更新元组。</p>
</li>
<li>
<p>第2部分：第5.4~5.6节。</p>
<p>这一部分说明了实现并发控制机制所需的关键功能。</p>
<p>第5.4，5.5和5.6节描述了<strong>提交日志（clog）</strong>，分别介绍了事务状态，事务快照和可见性检查规则。</p>
</li>
<li>
<p>第3部分：第5.7~5.9节。</p>
<p>这一部分使用具体的例子来介绍PostgreSQL中的并发控制。</p>
<p>这一部分说明了如何防止ANSI SQL标准中定义的三种异常。第5.7节描述了可见性检查，第5.8节介绍了如何防止丢失更新，第5.9节简要描述了SSI。</p>
</li>
<li>
<p>第4部分：第5.10节。</p>
<p>这一部分描述了并发控制机制持久运行所需的几个维护过程。维护过程主要通过**清理过程（vacuum processing）**进行，清理过程将在<a href="/ch6" >第6章</a>详细阐述。</p>
</li>
</ul>
<p>并发控制包含着很多主题，本章重点介绍PostgreSQL独有的内容。故这里省略了锁模式与死锁处理的内容（相关信息请参阅官方文档）。</p>
<blockquote>
  <h3>PostgreSQL中的事务隔离等级<span class="hx-absolute -hx-mt-20" id="postgresql中的事务隔离等级"></span>
    <a href="#postgresql%e4%b8%ad%e7%9a%84%e4%ba%8b%e5%8a%a1%e9%9a%94%e7%a6%bb%e7%ad%89%e7%ba%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>PostgreSQL实现的事务隔离等级如下表所示：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">隔离等级</th>
          <th style="text-align: center">脏读</th>
          <th style="text-align: center">不可重复读</th>
          <th style="text-align: center">幻读</th>
          <th style="text-align: center">串行化异常</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">读已提交</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">可能</td>
          <td style="text-align: center">可能</td>
          <td style="text-align: center">可能</td>
      </tr>
      <tr>
          <td style="text-align: center">可重复读[1]</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">PG中不可能，见5.7.2小节<br />但ANSI SQL中可能</td>
          <td style="text-align: center">可能</td>
      </tr>
      <tr>
          <td style="text-align: center">可串行化</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">不可能</td>
          <td style="text-align: center">不可能</td>
      </tr>
  </tbody>
</table>
<p>[1]：在9.0及更早版本中，该级别被当做<code>SERIALIZABLE</code>，因为它不会出现ANSI SQL-92标准中定义的三种异常。 但9.1版中SSI的实现引入了真正的<code>SERIALIZABLE</code>级别，该级别已被改称为<code>REPEATABLE READ</code>。</p>
</blockquote>
<blockquote>
  <p>PostgreSQL对DML（<code>SELECT, UPDATE, INSERT, DELETE</code>等命令）使用SSI，对DDL（<code>CREATE TABLE</code>等命令）使用2PL。</p>
</blockquote>
<h2>5.1 事务标识<span class="hx-absolute -hx-mt-20" id="51-事务标识"></span>
    <a href="#51-%e4%ba%8b%e5%8a%a1%e6%a0%87%e8%af%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>每当事务开始时，事务管理器就会为其分配一个称为**事务标识（transaction id, txid）**的唯一标识符。 PostgreSQL的<code>txid</code>是一个32位无符号整数，总取值约42亿。在事务启动后执行内置的<code>txid_current()</code>函数，即可获取当前事务的<code>txid</code>，如下所示。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">BEGIN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">txid_current</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">txid_current</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">          </span><span class="mi">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>PostgreSQL保留以下三个特殊<code>txid</code>：</p>
<ul>
<li><strong>0</strong>表示**无效（Invalid）**的<code>txid</code>。</li>
<li><strong>1</strong>表示**初始启动（Bootstrap）**的<code>txid</code>，仅用于数据库集群的初始化过程。</li>
<li><strong>2</strong>表示**冻结（Frozen）**的<code>txid</code>，详情参考第5.10.1节。</li>
</ul>
<p><code>txid</code>可以相互比较大小。例如对于<code>txid=100</code>的事务，大于100的<code>txid</code>属于“未来”，且对于<code>txid=100</code>的事务而言都是**不可见（invisible）**的；小于100的<code>txid</code>属于“过去”，且对该事务可见，如图5.1(a)所示。</p>
<p><strong>图5.1  PostgreSQL中的事务标识</strong></p>
<p><img src="/img/fig-5-01.png" alt="" loading="lazy" /></p>
<p>因为<code>txid</code>在逻辑上是无限的，而实际系统中的<code>txid</code>空间不足（4字节取值空间约42亿），因此PostgreSQL将<code>txid</code>空间视为一个环。对于某个特定的<code>txid</code>，其前约21亿个<code>txid</code>属于过去，而其后约21亿个<code>txid</code>属于未来。如图5.1(b)所示。</p>
<p>所谓的<code>txid</code>回卷问题将在5.10.1节中介绍。</p>
<blockquote>
  <p>请注意，<code>txid</code>并非是在<code>BEGIN</code>命令执行时分配的。在PostgreSQL中，当执行<code>BEGIN</code>命令后的第一条命令时，事务管理器才会分配<code>txid</code>，并真正启动其事务。</p>
</blockquote>
<h2>5.2 元组结构<span class="hx-absolute -hx-mt-20" id="52-元组结构"></span>
    <a href="#52-%e5%85%83%e7%bb%84%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>可以将表页中的堆元组分为两类：普通数据元组与TOAST元组。本节只会介绍普通元组。</p>
<p>堆元组由三个部分组成，即<code>HeapTupleHeaderData</code>结构，空值位图，以及用户数据，如图5.2所示。</p>
<p><strong>图5.2 元组结构</strong></p>
<p><img src="/img/fig-5-02.png" alt="" loading="lazy" /></p>
<blockquote>
  <p><code>HeapTupleHeaderData</code>结构在<a href="https://github.com/postgres/postgres/blob/ee943004466418595363d567f18c053bae407792/src/include/access/htup_details.h" target="_blank" rel="noopener"><code>src/include/access/htup_details.h</code></a>中定义。</p>
</blockquote>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">HeapTupleFields</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TransactionId</span> <span class="n">t_xmin</span><span class="p">;</span>		   <span class="cm">/* 插入事务的ID */</span>
</span></span><span class="line"><span class="cl">        <span class="n">TransactionId</span> <span class="n">t_xmax</span><span class="p">;</span>          <span class="cm">/*删除或锁定事务的ID*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">union</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">CommandId</span>       <span class="n">t_cid</span><span class="p">;</span>     <span class="cm">/* 插入或删除的命令ID */</span>
</span></span><span class="line"><span class="cl">                <span class="n">TransactionId</span> 	<span class="n">t_xvac</span><span class="p">;</span>    <span class="cm">/* 老式VACUUM FULL的事务ID */</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">t_field3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">HeapTupleFields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">DatumTupleFields</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">int32</span>          <span class="n">datum_len_</span><span class="p">;</span>          <span class="cm">/* 变长头部长度*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">int32</span>          <span class="n">datum_typmod</span><span class="p">;</span>   	    <span class="cm">/* -1或者是记录类型的标识 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">Oid</span>            <span class="n">datum_typeid</span><span class="p">;</span>   	    <span class="cm">/* 复杂类型的OID或记录ID */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DatumTupleFields</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">HeapTupleHeaderData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">union</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">HeapTupleFields</span> <span class="n">t_heap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">DatumTupleFields</span> <span class="n">t_datum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">t_choice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ItemPointerData</span> <span class="n">t_ctid</span><span class="p">;</span>         <span class="cm">/* 当前元组，或更新元组的TID */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 下面的字段必需与结构MinimalTupleData相匹配! */</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint16</span>          <span class="n">t_infomask2</span><span class="p">;</span>    <span class="cm">/* 属性与标记位 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint16</span>          <span class="n">t_infomask</span><span class="p">;</span>     <span class="cm">/* 很多标记位 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">uint8</span>           <span class="n">t_hoff</span><span class="p">;</span>         <span class="cm">/* 首部+位图+填充的长度 */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ^ - 23 bytes - ^ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits8</span>           <span class="n">t_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>      <span class="cm">/* NULL值的位图 —— 变长的 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 本结构后面还有更多数据 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">HeapTupleHeaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">HeapTupleHeaderData</span> <span class="o">*</span><span class="n">HeapTupleHeader</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>虽然<code>HeapTupleHeaderData</code>结构包含七个字段，但后续部分中只需要了解四个字段即可。</p>
<ul>
<li><code>t_xmin</code>保存插入此元组的事务的<code>txid</code>。</li>
<li><code>t_xmax</code>保存删除或更新此元组的事务的<code>txid</code>。如果尚未删除或更新此元组，则<code>t_xmax</code>设置为0，即无效。</li>
<li><code>t_cid</code>保存<strong>命令标识（command id, cid）</strong>，<code>cid</code>意思是在当前事务中，执行当前命令之前执行了多少SQL命令，从零开始计数。例如，假设我们在单个事务中执行了三条<code>INSERT</code>命令<code>BEGIN;INSERT;INSERT;INSERT;COMMIT;</code>。如果第一条命令插入此元组，则该元组的<code>t_cid</code>会被设置为0。如果第二条命令插入此元组，则其<code>t_cid</code>会被设置为1，依此类推。</li>
<li><code>t_ctid</code>保存着指向自身或新元组的元组标识符（<code>tid</code>）。如第1.3节中所述，<code>tid</code>用于标识表中的元组。在更新该元组时，其<code>t_ctid</code>会指向新版本的元组；否则<code>t_ctid</code>会指向自己。</li>
</ul>
<h2>5.3 元组的增删改<span class="hx-absolute -hx-mt-20" id="53-元组的增删改"></span>
    <a href="#53-%e5%85%83%e7%bb%84%e7%9a%84%e5%a2%9e%e5%88%a0%e6%94%b9" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>本节会介绍元组的增删改过程，并简要描述用于插入与更新元组的<strong>自由空间映射（Free Space Map, FSM）</strong>。</p>
<p>这里主要关注元组，页首部与行指针不会在这里画出来，元组的具体表示如图5.3所示。</p>
<p><strong>图5.3 元组的表示</strong></p>
<p><img src="/img/fig-5-03.png" alt="" loading="lazy" /></p>
<h3>5.3.1 插入<span class="hx-absolute -hx-mt-20" id="531-插入"></span>
    <a href="#531-%e6%8f%92%e5%85%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在插入操作中，新元组将直接插入到目标表的页面中，如图5.4所示。</p>
<p><strong>图5.4 插入元组</strong></p>
<p><img src="/img/fig-5-04.png" alt="" loading="lazy" /></p>
<p>假设元组是由<code>txid=99</code>的事务插入页面中的，在这种情况下，被插入元组的首部字段会依以下步骤设置。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmin</code>设置为99，因为此元组由<code>txid=99</code>的事务所插入。</li>
<li><code>t_xmax</code>设置为0，因为此元组尚未被删除或更新。</li>
<li><code>t_cid</code>设置为0，因为此元组是由<code>txid=99</code>的事务所执行的第一条命令所插入的。</li>
<li><code>t_ctid</code>设置为<code>(0,1)</code>，指向自身，因为这是该元组的最新版本。</li>
</ul>
<blockquote>
  <h4><code>pageinspect</code><span class="hx-absolute -hx-mt-20" id="pageinspect"></span>
    <a href="#pageinspect" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>PostgreSQL自带了一个第三方贡献的扩展模块<code>pageinspect</code>，可用于检查数据库页面的具体内容。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pageinspect</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="p">(</span><span class="k">data</span><span class="w"> </span><span class="nb">text</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="n">A</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">lp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="n">t_xmin</span><span class="p">,</span><span class="w"> </span><span class="n">t_xmax</span><span class="p">,</span><span class="w"> </span><span class="n">t_field3</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t_cid</span><span class="p">,</span><span class="w"> </span><span class="n">t_ctid</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">FROM</span><span class="w"> </span><span class="n">heap_page_items</span><span class="p">(</span><span class="n">get_raw_page</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t_xmin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t_xmax</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t_cid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t_ctid</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------+--------+--------+-------+--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">     </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">99</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</blockquote>
<h3>5.3.2 删除<span class="hx-absolute -hx-mt-20" id="532-删除"></span>
    <a href="#532-%e5%88%a0%e9%99%a4" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在删除操作中，目标元组只是在逻辑上被标记为删除。目标元组的<code>t_xmax</code>字段将被设置为执行<code>DELETE</code>命令事务的<code>txid</code>。如图5.5所示。</p>
<p><strong>图5.5 删除元组</strong></p>
<p><img src="/img/fig-5-05.png" alt="" loading="lazy" />
假设<code>Tuple_1</code>被<code>txid=111</code>的事务删除。在这种情况下，<code>Tuple_1</code>的首部字段会依以下步骤设置。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmax</code>被设为111。</li>
</ul>
<p>如果<code>txid=111</code>的事务已经提交，那么<code>Tuple_1</code>就不是必需的了。通常不需要的元组在PostgreSQL中被称为<strong>死元组（dead tuple）</strong>。</p>
<p>死元组最终将从页面中被移除。清除死元组的过程被称为<strong>清理（VACUUM）过程</strong>，<a href="/ch6" >第6章</a>将介绍清理过程。</p>
<h3>5.3.3 更新<span class="hx-absolute -hx-mt-20" id="533-更新"></span>
    <a href="#533-%e6%9b%b4%e6%96%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在更新操作中，PostgreSQL在逻辑上实际执行的是删除最新的元组，并插入一条新的元组（图5.6）。</p>
<p><strong>图5.6 两次更新同一行</strong></p>
<p><img src="/img/fig-5-06.png" alt="" loading="lazy" /></p>
<p>假设由<code>txid=99</code>的事务插入的行，被<code>txid=100</code>的事务更新两次。</p>
<p>当执行第一条<code>UPDATE</code>命令时，<code>Tuple_1</code>的<code>t_xmax</code>被设为<code>txid 100</code>，在逻辑上被删除；然后<code>Tuple_2</code>被插入；接下来重写<code>Tuple_1</code>的<code>t_ctid</code>以指向<code>Tuple_2</code>。<code>Tuple_1</code>和<code>Tuple_2</code>的头部字段设置如下。</p>
<p><code>Tuple_1</code>：</p>
<ul>
<li><code>t_xmax</code>被设置为100。</li>
<li><code>t_ctid</code>从<code>(0,1)</code>被改写为<code>(0,2)</code>。</li>
</ul>
<p><code>Tuple_2</code>：</p>
<ul>
<li><code>t_xmin</code>被设置为100。</li>
<li><code>t_xmax</code>被设置为0。</li>
<li><code>t_cid</code>被设置为0。</li>
<li><code>t_ctid</code>被设置为<code>(0,2)</code>。</li>
</ul>
<p>当执行第二条<code>UPDATE</code>命令时，和第一条<code>UPDATE</code>命令类似，<code>Tuple_2</code>被逻辑删除，<code>Tuple_3</code>被插入。<code>Tuple_2</code>和<code>Tuple_3</code>的首部字段设置如下。</p>
<p><code>Tuple_2</code>：</p>
<ul>
<li><code>t_xmax</code>被设置为100。</li>
<li><code>t_ctid</code>从<code>(0,2)</code>被改写为<code>(0,3)</code>。</li>
</ul>
<p><code>Tuple_3</code>：</p>
<ul>
<li><code>t_xmin</code>被设置为100。</li>
<li><code>t_xmax</code>被设置为0。</li>
<li><code>t_cid</code>被设置为1。</li>
<li><code>t_ctid</code>被设置为<code>(0,3)</code>。</li>
</ul>
<p>与删除操作类似，如果<code>txid=100</code>的事务已经提交，那么<code>Tuple_1</code>和<code>Tuple_2</code>就成为了死元组，而如果<code>txid=100</code>的事务中止，<code>Tuple_2</code>和<code>Tuple_3</code>就成了死元组。</p>
<h3>5.3.4 空闲空间映射<span class="hx-absolute -hx-mt-20" id="534-空闲空间映射"></span>
    <a href="#534-%e7%a9%ba%e9%97%b2%e7%a9%ba%e9%97%b4%e6%98%a0%e5%b0%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>插入堆或索引元组时，PostgreSQL使用表与索引相应的<strong>FSM</strong>来选择可供插入的页面。</p>
<p>如1.2.3节所述，表和索引都有各自的FSM。每个FSM存储着相应表或索引文件中每个页面可用空间容量的信息。</p>
<p>所有FSM都以后缀<code>fsm</code>存储，在需要时它们会被加载到共享内存中。</p>
<blockquote>
  <h4><code>pg_freespacemap</code><span class="hx-absolute -hx-mt-20" id="pg_freespacemap"></span>
    <a href="#pg_freespacemap" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>扩展<code>pg_freespacemap</code>能提供特定表或索引上的空闲空间信息。以下查询列出了特定表中每个页面的空闲率。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">testdb</span><span class="o">=</span><span class="c1"># CREATE EXTENSION pg_freespacemap;</span>
</span></span><span class="line"><span class="cl">CREATE EXTENSION
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">testdb</span><span class="o">=</span><span class="c1"># SELECT *, round(100 * avail/8192 ,2) as &#34;freespace ratio&#34;</span>
</span></span><span class="line"><span class="cl">                FROM pg_freespace<span class="o">(</span>accounts<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> blkno <span class="p">|</span> avail <span class="p">|</span> freespace ratio 
</span></span><span class="line"><span class="cl">-------+-------+-----------------
</span></span><span class="line"><span class="cl">     <span class="m">0</span> <span class="p">|</span>  <span class="m">7904</span> <span class="p">|</span>           96.00
</span></span><span class="line"><span class="cl">     <span class="m">1</span> <span class="p">|</span>  <span class="m">7520</span> <span class="p">|</span>           91.00
</span></span><span class="line"><span class="cl">     <span class="m">2</span> <span class="p">|</span>  <span class="m">7136</span> <span class="p">|</span>           87.00
</span></span><span class="line"><span class="cl">     <span class="m">3</span> <span class="p">|</span>  <span class="m">7136</span> <span class="p">|</span>           87.00
</span></span><span class="line"><span class="cl">     <span class="m">4</span> <span class="p">|</span>  <span class="m">7136</span> <span class="p">|</span>           87.00
</span></span><span class="line"><span class="cl">     <span class="m">5</span> <span class="p">|</span>  <span class="m">7136</span> <span class="p">|</span>           87.00
</span></span><span class="line"><span class="cl">....</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</blockquote>
<h2>5.4 提交日志（clog）<span class="hx-absolute -hx-mt-20" id="54-提交日志clog"></span>
    <a href="#54-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97clog" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>PostgreSQL在<strong>提交日志（Commit Log, clog）<strong>中保存事务的状态。提交日志（通常称为</strong>clog</strong>）分配于共享内存中，并用于事务处理过程的全过程。</p>
<p>本节将介绍PostgreSQL中事务的状态，clog的工作方式与维护过程。</p>
<h3>5.4.1 事务状态<span class="hx-absolute -hx-mt-20" id="541-事务状态"></span>
    <a href="#541-%e4%ba%8b%e5%8a%a1%e7%8a%b6%e6%80%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>PostgreSQL定义了四种事务状态，即：<code>IN_PROGRESS</code>，<code>COMMITTED</code>，<code>ABORTED</code>和<code>SUB_COMMITTED</code>。</p>
<p>前三种状态涵义显而易见。例如当事务正在进行时，其状态为<code>IN_PROGRESS</code>，依此类推。</p>
<p><code>SUB_COMMITTED</code>状态用于子事务，本文省略了与子事务相关的描述。</p>
<h3>5.4.2 提交日志如何工作<span class="hx-absolute -hx-mt-20" id="542-提交日志如何工作"></span>
    <a href="#542-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>提交日志（下称clog）在逻辑上是一个数组，由共享内存中一系列8KB页面组成。数组的序号索引对应着相应事务的标识，而其内容则是相应事务的状态。clog的工作方式如图5.7所示。</p>
<p><strong>图5.7 clog如何工作</strong></p>
<p><img src="/img/fig-5-07.png" alt="" loading="lazy" /></p>
<blockquote>
  <p><strong>T1</strong>：<code>txid 200</code>提交；<code>txid 200</code>的状态从<code>IN_PROGRESS</code>变为<code>COMMITTED</code>。
<strong>T2</strong>：<code>txid 201</code>中止；<code>txid 201</code>的状态从<code>IN_PROGRESS</code>变为<code>ABORTED</code>。</p>
</blockquote>
<p><code>txid</code>不断前进，当clog空间耗尽无法存储新的事务状态时，就会追加分配一个新的页面。</p>
<p>当需要获取事务的状态时，PostgreSQL将调用相应内部函数读取clog，并返回所请求事务的状态。（参见第5.7.1节中的<strong>提示位（Hint Bits）</strong>）</p>
<h3>5.4.3 提交日志的维护<span class="hx-absolute -hx-mt-20" id="543-提交日志的维护"></span>
    <a href="#543-%e6%8f%90%e4%ba%a4%e6%97%a5%e5%bf%97%e7%9a%84%e7%bb%b4%e6%8a%a4" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>当PostgreSQL关机或执行存档过程时，clog数据会写入至<code>pg_clog</code>子目录下的文件中（注意在10版本中，<code>pg_clog</code>被重命名为<code>pg_xact</code>）。这些文件被命名为<code>0000</code>，<code>0001</code>等等。文件的最大尺寸为256 KB。例如当clog使用八个页面时，从第一页到第八页的总大小为64 KB，这些数据会写入到文件<code>0000</code>（64 KB）中；而当clog使用37个页面时（296 KB），数据则会写入到<code>0000</code>和<code>0001</code>两个文件中，其大小分别为256 KB和40 KB。</p>
<p>当PostgreSQL启动时会加载存储在<code>pg_clog</code>（<code>pg_xact</code>）中的文件，用其数据初始化clog。</p>
<p>clog的大小会不断增长，因为只要clog一填满就会追加新的页面。但并非所有数据都是必需的。<a href="/ch6" >第6章</a>中描述的清理过程会定期删除这些不需要的旧数据（clog页面和文件），有关删除clog数据的详情请参见第6.4节。</p>
<h2>5.5 事务快照<span class="hx-absolute -hx-mt-20" id="55-事务快照"></span>
    <a href="#55-%e4%ba%8b%e5%8a%a1%e5%bf%ab%e7%85%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>**事务快照（transaction snapshot）**是一个数据集，存储着某个特定事务在某个特定时间点所看到的事务状态信息：哪些事务处于活跃状态。这里活跃状态意味着事务正在进行中，或还没有开始。</p>
<p>事务快照在PostgreSQL内部的文本表示格式定义为<code>100:100:</code>。举个例子，这里<code>100:100:</code>意味着<code>txid &lt; 100</code>的事务处于非活跃状态，而<code>txid ≥ 100</code>的事务处于活跃状态。下文都将使用这种便利形式来表示。如果读者还不熟悉这种形式，请参阅下文。</p>
<blockquote>
  <h3>内置函数<code>txid_current_snapshot</code>及其文本表示<span class="hx-absolute -hx-mt-20" id="内置函数txid_current_snapshot及其文本表示"></span>
    <a href="#%e5%86%85%e7%bd%ae%e5%87%bd%e6%95%b0txid_current_snapshot%e5%8f%8a%e5%85%b6%e6%96%87%e6%9c%ac%e8%a1%a8%e7%a4%ba" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>函数<code>txid_current_snapshot</code>显示当前事务的快照。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">txid_current_snapshot</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">txid_current_snapshot</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-----------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="mi">100</span><span class="p">:</span><span class="mi">104</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="mi">102</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>txid_current_snapshot</code>的文本表示是<code>xmin:xmax:xip_list</code>，各部分描述如下。</p>
<ul>
<li>
<p><strong><code>xmin</code></strong></p>
<p>最早仍然活跃的事务的<code>txid</code>。所有比它更早的事务<code>txid &lt; xmin</code>要么已经提交并可见，要么已经回滚并生成死元组。</p>
</li>
<li>
<p><strong><code>xmax</code></strong></p>
<p>第一个尚未分配的<code>txid</code>。所有<code>txid ≥ xmax</code>的事务在获取快照时尚未启动，因而其结果对当前事务不可见。</p>
</li>
<li>
<p><strong><code>xip_list</code></strong></p>
<p>获取快照时<strong>活跃事务</strong>的<code>txid</code>列表。该列表仅包括<code>xmin</code>与<code>xmax</code>之间的<code>txid</code>。</p>
<p>例如，在快照<code>100:104:100,102</code>中，<code>xmin</code>是<code>100</code>，<code>xmax</code>是<code>104</code>，而<code>xip_list</code>为<code>100,102</code>。</p>
</li>
</ul>
<p>以下显示了两个具体的示例：</p>
<p><strong>图5.8 事务快照的表示样例</strong></p>
<p><img src="/img/fig-5-08.png" alt="" loading="lazy" /></p>
<p>第一个例子是<code>100:100:</code>，如图图5.8(a)所示，此快照表示：</p>
<ul>
<li>因为<code>xmin</code>为100，因此<code>txid &lt; 100</code>的事务是非活跃的</li>
<li>因为<code>xmax</code>为100，因此<code>txid ≥ 100</code>的事务是活跃的</li>
</ul>
<p>第二个例子是<code>100:104:100,102</code>，如图5.8(b)所示，此快照表示：</p>
<ul>
<li><code>txid &lt; 100</code>的事务不活跃。</li>
<li><code>txid ≥ 104</code>的事务是活跃的。</li>
<li><code>txid</code>等于100和102的事务是活跃的，因为它们在<code>xip_list</code>中，而<code>txid</code>等于101和103的事务不活跃。</li>
</ul>
</blockquote>
<p>事务快照是由事务管理器提供的。在<code>READ COMMITTED</code>隔离级别，事务在执行每条SQL时都会获取快照；其他情况下（<code>REPEATABLE READ</code>或<code>SERIALIZABLE</code>隔离级别），事务只会在执行第一条SQL命令时获取一次快照。获取的事务快照用于元组的可见性检查，如第5.7节所述。</p>
<p>使用获取的快照进行可见性检查时，所有<strong>活跃</strong>的事务都必须被当成<code>IN PROGRESS</code>的事务等同对待，无论它们实际上是否已经提交或中止。这条规则非常重要，因为它正是<code>READ COMMITTED</code>和<code>REPEATABLE READ/SERIALIZABLE</code>隔离级别中表现差异的根本来源，我们将在接下来几节中频繁回到这条规则上来。</p>
<p>在本节的剩余部分中，我们会通过一个具体的场景来描述事务与事务管理器，如图5.9所示。</p>
<p><strong>图5.9 事务管理器与事务</strong></p>
<p><img src="/img/fig-5-09.png" alt="" loading="lazy" /></p>
<p>事务管理器始终保存着当前运行的事务的有关信息。假设三个事务一个接一个地开始，并且<code>Transaction_A</code>和<code>Transaction_B</code>的隔离级别是<code>READ COMMITTED</code>，<code>Transaction_C</code>的隔离级别是<code>REPEATABLE READ</code>。</p>
<ul>
<li>
<p>T1：
<code>Transaction_A</code>启动并执行第一条<code>SELECT</code>命令。执行第一个命令时，<code>Transaction_A</code>请求此刻的<code>txid</code>和快照。在这种情况下，事务管理器分配<code>txid=200</code>，并返回事务快照<code>200:200:</code>。</p>
</li>
<li>
<p>T2：
<code>Transaction_B</code>启动并执行第一条<code>SELECT</code>命令。事务管理器分配<code>txid=201</code>，并返回事务快照<code>200:200:</code>，因为<code>Transaction_A(txid=200)</code>正在进行中。因此无法从<code>Transaction_B</code>中看到<code>Transaction_A</code>。</p>
</li>
<li>
<p>T3：
<code>Transaction_C</code>启动并执行第一条<code>SELECT</code>命令。事务管理器分配<code>txid=202</code>，并返回事务快照<code>200:200:</code>，因此不能从<code>Transaction_C</code>中看到<code>Transaction_A</code>和<code>Transaction_B</code>。</p>
</li>
<li>
<p>T4：
<code>Transaction_A</code>已提交。事务管理器删除有关此事务的信息。</p>
</li>
<li>
<p>T5：
<code>Transaction_B</code>和<code>Transaction_C</code>执行它们各自的<code>SELECT</code>命令。</p>
<p><code>Transaction_B</code>需要一个新的事务快照，因为它使用了<code>READ COMMITTED</code>隔离等级。在这种情况下，<code>Transaction_B</code>获取新快照<code>201:201:</code>，因为<code>Transaction_A(txid=200)</code>已提交。因此<code>Transaction_A</code>的变更对<code>Transaction_B</code>可见了。</p>
<p><code>Transaction_C</code>不需要新的事务快照，因为它处于<code>REPEATABLE READ</code>隔离等级，并继续使用已获取的快照，即<code>200:200:</code>。因此，<code>Transaction_A</code>的变更仍然对<code>Transaction_C</code>不可见。</p>
</li>
</ul>
<h2>5.6 可见性检查规则<span class="hx-absolute -hx-mt-20" id="56-可见性检查规则"></span>
    <a href="#56-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5%e8%a7%84%e5%88%99" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>可见性检查规则是一组规则，用于确定一条元组是否对一个事务可见，可见性检查规则会用到元组的<code>t_xmin</code>和<code>t_xmax</code>，提交日志clog，以及已获取的事务快照。这些规则太复杂，无法详细解释，故本书只列出了理解后续内容所需的最小规则子集。在下文中省略了与子事务相关的规则，并忽略了关于<code>t_ctid</code>的讨论，比如我们不会考虑在同一个事务中对一条元组多次重复更新的情况。</p>
<p>所选规则有十条，可以分类为三种情况。</p>
<h3>5.6.1  <code>t_xmin</code>的状态为<code>ABORTED</code><span class="hx-absolute -hx-mt-20" id="561--t_xmin的状态为aborted"></span>
    <a href="#561--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%baaborted" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p><code>t_xmin</code>状态为<code>ABORTED</code>的元组始终不可见（规则1），因为插入此元组的事务已中止。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>			/* 创建元组的事务已经中止 */
Rule 1:     IF t_xmin status is ABORTED THEN
                RETURN Invisible
            END IF</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>该规则明确表示为以下数学表达式。</p>
<ul>
<li><strong>规则1</strong>： <code>If Status(t_xmin) = ABORTED ⇒ Invisible</code></li>
</ul>
<h3>5.6.2  <code>t_xmin</code>的状态为<code>IN_PROGRESS</code><span class="hx-absolute -hx-mt-20" id="562--t_xmin的状态为in_progress"></span>
    <a href="#562--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%bain_progress" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p><code>t_xmin</code>状态为<code>IN_PROGRESS</code>的元组基本上是不可见的（规则3和4），但在一个条件下除外。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>            /* 创建元组的事务正在进行中 */
            IF t_xmin status is IN_PROGRESS THEN
                /* 当前事务自己创建了本元组 */
            	IF t_xmin = current_txid THEN
                    /* 该元组没有被标记删除，则应当看见本事务自己创建的元组 */
Rule 2:             IF t_xmax = INVALID THEN 
                        RETURN Visible /* 例外，被自己创建的未删元组可见 */
Rule 3:             ELSE  
                    /* 这条元组被当前事务自己创建后又删除掉了，故不可见 */
                        RETURN Invisible
                    END IF
Rule 4:         ELSE   /* t_xmin ≠ current_txid */
                    /* 其他运行中的事务创建了本元组 */
		            RETURN Invisible
                END IF
            END IF</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如果该元组被另一个进行中的事务插入（<code>t_xmin</code>对应事务状态为<code>IN_PROGRESS</code>），则该元组显然是不可见的（规则4）。</p>
<p>如果<code>t_xmin</code>等于当前事务的<code>txid</code>（即，是当前事务插入了该元组），且<code>t_xmax ≠ 0</code>，则该元组是不可见的，因为它已被当前事务更新或删除（规则3）。</p>
<p>例外是，当前事务插入此元组且<code>t_xmax</code>无效（<code>t_xmax = 0</code>）的情况。 在这种情况下，此元组对当前事务中可见（规则2）。</p>
<ul>
<li><strong>规则2</strong>： <code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin = current_txid ∧ t_xmax = INVAILD ⇒ Visible</code></li>
<li><strong>规则3</strong>：<code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin = current_txid ∧ t_xmax ≠ INVAILD ⇒ Invisible</code></li>
<li><strong>规则4</strong>： <code>If Status(t_xmin) = IN_PROGRESS ∧ t_xmin ≠ current_txid ⇒ Invisible</code></li>
</ul>
<h3>5.6.3  <code>t_xmin</code>的状态为<code>COMMITTED</code><span class="hx-absolute -hx-mt-20" id="563--t_xmin的状态为committed"></span>
    <a href="#563--t_xmin%e7%9a%84%e7%8a%b6%e6%80%81%e4%b8%bacommitted" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p><code>t_xmin</code>状态为<code>COMMITTED</code>的元组是可见的（规则 6，8和9），但在三个条件下除外。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>            /* 创建元组的事务已经提交 */
            IF t_xmin status is COMMITTED THEN
            	/* 创建元组的事务在获取的事务快照中处于活跃状态，创建无效，不可见 */
Rule 5:         IF t_xmin is active in the obtained transaction snapshot THEN
                      RETURN Invisible
                /* 元组被删除，但删除元组的事务中止了，删除无效，可见 */
                /* 创建元组的事务已提交，且非活跃，元组也没有被标记为删除，则可见 */
Rule 6:         ELSE IF t_xmax = INVALID OR status of t_xmax is ABORTED THEN
                      RETURN Visible
                /* 元组被删除，但删除元组的事务正在进行中，分情况 */
            	ELSE IF t_xmax status is IN_PROGRESS THEN
                    /* 如果恰好是被本事务自己删除的，删除有效，不可见 */
Rule 7:             IF t_xmax =  current_txid THEN
                        RETURN Invisible
                    /* 如果是被其他事务删除的，删除无效，可见 */
Rule 8:             ELSE  /* t_xmax ≠ current_txid */
                        RETURN Visible
                    END IF
                /* 元组被删除，且删除元组的事务已经提交 */
            	ELSE IF t_xmax status is COMMITTED THEN
                    /* 删除元组的事务在获取的事务快照中处于活跃状态，删除无效，不可见 */
Rule 9:             IF t_xmax is active in the obtained transaction snapshot THEN
                        RETURN Visible
Rule 10:            ELSE /* 删除有效，可见 */
                        RETURN Invisible
                    END IF
            	 END IF
            END IF</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>规则6是显而易见的，因为<code>t_xmax</code>为<code>INVALID</code>，或者<code>t_xmax</code>对应事务已经中止，相应元组可见。三个例外条件及规则8与规则9的描述如下。</p>
<p>第一个例外情况是<code>t_xmin</code>在获取的事务快照中处于<strong>活跃</strong>状态（规则5）。在这种情况下，这条元组是不可见的，因为<code>t_xmin</code>应该被视为正在进行中（取快照时创建该元组的事务尚未提交，因此对于<code>REPEATABLE READ</code>以及更高隔离等级而言，即使在判断时创建该元组的事务已经提交，但其结果仍然不可见）。</p>
<p>第二个例外情况是<code>t_xmax</code>是当前的<code>txid</code>（规则7）。这种情况与规则3类似，此元组是不可见的，因为它已经被此事务本身更新或删除。</p>
<p>相反，如果<code>t_xmax</code>的状态是<code>IN_PROGRESS</code>并且<code>t_xmax</code>不是当前的<code>txid</code>（规则8），则元组是可见的，因为它尚未被删除（因为删除该元组的事务尚未提交）。</p>
<p>第三个例外情况是<code>t_xmax</code>的状态为<code>COMMITTED</code>，且<code>t_xmax</code>在获取的事务快照中是<strong>非活跃</strong>的（规则10）。在这种情况下该元组不可见，因为它已被另一个事务更新或删除。</p>
<p>相反，如果<code>t_xmax</code>的状态为<code>COMMITTED</code>，但<code>t_xmax</code>在获取的事务快照中处于活跃状态（规则9），则元组可见，因为<code>t_xmax</code>对应的事务应被视为正在进行中，删除尚未提交生效。</p>
<ul>
<li><strong>规则5</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Snapshot(t_xmin) = active ⇒ Invisible</code></li>
<li><strong>规则6</strong>：<code>If Status(t_xmin) = COMMITTED ∧ (t_xmax = INVALID ∨ Status(t_xmax) = ABORTED) ⇒ Visible</code></li>
<li><strong>规则7</strong>： <code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = IN_PROGRESS ∧ t_xmax = current_txid ⇒ Invisible</code></li>
<li><strong>规则8</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = IN_PROGRESS ∧ t_xmax ≠ current_txid ⇒ Visible</code></li>
<li><strong>规则9</strong>： <code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = COMMITTED ∧ Snapshot(t_xmax) = active ⇒ Visible</code></li>
<li><strong>规则10</strong>：<code>If Status(t_xmin) = COMMITTED ∧ Status(t_xmax) = COMMITTED ∧ Snapshot(t_xmax) ≠ active ⇒ Invisible</code></li>
</ul>
<h2>5.7 可见性检查<span class="hx-absolute -hx-mt-20" id="57-可见性检查"></span>
    <a href="#57-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>本节描述了PostgreSQL执行可见性检查的流程。<strong>可见性检查（Visiblity Check）</strong>，即如何为给定事务挑选堆元组的恰当版本。本节还介绍了PostgreSQL如何防止ANSI SQL-92标准中定义的异常：脏读，可重读和幻读。</p>
<h3>5.7.1 可见性检查<span class="hx-absolute -hx-mt-20" id="571-可见性检查"></span>
    <a href="#571-%e5%8f%af%e8%a7%81%e6%80%a7%e6%a3%80%e6%9f%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>图5.10中的场景描述了可见性检查的过程。</p>
<p><strong>图5.10 可见性检查场景一例</strong></p>
<p><img src="/img/fig-5-10.png" alt="" loading="lazy" /></p>
<p>在图5.10所示的场景中，SQL命令按以下时序执行。</p>
<ul>
<li>T1：启动事务<code>(txid=200)</code></li>
<li>T2：启动事务<code>(txid=201)</code></li>
<li>T3：执行<code>txid=200</code>和201的事务的<code>SELECT</code>命令</li>
<li>T4：执行<code>txid=200</code>的事务的<code>UPDATE</code>命令</li>
<li>T5：执行<code>txid=200</code>和201的事务的<code>SELECT</code>命令</li>
<li>T6：提交<code>txid=200</code>的事务</li>
<li>T7：执行<code>txid=201</code>的事务的<code>SELECT</code>命令</li>
</ul>
<p>为了简化描述，假设这里只有两个事务，即<code>txid=200</code>和<code>201</code>的事务。<code>txid=200</code>的事务的隔离级别是<code>READ COMMITTED</code>，而<code>txid=201</code>的事务的隔离级别是<code>READ COMMITTED</code>或<code>REPEATABLE READ</code>。</p>
<p>我们将研究<code>SELECT</code>命令是如何为每条元组执行可见性检查的。</p>
<p><strong>T3的<code>SELECT</code>命令：</strong></p>
<p>在T3时间点，表<code>tbl</code>中只有一条元组<code>Tuple_1</code>，按照规则6，这条元组是可见的，因此两个事务中的<code>SELECT</code>命令都返回<code>&quot;Jekyll&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 6(Tuple_1) ⇒ Status(t_xmin:199) = COMMITTED ∧ t_xmax = INVALID ⇒ Visible</code></p>
<p>创建元组<code>Tuple_1</code>的事务199已经提交，且该元组并未被标记删除，因此根据规则6，对当前事务可见。</p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Jekyll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 201
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Jekyll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>T5的<code>SELECT</code>命令</strong></p>
<p>首先来看一下由<code>txid=200</code>的事务所执行的<code>SELECT</code>命令。根据规则7，<code>Tuple_1</code>不可见，根据规则2，<code>Tuple_2</code>可见；因此该<code>SELECT</code>命令返回<code>&quot;Hyde&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 7(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = IN_PROGRESS ∧ t_xmax:200 = current_txid:200 ⇒ Invisible</code></p>
<p>创建元组<code>Tuple_1</code>的事务199已经提交，且该元组被当前事务标记删除，根据规则7，<code>Tuple_1</code>对当前事务不可见。</p>
</li>
<li>
<p><code>Rule 2(Tuple_2): Status(t_xmin:200) = IN_PROGRESS ∧ t_xmin:200 = current_txid:200 ∧ t_xmax = INVAILD ⇒ Visible</code></p>
<p>创建元组<code>Tuple_2</code>的事务200正在进行，而且就是当前事务自己，根据规则2，<code>Tuple_2</code>对当前事务可见。</p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Hyde</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>另一方面，在由<code>txid=201</code>的事务所执行的<code>SELECT</code>命令中，<code>Tuple_1</code>基于规则8确定可见，而<code>Tuple_2</code>基于规则4不可见；因此该<code>SELECT</code>命令返回<code>&quot;Jekyll&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 8(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = IN_PROGRESS ∧ t_xmax:200 ≠ current_txid:201 ⇒ Visible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由活跃事务200标记删除，但删除效果对当前事务201不可见。因此根据规则8，<code>Tuple_1</code>可见。</p>
</li>
<li>
<p><code>Rule 4(Tuple_2): Status(t_xmin:200) = IN_PROGRESS ∧ t_xmin:200 ≠ current_txid:201 ⇒ Invisible</code></p>
<p>元组<code>Tuple_2</code>由活跃事务200创建，且不是由当前事务自己创建的，故根据规则4，<code>Tuple_2</code>不可见。</p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 201
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Jekyll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如果更新的元组在本事务提交之前被其他事务看见，这种现象被称为<strong>脏读（Dirty Reads）</strong>，也称为<strong>写读冲突（wr-conflicts）</strong>。 但如上所示，PostgreSQL中任何隔离级别都不会出现脏读。</p>
<p><strong>T7的<code>SELECT</code>命令</strong></p>
<p>在下文中，描述了T7的<code>SELECT</code>命令在两个隔离级别中的行为。</p>
<p>首先来研究<code>txid=201</code>的事务处于<code>READ COMMITTED</code>隔离级别时的情况。 在这种情况下，<code>txid=200</code>的事务被视为已提交，因为在这个时间点获取的事务快照是<code>201:201:</code>。因此<code>Tuple_1</code>根据规则10不可见，<code>Tuple_2</code>根据规则6可见，<code>SELECT</code>命令返回<code>&quot;Hyde&quot;</code>。</p>
<ul>
<li>
<p><code>Rule 10(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = COMMITTED ∧ Snapshot(t_xmax:200) ≠ active ⇒ Invisible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由非活跃的已提交事务200标记删除，<code>Tuple_1</code>按照规则10不可见。</p>
</li>
<li>
<p><code>Rule 6(Tuple_2): Status(t_xmin:200) = COMMITTED ∧ t_xmax = INVALID ⇒ Visible</code></p>
<p>元组<code>Tuple_2</code>由已提交事务200创建，且未被标记为删除，故<code>Tuple_2</code>按照规则6可见。</p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 201 (READ COMMITTED)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Hyde</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这里需要注意，事务201中的<code>SELECT</code>命令，在<code>txid=200</code>的事务提交前后中时的执行结果是不一样的，这种现象通常被称作<strong>不可重复读（Non-Repeatable Read）</strong>。</p>
<p>相反的是，当<code>txid=201</code>的事务处于<code>REPEATABLE READ</code>级别时，即使在T7时刻<code>txid=200</code>的事务实际上已经提交，它也必须被视作仍在进行，因而获取到的事务快照是<code>200:200:</code>。 根据规则9，<code>Tuple_1</code>是可见的，根据规则5，<code>Tuple_2</code>不可见，所以最后<code>SELECT</code>命令会返回<code>&quot;Jekyll&quot;</code>。 请注意在<code>REPEATABLE READ</code>（和<code>SERIALIZABLE</code>）级别中不会发生不可重复读。</p>
<ul>
<li>
<p><code>Rule9(Tuple_1): Status(t_xmin:199) = COMMITTED ∧ Status(t_xmax:200) = COMMITTED ∧ Snapshot(t_xmax:200) = active ⇒ Visible</code></p>
<p>元组<code>Tuple_1</code>由已提交事务199创建，由已提交事务200标记删除，但因为事务200位于当前事物的活跃事务快照中（也就是在当前事物201开始执行并获取事务级快照时，事物200还未提交），因此删除对当前事务尚未生效，根据规则9，<code>Tuple_1</code>可见。</p>
<p><code>Tuple_1</code>按照规则10不可见。</p>
</li>
<li>
<p><code>Rule5(Tuple_2): Status(t_xmin:200) = COMMITTED ∧ Snapshot(t_xmin:200) = active ⇒ Invisible</code></p>
<p>元组<code>Tuple_2</code>由已提交事务200创建，但该事务在本事务快照中属于活跃事务（即在本事务开始前还未提交），因此事务200的变更对本事务尚不可见，按照规则5，<code>Tuple_2</code>不可见。</p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- txid 201 (REPEATABLE READ)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">name</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Jekyll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<blockquote>
  <h4>提示位（Hint Bits）<span class="hx-absolute -hx-mt-20" id="提示位hint-bits"></span>
    <a href="#%e6%8f%90%e7%a4%ba%e4%bd%8dhint-bits" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>PostgreSQL在内部提供了三个函数<code>TransactionIdIsInProgress</code>，<code>TransactionIdDidCommit</code>和<code>TransactionIdDidAbort</code>，用于获取事务的状态。这些函数被设计为尽可能减少对clog的频繁访问。 尽管如此，如果在检查每条元组时都执行这些函数，那这里很可能会成为一个性能瓶颈。</p>
<p>为了解决这个问题，PostgreSQL使用了<strong>提示位（hint bits）</strong>，如下所示。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="n">define</span><span class="w"> </span><span class="n">HEAP_XMIN_COMMITTED</span><span class="w">       </span><span class="mi">0</span><span class="n">x0100</span><span class="w">   </span><span class="cm">/* 元组xmin对应事务已提交 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">define</span><span class="w"> </span><span class="n">HEAP_XMIN_INVALID</span><span class="w">         </span><span class="mi">0</span><span class="n">x0200</span><span class="w">   </span><span class="cm">/* 元组xmin对应事务无效/中止 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">define</span><span class="w"> </span><span class="n">HEAP_XMAX_COMMITTED</span><span class="w">       </span><span class="mi">0</span><span class="n">x0400</span><span class="w">   </span><span class="cm">/* 元组xmax对应事务已提交 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="n">define</span><span class="w"> </span><span class="n">HEAP_XMAX_INVALID</span><span class="w">         </span><span class="mi">0</span><span class="n">x0800</span><span class="w">   </span><span class="cm">/* 元组xmax对应事务无效/中止 */</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在读取或写入元组时，PostgreSQL会择机将提示位设置到元组的<code>t_informask</code>字段中。 举个例子，假设PostgreSQL检查了元组的<code>t_xmin</code>对应事务的状态，结果为<code>COMMITTED</code>。 在这种情况下，PostgreSQL会在元组的<code>t_infomask</code>中置位一个<code>HEAP_XMIN_COMMITTED</code>标记，表示创建这条元组的事务已经提交了。 如果已经设置了提示位，则不再需要调用<code>TransactionIdDidCommit</code>和<code>TransactionIdDidAbort</code>来获取事务状态了。 因此PostgreSQL能高效地检查每个元组<code>t_xmin</code>和<code>t_xmax</code>对应事务的状态。</p>
</blockquote>
<h3>5.7.2 PostgreSQL可重复读等级中的幻读<span class="hx-absolute -hx-mt-20" id="572-postgresql可重复读等级中的幻读"></span>
    <a href="#572-postgresql%e5%8f%af%e9%87%8d%e5%a4%8d%e8%af%bb%e7%ad%89%e7%ba%a7%e4%b8%ad%e7%9a%84%e5%b9%bb%e8%af%bb" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>ANSI SQL-92标准中定义的<code>REPEATABLE READ</code>隔离等级允许出现<strong>幻读（Phantom Reads）</strong>， 但PostgreSQL实现的<code>REPEATABLE READ</code>隔离等级不允许发生幻读。 在原则上，快照隔离中不允许出现幻读。</p>
<p>假设两个事务<code>Tx_A</code>和<code>Tx_B</code>同时运行。 它们的隔离级别分别为<code>READ COMMITTED</code>和<code>REPEATABLE READ</code>，它们的<code>txid</code>分别为100和101。两个事务一前一后接连开始，首先<code>Tx_A</code>插入一条元组，并提交。 插入的元组的<code>t_xmin</code>为100。接着，<code>Tx_B</code>执行<code>SELECT</code>命令；但根据规则5，<code>Tx_A</code>插入的元组对<code>Tx_B</code>是不可见的。因此不会发生幻读。</p>
<ul>
<li>
<p><code>Rule5(new tuple): Status(t_xmin:100) = COMMITTED ∧ Snapshot(t_xmin:100) = active ⇒ Invisible</code></p>
<p>新元组由已提交的事务<code>Tx_A</code>创建，但<code>Tx_A</code>在<code>Tx_B</code>的事务快照中处于活跃状态，因此根据规则5，新元组对<code>Tx_B</code>不可见。</p>
<table>
  <thead>
      <tr>
          <th><code>Tx_A: txid = 100</code></th>
          <th><code>Tx_B: txid = 101</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
          <td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
      </tr>
      <tr>
          <td><code>INSERT tbl(id, data) </code></td>
          <td></td>
      </tr>
      <tr>
          <td><code>COMMIT;</code></td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td><code>SELECT * FROM tbl WHERE id=1;</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>(0 rows)</code></td>
      </tr>
      <tr>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<h2>5.8 防止丢失更新<span class="hx-absolute -hx-mt-20" id="58-防止丢失更新"></span>
    <a href="#58-%e9%98%b2%e6%ad%a2%e4%b8%a2%e5%a4%b1%e6%9b%b4%e6%96%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h2></li>
</ul>
<p><strong>丢失更新（Lost Update）</strong>，又被称作<strong>写-写冲突（ww-conflict）</strong>，是事务并发更新同一行时所发生的异常，<code>REPEATABLE READ</code>和<code>SERIALIZABLE</code>隔离等级必须阻止该异常的出现。 本节将会介绍PostgreSQL是如何防止丢失更新的，并举一些例子来说明。</p>
<h3>5.8.1 并发<code>UPDATE</code>命令的行为<span class="hx-absolute -hx-mt-20" id="581-并发update命令的行为"></span>
    <a href="#581-%e5%b9%b6%e5%8f%91update%e5%91%bd%e4%bb%a4%e7%9a%84%e8%a1%8c%e4%b8%ba" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>执行<code>UPDATE</code>命令时，内部实际上调用了<code>ExecUpdate</code>函数。 <code>ExecUpdate</code>的伪代码如下所示：</p>
<blockquote>
  <h5>伪代码：<code>ExecUpdate</code><span class="hx-absolute -hx-mt-20" id="伪代码execupdate"></span>
    <a href="#%e4%bc%aa%e4%bb%a3%e7%a0%81execupdate" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>(1) FOR row in 本UPDATE命令待更新的所有行集
(2)     WHILE true
            /* 第一部分 */
(3)         IF 目标行 正在 被更新 THEN
(4)	            等待 更新目标行的事务 结束(提交或中止)

(5)	            IF (更新目标行的事务已提交)
   	                AND (当前事务隔离级别是 可重复读或可串行化) THEN
(6)	                    中止当前事务  /* 以先更新者为准 */
	            ELSE 
(7)                     跳转步骤（2）
	            END IF

            /* 第二部分 */
(8)         ELSE IF 目标行 已经 被另一个并发事务所更新 THEN
(9)	            IF (当前事务的隔离级别是 读已提交 ) THEN
(10)	            更新目标行
	            ELSE
(11)	            中止当前事务  /* 先更新者为准 */
                END IF

            /* 第三部分 */
            /* 目标行没有被修改过，或者被一个 已经结束 的事务所更新 */
            ELSE  
(12)	            更新目标行
            END IF
        END WHILE 
    END FOR </code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ol>
<li>获取被本<code>UPDATE</code>命令更新的每一行，并对每一行依次执行下列操作。</li>
<li>重复以下过程，直到目标行更新完成，或本事务中止。</li>
<li>如果目标行<strong>正在</strong>被更新则进入步骤（4），否则进入步骤（8）。</li>
<li>等待正在更新目标行的事务结束，因为PostgreSQL在SI中使用了**以先更新者为准（first-updater-win）**的方案。</li>
<li>如果更新目标行的事务已经提交，且当前事务的隔离等级为可重复读或可串行化则进入步骤（6），否则进入步骤（7）。</li>
<li>中止本事务，以防止丢失更新。（因为另一个事务已经对目标行进行了更新并提交）</li>
<li>跳转回步骤（2），并对目标行进行新一轮的更新尝试。</li>
<li>如果目标行<strong>已被</strong>另一个<strong>并发</strong>事务所更新则进入步骤（9），否则进入步骤（12）。</li>
<li>如果当前事务的隔离级别为<strong>读已提交</strong>则进入步骤（10），否则进入步骤（11）。</li>
<li>更新目标行，并回到步骤（1），处理下一条目标行。</li>
<li>中止当前事务，以防止丢失更新。</li>
<li>更新目标行，并回到步骤（1），因为目标行尚未被修改过，或者虽然已经被更新，但更新它的事务已经结束。已终止的事务更新，即存在写写冲突。</li>
</ol>
</blockquote>
<p>此函数依次为每个待更新的目标行执行更新操作。 它有一个外层循环来更新每一行，而内部while循环则包含了三个分支，分支条件如图5.11所示。</p>
<p><strong>图5.11 <code>ExecUpdate</code>内部的三个部分</strong></p>
<p><img src="/img/fig-5-11.png" alt="Fig. 5.11. Three internal blocks in ExecUpdate." loading="lazy" /></p>
<ol>
<li>
<p>目标行正在被更新，如图5.11[1]所示</p>
<p>“正在被更新”意味着该行正在被另一个事务同时更新，且另一个事务尚未结束。在这种情况下，当前事务必须等待更新目标行的事务结束，因为PostgreSQL的SI实现采用**以先更新者为准（first-updater-win）**的方案。例如，假设事务<code>Tx_A</code>和<code>Tx_B</code>同时运行，且<code>Tx_B</code>尝试更新某一行；但<code>Tx_A</code>已更新了这一行，且仍在进行中。在这种情况下<code>Tx_B</code>会等待<code>Tx_A</code>结束。</p>
<p>在更新目标行的事务提交后，当前事务的更新操作将完成等待继续进行。如果当前事务处于<code>READ COMMITTED</code>隔离等级，则会更新目标行；而若处于<code>REPEATABLE READ</code>或<code>SERIALIZABLE</code>隔离等级时，当前事务则会立即中止，以防止丢失更新。</p>
</li>
<li>
<p>目标行<strong>已经</strong>被另一个并发事务所更新，如图5.11[2]所示</p>
<p>当前事务尝试更新目标元组，但另一个并发事务已经更新了目标行并提交。在这种情况下，如果当前事务处于<code>READ COMMITTED</code>级别，则会更新目标行；否则会立即中止以防止丢失更新。</p>
</li>
<li>
<p>没有冲突，如图5.11[3]所示</p>
<p>当没有冲突时，当前事务可以直接更新目标行。</p>
</li>
</ol>
<blockquote>
  <h5>以先更新者为准 / 以先提交者为准<span class="hx-absolute -hx-mt-20" id="以先更新者为准--以先提交者为准"></span>
    <a href="#%e4%bb%a5%e5%85%88%e6%9b%b4%e6%96%b0%e8%80%85%e4%b8%ba%e5%87%86--%e4%bb%a5%e5%85%88%e6%8f%90%e4%ba%a4%e8%80%85%e4%b8%ba%e5%87%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h5><p>PostgreSQL基于SI的并发控制机制采用**以先更新者为准（first-updater-win）<strong>方案。 相反如下一节所述，PostgreSQL的SSI实现使用</strong>以先提交者为准（first-commiter-win）**方案。</p>
</blockquote>
<h3>5.8.2 例子<span class="hx-absolute -hx-mt-20" id="582-例子"></span>
    <a href="#582-%e4%be%8b%e5%ad%90" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>以下是三个例子。 第一个和第二个例子展示了目标行<strong>正在</strong>被更新时的行为，第三个例子展示了目标行已经被更新的行为。</p>
<h4>例1<span class="hx-absolute -hx-mt-20" id="例1"></span>
    <a href="#%e4%be%8b1" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>事务<code>Tx_A</code>和<code>Tx_B</code>更新同一张表中的同一行，它们的隔离等级均为<code>READ COMMITTED</code>。</p>
<table>
  <thead>
      <tr>
          <th><code>Tx_A</code></th>
          <th><code>Tx_B</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>START TRANSACTION</code></em></td>
          <td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>START TRANSACTION</code></em></td>
      </tr>
      <tr>
          <td><code>UPDATE tbl SET name = 'Hyde';</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>UPDATE 1</code></em></td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td><code>UPDATE tbl SET name = 'Utterson';</code></td>
      </tr>
      <tr>
          <td></td>
          <td>↓ <em>&ndash; 本事务进入阻塞状态，等待<code>Tx_A</code>完成</em></td>
      </tr>
      <tr>
          <td><code>COMMIT;</code></td>
          <td>↓ <em>&ndash; <code>Tx_A</code>提交，阻塞解除</em></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>UPDATE 1</code></em></td>
      </tr>
  </tbody>
</table>
<p><code>Tx_B</code>的执行过程如下：</p>
<ol>
<li>在执行<code>UPDATE</code>命令之后，<code>Tx_B</code>应该等待<code>Tx_A</code>结束，因为目标元组正在被<code>Tx_A</code>更新（<code>ExecUpdate</code>步骤4）</li>
<li>在<code>Tx_A</code>提交后，<code>Tx_B</code>尝试更新目标行（<code>ExecUpdate</code>步骤7）</li>
<li>在<code>ExecUpdate</code>内循环第二轮中，目标行被<code>Tx_B</code>更新（<code>ExecUpdate</code>步骤2,8,9,10）。</li>
</ol>
<h4>例2<span class="hx-absolute -hx-mt-20" id="例2"></span>
    <a href="#%e4%be%8b2" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p><code>Tx_A</code>和<code>Tx_B</code>更新同一张表中的同一行，它们的隔离等级分别为读已提交和可重复读。</p>
<table>
  <thead>
      <tr>
          <th><code>Tx_A</code></th>
          <th><code>Tx_B</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>START TRANSACTION</code></em></td>
          <td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>START TRANSACTION</code></em></td>
      </tr>
      <tr>
          <td><code>UPDATE tbl SET name = 'Hyde';</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>UPDATE 1</code></em></td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td><code>UPDATE tbl SET name = 'Utterson';</code></td>
      </tr>
      <tr>
          <td></td>
          <td>↓ <em>&ndash; 本事务进入阻塞状态，等待<code>Tx_A</code>完成</em></td>
      </tr>
      <tr>
          <td><code>COMMIT;</code></td>
          <td>↓ <em>&ndash; <code>Tx_A</code>提交，阻塞解除</em></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>ERROR:couldn't serialize access due to concurrent update</code></em></td>
      </tr>
  </tbody>
</table>
<p><code>Tx_B</code>的执行过程如下：</p>
<ol>
<li><code>Tx_B</code>在执行<code>UPDATE</code>命令后阻塞，等待<code>Tx_A</code>终止（<code>ExecUpdate</code>步骤4）。</li>
<li>当<code>Tx_A</code>提交后，<code>Tx_B</code>会中止以解决冲突。因为目标行已经被更新，且当前事务<code>Tx_B</code>的隔离级别为可重复读（<code>ExecUpdate</code>步骤5，6）。</li>
</ol>
<h4>例3<span class="hx-absolute -hx-mt-20" id="例3"></span>
    <a href="#%e4%be%8b3" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p><code>Tx_B</code>（可重复读）尝试更新已经被<code>Tx_A</code>更新的目标行，且<code>Tx_A</code>已经提交。 在这种情况下，<code>Tx_B</code>会中止（<code>ExecUpdate</code>中的步骤2,8,9,11）。</p>
<table>
  <thead>
      <tr>
          <th><code>Tx_A</code></th>
          <th><code>Tx_B</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>START TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>START TRANSACTION</code></em></td>
          <td><code>START TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>START TRANSACTION</code></em></td>
      </tr>
      <tr>
          <td><code>UPDATE tbl SET name = 'Hyde';</code></td>
          <td></td>
      </tr>
      <tr>
          <td><em><code>UPDATE 1</code></em></td>
          <td></td>
      </tr>
      <tr>
          <td><code>COMMIT;</code></td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td><code>UPDATE tbl SET name = 'Utterson';</code></td>
      </tr>
      <tr>
          <td></td>
          <td><em><code>ERROR:couldn't serialize access due to concurrent update</code></em></td>
      </tr>
  </tbody>
</table>
<h2>5.9 可串行化快照隔离<span class="hx-absolute -hx-mt-20" id="59-可串行化快照隔离"></span>
    <a href="#59-%e5%8f%af%e4%b8%b2%e8%a1%8c%e5%8c%96%e5%bf%ab%e7%85%a7%e9%9a%94%e7%a6%bb" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>从版本9.1开始，可串行化快照隔离（SSI）已经嵌入到快照隔离（SI）中，用以实现真正的可串行化隔离等级。SSI解释起来过于复杂，故本书仅解释其概要，详细信息请参阅文献[2]。</p>
<p>下文使用了以下技术术语而未加定义。 如果读者不熟悉这些术语，请参阅[1,3]。</p>
<ul>
<li><strong>前趋图（precedence graph）</strong>，亦称作<strong>依赖图（dependency graph）<strong>或</strong>串行化图（serialization graph）</strong></li>
<li><strong>串行化异常（serialization anomalies）</strong>（例如，<strong>写偏差（Write-Skew）</strong>）</li>
</ul>
<h3>5.9.1 SSI实现的基本策略<span class="hx-absolute -hx-mt-20" id="591-ssi实现的基本策略"></span>
    <a href="#591-ssi%e5%ae%9e%e7%8e%b0%e7%9a%84%e5%9f%ba%e6%9c%ac%e7%ad%96%e7%95%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>如果前趋图中存在由某些冲突构成的环，则会出现串行化异常。 这里使用一种最简单的异常来解释，即<strong>写偏差（Write-Skew）</strong>。</p>
<p>图5.12(1)展示了一种调度方式。 这里<code>Transaction_A</code>读取了<code>Tuple_B</code>，<code>Transaction_B</code>读取了<code>Tuple_A</code>。 然后<code>Transaction_A</code>写<code>Tuple_A</code>，<code>Transaction_B</code>写<code>Tuple_B</code>。 在这种情况下存在两个<strong>读-写冲突（rw-conflict）</strong>，它们在该调度的前趋图中构成了一个环，如图5.12(2)所示。 故该调度存在串行化异常，即写偏差。</p>
<p><strong>图5.12 存在写偏差的调度及其前趋图</strong></p>
<p><img src="/img/fig-5-12.png" alt="Fig. 5.11. Three internal blocks in ExecUpdate." loading="lazy" /></p>
<p>从概念上讲，存在三种类型的冲突：<strong>写-读冲突（wr-conflicts）</strong>（脏读），<strong>写-写冲突（ww-conflicts）</strong>（丢失更新），以及<strong>读写冲突（rw-conflicts）</strong>。 但是这里无需考虑写-读冲突与写-写冲突，因为如前所述，PostgreSQL可以防止此类冲突。 因此PostgreSQL中的SSI实现只需要考虑读-写冲突。</p>
<p>PostgreSQL在SSI实现中采用以下策略：</p>
<ol>
<li>使用SIREAD锁记录事务访问的所有对象（元组，页面，关系）。</li>
<li>当写入任何堆元组/索引元组时，使用SIREAD锁检测读-写冲突。</li>
<li>如果从读-写冲突中检测出串行化异常，则中止事务。</li>
</ol>
<h3>5.9.2 PostgreSQL的SSI实现<span class="hx-absolute -hx-mt-20" id="592-postgresql的ssi实现"></span>
    <a href="#592-postgresql%e7%9a%84ssi%e5%ae%9e%e7%8e%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>为了实现上述策略，PostgreSQL实现了很多数据结构与函数。 但这里我们只会使用两种数据结构：SIREAD锁与读-写冲突来描述SSI机制。它们都储存在共享内存中。</p>
<blockquote>
  <p>为简单起见，本文省略了一些重要的数据结构，例如<code>SERIALIZABLEXACT</code>。 因此对<code>CheckTargetForConflictOut</code>，<code>CheckTargetForConflictIn</code>和<code>PreCommit_CheckForSerializationFailure</code>等函数的解释也极为简化。比如本文虽然指出哪些函数能检测到冲突；但并没有详细解释如何检测冲突。 如果读者想了解详细信息，请参阅源代码：<a href="https://github.com/postgres/postgres/blob/master/src/backend/storage/lmgr/predicate.c" target="_blank" rel="noopener">predicate.c</a>。</p>
</blockquote>
<h4>SIREAD锁<span class="hx-absolute -hx-mt-20" id="siread锁"></span>
    <a href="#siread%e9%94%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>SIREAD锁，在内部又被称为<strong>谓词锁（predicate lock）</strong>，是一个由对象与（虚拟）事务标识构成的二元组，存储着哪个事务访问了哪个对象的相关信息。注意这里省略了对虚拟事务标识的描述，使用<code>txid</code>而非虚拟<code>txid</code>能大幅简化说明。</p>
<p>在<code>SERIALIZABLE</code>模式下只要执行DML命令，就会通过<code>CheckTargetForConflictsOut</code>函数创建出SIREAD锁。举个例子，如果<code>txid=100</code>的事务读取给定表的<code>Tuple_1</code>，则会创建一个SIREAD锁<code>{Tuple_1,{100}}</code>。如果是其他事务，例如<code>txid=101</code>读取了<code>Tuple_1</code>，则SIREAD锁会更新为<code>{Tuple_1,{100,101}}</code>。请注意，读取索引页时也会创建SIREAD锁，因为在使用了第7.2节中将描述的**仅索引扫描（Index-Only Scan）**时，数据库只会读取索引页而不读取表页。</p>
<p>SIREAD锁有三个级别：元组，页面，以及关系。如果单个页面内所有元组的SIREAD锁都被创建，则它们会聚合为该页上的单个SIREAD锁，原有相关元组上的SIREAD锁都会被释放（删除），以减少内存空间占用。对读取的页面也是同理。</p>
<p>当为索引创建SIREAD锁时，一开始会创建页级别的SIREAD锁。当使用顺序扫描时，无论是否存在索引，是否存在<code>WHERE</code>子句，一开始都会创建关系级别的SIREAD锁。请注意在某些情况下，这种实现可能会导致串行化异常的误报（<strong>假阳性（false-positive）</strong>），细节将在第5.9.4节中描述。</p>
<h4>读-写冲突<span class="hx-absolute -hx-mt-20" id="读-写冲突"></span>
    <a href="#%e8%af%bb-%e5%86%99%e5%86%b2%e7%aa%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>读-写冲突是一个三元组，由SIREAD锁，以及两个分别读写该SIREAD锁的事务<code>txid</code>构成。</p>
<p>当在可串行化模式下执行<code>INSERT</code>，<code>UPDATE</code>或<code>DELETE</code>命令时，函数<code>CheckTargetForConflictsIn</code>会被调用，并检查SIREAD锁来检测是否存在冲突，如果有就创建一个读-写冲突。</p>
<p>举个例子，假设<code>txid = 100</code>的事务读取了<code>Tuple_1</code>，然后<code>txid=101</code>的事务更新了<code>Tuple_1</code>。在这种情况下，<code>txid=101</code>的事务中的<code>UPDATE</code>命令会调用<code>CheckTargetForConflictsIn</code>函数，并检测到在<code>Tuple_1</code>上存在<code>txid=100,101</code>之间的读-写冲突，并创建<code>rw-conflict{r = 100, w = 101, {Tuple_1}}</code>。</p>
<p><code>CheckTargetForConflictOut</code>、<code>CheckTargetForConflictIn</code>函数，以及在可串行化模式中执行<code>COMMIT</code>命令会触发的<code>PreCommit_CheckForSerializationFailure</code>函数，都会使用创建的读写冲突来检查串行化异常。如果它们检测到异常，则只有先提交的事务会真正提交，其他事务会中止（依据**以先提交者为准（first-committer-win）**策略）。</p>
<h3>5.9.3 SSI的原理<span class="hx-absolute -hx-mt-20" id="593-ssi的原理"></span>
    <a href="#593-ssi%e7%9a%84%e5%8e%9f%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>本节将描述SSI如何解决写偏差异常，下面将使用一个简单的表<code>tbl</code>为例。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="n">tbl</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>事务<code>Tx_A</code>和<code>Tx_B</code>执行以下命令，如图5.13所示。</p>
<p><strong>图5.13 写偏差场景一例</strong></p>
<p><img src="/img/fig-5-13.png" alt="写偏" loading="lazy" /></p>
<p>假设所有命令都使用索引扫描。 因此当执行命令时，它们会同时读取堆元组与索引页，每个索引页都包含指向相应堆元组的索引元组，如图5.14所示。</p>
<p><strong>图5.14 例子中索引与表的关系</strong></p>
<p><img src="/img/fig-5-14.png" alt="索引和表的关系" loading="lazy" /></p>
<ul>
<li><strong>T1</strong>：<code>Tx_A</code>执行<code>SELECT</code>命令，该命令读取堆元组<code>Tuple_2000</code>，以及包含主键的索引页<code>Pkey_2</code>。</li>
<li><strong>T2</strong>：<code>Tx_B</code>执行<code>SELECT</code>命令。 此命令读取堆元组<code>Tuple_1</code>，以及包含主键的索引页<code>Pkey_1</code>。</li>
<li><strong>T3</strong>：<code>Tx_A</code>执行<code>UPDATE</code>命令，更新<code>Tuple_1</code>。</li>
<li><strong>T4</strong>：<code>Tx_B</code>执行<code>UPDATE</code>命令，更新<code>Tuple_2000</code>。</li>
<li><strong>T5</strong>：<code>Tx_A</code>提交。</li>
<li><strong>T6</strong>：<code>Tx_B</code>提交，然而由于写偏差异常而被中止。</li>
</ul>
<p>图5.15展示了PostgreSQL如何检测和解决上述场景中描述的写偏差异常。</p>
<p><strong>图5.15 SIREA锁与读-写冲突，图5.13场景中的调度方式</strong></p>
<p><img src="/img/fig-5-15.png" alt="SIREAD锁和rw-conflict" loading="lazy" /></p>
<ul>
<li>
<p><strong>T1</strong>：
执行<code>Tx_A</code>的<code>SELECT</code>命令时，<code>CheckTargetForConflictsOut</code>会创建SIREAD锁。在本例中该函数会创建两个SIREAD锁：<code>L1</code>与<code>L2</code>。<code>L1</code>和<code>L2</code>分别与<code>Pkey_2</code>和<code>Tuple_2000</code>相关联。</p>
</li>
<li>
<p><strong>T2</strong>：
执行<code>Tx_B</code>的<code>SELECT</code>命令时，<code>CheckTargetForConflictsOut</code>会创建两个SIREAD锁：<code>L3</code>和<code>L4</code>。<code>L3</code>和<code>L4</code>分别与<code>Pkey_1</code>和<code>Tuple_1</code>相关联。</p>
</li>
<li>
<p><strong>T3</strong>：
执行<code>Tx_A</code>的<code>UPDATE</code>命令时，<code>CheckTargetForConflictsOut</code>和<code>CheckTargetForConflictsIN</code>会分别在<code>ExecUpdate</code>执行前后被调用。在本例中，<code>CheckTargetForConflictsOut</code>什么都不做。而<code>CheckTargetForConflictsIn</code>则会创建读-写冲突<code>C1</code>，这是<code>Tx_B</code>和<code>Tx_A</code>在<code>Pkey_1</code>和<code>Tuple_1</code>上的冲突，因为<code>Pkey_1</code>和<code>Tuple_1</code>都由<code>Tx_B</code>读取并被<code>Tx_A</code>写入。</p>
</li>
<li>
<p><strong>T4</strong>：
执行<code>Tx_B</code>的<code>UPDATE</code>命令时，<code>CheckTargetForConflictsIn</code>会创建读-写冲突<code>C2</code>，这是<code>Tx_A</code>与<code>Tx_B</code>在<code>Pkey_2</code>和<code>Tuple_2000</code>上的冲突。</p>
<p>在这种情况下，<code>C1</code>和<code>C2</code>在前趋图中构成一个环；因此<code>Tx_A</code>和<code>Tx_B</code>处于不可串行化状态。但事务<code>Tx_A</code>和<code>Tx_B</code>都尚未提交，因此<code>CheckTargetForConflictsIn</code>不会中止<code>Tx_B</code>。注意这是因为PostgreSQL的SSI实现采用先提交者为准方案。</p>
</li>
<li>
<p><strong>T5</strong>：
当<code>Tx_A</code>尝试提交时，将调用<code>PreCommit_CheckForSerializationFailure</code>。此函数可以检测串行化异常，并在允许的情况下执行提交操作。在这里因为<code>Tx_B</code>仍在进行中，<code>Tx_A</code>成功提交。</p>
</li>
<li>
<p><strong>T6</strong>：
当<code>Tx_B</code>尝试提交时，<code>PreCommit_CheckForSerializationFailure</code>检测到串行化异常，且<code>Tx_A</code>已经提交；因此<code>Tx_B</code>被中止。</p>
</li>
</ul>
<p>此外，如果在<code>Tx_A</code>提交之后（T5时刻），<code>Tx_B</code>执行了<code>UPDATE</code>命令，则<code>Tx_B</code>会立即中止。因为<code>Tx_B</code>的<code>UPDATE</code>命令会调用<code>CheckTargetForConflictsIn</code>，并检测到串行化异常，如图5.16(1)所示。</p>
<p>如果<code>Tx_B</code>在T6时刻执行<code>SELECT</code>命令而不是<code>COMMIT</code>命令，则<code>Tx_B</code>也会立即中止。因为<code>Tx_B</code>的<code>SELECT</code>命令调用的<code>CheckTargetForConflictsOut</code>会检测到串行化异常，如图5.16(2)所示。</p>
<p><strong>图5.16 其他写偏差场景</strong></p>
<p><img src="/img/fig-5-16.png" alt="其他写偏" loading="lazy" /></p>
<blockquote>
  <p>这里的<a href="https://wiki.postgresql.org/wiki/SSI" target="_blank" rel="noopener">Wiki</a>解释了几种更为复杂的异常。</p>
</blockquote>
<h3>5.9.4 假阳性的串行化异常<span class="hx-absolute -hx-mt-20" id="594-假阳性的串行化异常"></span>
    <a href="#594-%e5%81%87%e9%98%b3%e6%80%a7%e7%9a%84%e4%b8%b2%e8%a1%8c%e5%8c%96%e5%bc%82%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>在可串行化模式下，因为永远不会检测到**假阴性（false-negative，发生异常但未检测到）**串行化异常，PostgreSQL能始终完全保证并发事务的可串行性。 但相应的是在某些情况下，可能会检测到假阳性异常（没有发生异常但误报发生），用户在使用<code>SERIALIZABLE</code>模式时应牢记这一点。 下文会描述PostgreSQL检测到假阳性异常的情况。</p>
<p>图5.17展示了发生假阳性串行化异常的情况。</p>
<p><strong>图5.17 发生假阳性串行化异常的场景</strong></p>
<p><img src="/img/fig-5-17.png" alt="假阳性串行化异常的场景" loading="lazy" /></p>
<p>当使用顺序扫描时，如SIREAD锁的解释中所述，PostgreSQL创建了一个关系级的SIREAD锁。 图5.18(1)展示了PostgreSQL使用顺序扫描时的SIREAD锁和读-写冲突。 在这种情况下，产生了与<code>tbl</code>表上SIREAD锁相关联的读-写冲突：<code>C1</code>和<code>C2</code>，并且它们在前趋图中构成了一个环。 因此会检测到假阳性的写偏差异常（即，虽然实际上没有冲突，但<code>Tx_A</code>与<code>Tx_B</code>两者之一也将被中止）。</p>
<p><strong>图 5.18 假阳性异常(1) - 使用顺序扫描</strong></p>
<p><img src="/img/fig-5-18.png" alt="使用顺序扫描" loading="lazy" /></p>
<p>即使使用索引扫描，如果事务<code>Tx_A</code>和<code>Tx_B</code>都获取里相同的索引SIREAD锁，PostgreSQL也会误报假阳性异常。 图5.19展示了这种情况。 假设索引页<code>Pkey_1</code>包含两条索引项，其中一条指向<code>Tuple_1</code>，另一条指向<code>Tuple_2</code>。 当<code>Tx_A</code>和<code>Tx_B</code>执行相应的<code>SELECT</code>和<code>UPDATE</code>命令时，<code>Pkey_1</code>同时被<code>Tx_A</code>和<code>Tx_B</code>读取与写入。 这时候会产生<code>Pkey_1</code>相关联的读-写冲突：<code>C1</code>和<code>C2</code>，并在前趋图中构成一个环，因而检测到假阳性写偏差异常（如果<code>Tx_A</code>和<code>Tx_B</code>获取不同索引页上的SIREAD锁则不会误报，并且两个事务都可以提交）。</p>
<p><strong>图5.19 假阳性异常(2) - 使用相同索引页的索引扫描</strong></p>
<p><img src="/img/fig-5-19.png" alt="使用相同索引页的索引扫描" loading="lazy" /></p>
<h2>5.10 所需的维护进程<span class="hx-absolute -hx-mt-20" id="510-所需的维护进程"></span>
    <a href="#510-%e6%89%80%e9%9c%80%e7%9a%84%e7%bb%b4%e6%8a%a4%e8%bf%9b%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>PostgreSQL的并发控制机制需要以下维护过程。</p>
<ol>
<li>删除死元组及指向死元组的索引元组</li>
<li>移除**提交日志（clog）**中非必需的部分</li>
<li>冻结旧的<strong>事务标识（txid）</strong></li>
<li>更新FSM，VM，以及统计信息</li>
</ol>
<p>第5.3.2和5.4.3节分别解释了为什么需要第一个和第二个过程。第三个过程与事务标识回卷问题有关，本小节将概述**事务标识回卷（txid wrap around）**问题。</p>
<p>在PostgreSQL中，清理过程（<strong><code>VACUUM</code></strong>）负责这些过程。**清理过程（VACUUM）**在<a href="/ch6" >第6章</a>中描述。</p>
<h3>5.10.1  冻结处理<span class="hx-absolute -hx-mt-20" id="5101--冻结处理"></span>
    <a href="#5101--%e5%86%bb%e7%bb%93%e5%a4%84%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>接下来将介绍**事务标识回卷（txid wrap around）**问题。</p>
<p>假设元组<code>Tuple_1</code>是由<code>txid = 100</code>事务创建的，即<code>Tuple_1</code>的<code>t_xmin = 100</code>。服务器运行了很长时间，但<code>Tuple_1</code>一直未曾被修改。假设<code>txid</code>已经前进到了$2^{31}+100$，这时候正好执行了一条<code>SELECT</code>命令。此时，因为对当前事务而言<code>txid = 100</code>的事务属于过去的事务，因而<code>Tuple_1</code>对当前事务可见。然后再执行相同的<code>SELECT</code>命令，此时<code>txid</code>步进至$2^{31}+101$。但因对当前事务而言，<code>txid = 100</code>的事务是属于未来的，因此<code>Tuple_1</code>不再可见（图5.20）。这就是PostgreSQL中所谓的事务回卷问题。</p>
<p><strong>图5.20 回卷问题</strong></p>
<p><img src="/img/fig-5-20.png" alt="" loading="lazy" /></p>
<p>为了解决这个问题，PostgreSQL引入了一个**冻结事务标识（Frozen txid）**的概念，并实现了一个名为<code>FREEZE</code>的过程。</p>
<p>在PostgreSQL中定义了一个冻结的<code>txid</code>，它是一个特殊的保留值<code>txid = 2</code>，在参与事务标识大小比较时，它总是比所有其他<code>txid</code>都旧。换句话说，冻结的<code>txid</code>始终处于<strong>非活跃状态</strong>，且其结果对其他事务始终可见。</p>
<p><strong>清理过程（<code>VACUUM</code>）<strong>会调用冻结过程（</strong><code>FREEZE</code></strong>）。冻结过程将扫描所有表文件，如果元组的<code>t_xmin</code>比当前<code>txid - vacuum_freeze_min_age</code>（默认值为5000万）更老，则将该元组的<code>t_xmin</code>重写为冻结事务标识。在<a href="/ch6" >第6章</a>中会有更详细的解释。</p>
<p>举个例子，如图5.21(a)所示，当前<code>txid</code>为5000万，此时通过<code>VACUUM</code>命令调用冻结过程。在这种情况下，<code>Tuple_1</code>和<code>Tuple_2</code>的<code>t_xmin</code>都被重写为2。</p>
<p>在版本9.4或更高版本中使用元组<code>t_infomask</code>字段中的<code>XMIN_FROZEN</code>标记位来标识冻结元组，而不是将元组的<code>t_xmin</code>重写为冻结的<code>txid</code>，如图5.21(b)所示。</p>
<p><strong>图5.21 冻结过程</strong></p>
<p><img src="/img/fig-5-21.png" alt="" loading="lazy" /></p>
<h2>参考文献<span class="hx-absolute -hx-mt-20" id="参考文献"></span>
    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><ul>
<li>[1] Abraham Silberschatz, Henry F. Korth, and S. Sudarshan, &ldquo;<a href="https://www.amazon.com//dp/0073523321" target="_blank" rel="noopener">Database System Concepts</a>&rdquo;, McGraw-Hill Education, ISBN-13: 978-0073523323</li>
<li>[2] Dan R. K. Ports, and Kevin Grittner, &ldquo;<a href="https://drkp.net/papers/ssi-vldb12.pdf" target="_blank" rel="noopener">Serializable Snapshot Isolation in PostgreSQL</a>&rdquo;, VDBL 2012</li>
<li>[3] Thomas M. Connolly, and Carolyn E. Begg, &ldquo;<a href="https://www.amazon.com/dp/0321523067" target="_blank" rel="noopener">Database Systems</a>&rdquo;, Pearson, ISBN-13: 978-0321523068</li>
</ul>

        </div>
        <div class="hx-mt-16"></div>
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/ch4/"
        title="4. 外部数据包装器与并行查询"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-pr-4 rtl:hx-pl-4"
      ><svg class="hx-inline hx-h-5 hx-shrink-0 ltr:hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>4. 外部数据包装器与并行查询</a><a
        href="/ch6/"
        title="6. 第六章 清理过程"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-ml-auto ltr:hx-pl-4 ltr:hx-text-right rtl:hx-mr-auto rtl:hx-pr-4 rtl:hx-text-left"
      >6. 第六章 清理过程<svg class="hx-inline hx-h-5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div><div class="hx-mt-6 hx-text-xs">© 2024 Hextra.</div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>
<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/zh.search.js" integrity=""></script><link type="text/css" rel="stylesheet" href="/lib/katex/katex.min.7e5db7914b97e596a36c1abb67ccc7f174f8bb71d38c9a88c55b262ed1737f97.css" integrity="sha256-fl23kUuX5ZajbBq7Z8zH8XT4u3HTjJqIxVsmLtFzf5c=" />
<script defer src="/lib/katex/katex.min.9f45307c5794ed247a0d095f3a62e52ef2215a67b2327203a7fd919959ae79d1.js" integrity="sha256-n0UwfFeU7SR6DQlfOmLlLvIhWmeyMnIDp/2RmVmuedE="></script>
<script defer src="/lib/katex/auto-render.min.7b57d427ac6270677daf8d8380ded2cc73336f9149a167b8e1fe0d6ef66604ae.js" integrity="sha256-e1fUJ6xicGd9r42DgN7SzHMzb5FJoWe44f4NbvZmBK4="></script>
<script defer src="/lib/katex/mhchem.min.f0ca03df194b8c3d6017ff455db6a0ef98857905663fa311a6cded788b15340b.js" integrity="sha256-8MoD3xlLjD1gF/9FXbag75iFeQVmP6MRps3teIsVNAs="></script>
<script>
  
  
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\begin{equation}", right: "\\end{equation}", display: true },
        {left: "\\begin{align}", right: "\\end{align}", display: true},
        {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
        {left: "\\begin{gather}", right: "\\end{gather}", display: true},
        {left: "\\begin{CD}", right: "\\end{CD}", display: true},
        { left: "\\[", right: "\\]", display: true },
      ],
      throwOnError: false,
    });
  });
</script>

  </body>
</html>
