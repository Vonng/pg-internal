<!DOCTYPE html>
<html lang="zh"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>9. 预写式日志 – PG技术内幕</title>
  <meta name="description" content="​	事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。" /><link rel="canonical" href="http://localhost:1313/ch9/" itemprop="url" />

<meta property="og:title" content="9. 预写式日志" />
<meta property="og:description" content="​	事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/ch9/" /><meta property="article:section" content="" />



  <meta itemprop="name" content="9. 预写式日志">
  <meta itemprop="description" content="​	事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。">
  <meta itemprop="wordCount" content="18307">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="9. 预写式日志">
  <meta name="twitter:description" content="​	事务日志（transaction log）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）与行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-mr-2 hx-block dark:hx-hidden" src="/images/logo.svg" alt="PG技术内幕" height="20" width="20" />
        <img class="hx-mr-2 hx-hidden dark:hx-block" src="/images/logo-dark.svg" alt="PG技术内幕" height="20" width="20" />
        <span class="hx-mr-2 hx-font-extrabold hx-inline hx-select-none" title="PG技术内幕">PG技术内幕</span>
    </a><a
            title="Documentation"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Documentation</span>
          </a><a
            title="Versions"
            href=""
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Versions</span>
          </a><a
            title="Blog"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Blog</span>
          </a><a
            title="About"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">About</span>
          </a><a
            title="Showcase"
            href="/showcase"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">Showcase</span>
          </a><div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/imfing/hextra" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex max-w-full'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-sticky">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch3/"
    
  >3. 查询处理
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch5/"
    
  >5. 并发控制
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch9/"
    
  >9. 预写式日志
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#91-%e6%a6%82%e8%bf%b0"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.1 概述</a>
            </li>
          <li>
              <a
                href="#92-%e4%ba%8b%e5%8a%a1%e6%97%a5%e5%bf%97%e4%b8%8ewal%e6%ae%b5%e6%96%87%e4%bb%b6"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.2 事务日志与WAL段文件</a>
            </li>
          <li>
              <a
                href="#93-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.3 WAL段文件的内部布局</a>
            </li>
          <li>
              <a
                href="#94-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.4 WAL记录的内部布局</a>
            </li>
          <li>
              <a
                href="#95-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%99%e5%85%a5"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.5 WAL记录的写入</a>
            </li>
          <li>
              <a
                href="#96-wal%e5%86%99%e5%85%a5%e8%bf%9b%e7%a8%8b"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.6 WAL写入进程</a>
            </li>
          <li>
              <a
                href="#97-postgresql%e4%b8%ad%e7%9a%84%e6%a3%80%e6%9f%a5%e7%82%b9%e8%bf%87%e7%a8%8b"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.7 PostgreSQL中的检查点过程</a>
            </li>
          <li>
              <a
                href="#98-postgresql%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e6%81%a2%e5%a4%8d"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.8 PostgreSQL中的数据库恢复</a>
            </li>
          <li>
              <a
                href="#99-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.9 WAL段文件管理</a>
            </li>
          <li>
              <a
                href="#910-%e5%bd%92%e6%a1%a3%e6%97%a5%e5%bf%97%e4%b8%8e%e6%8c%81%e7%bb%ad%e5%bd%92%e6%a1%a3"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >9.10 归档日志与持续归档</a>
            </li>
          </ul>
  </li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
    </ul>

    <ul class="hx-flex hx-flex-col hx-gap-1 max-md:hx-hidden">
        
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/readme/"
    
  >PostgreSQL技术内幕
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface/"
    
  >作者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/preface2/"
    
  >译者序
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch1/"
    
  >1. 数据库集簇，数据库，数据表
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch2/"
    
  >2. 进程和内存架构
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch3/"
    
  >3. 查询处理
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch4/"
    
  >4. 外部数据包装器与并行查询
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch5/"
    
  >5. 并发控制
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch6/"
    
  >6. 第六章 清理过程
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch7/"
    
  >7. 堆内元组与仅索引扫描
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch8/"
    
  >8. 缓冲区管理器
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/ch9/"
    
  >9. 预写式日志
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch10/"
    
  >10. 基础备份与时间点恢复
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/ch11/"
    
  >11. 流复制
    </a></li>
        
      <li class="[word-break:break-word] hx-mt-5 hx-mb-2 hx-px-2 hx-py-1.5 hx-text-sm hx-font-semibold hx-text-gray-900 first:hx-mt-0 dark:hx-text-gray-100">
        <span class="hx-cursor-default">More</span>
      </li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about"
    
  >About</a></li>
    <li><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="https://gohugo.io/documentation/"
    target="_blank" rel="noreferrer"
  >Hugo Docs ↗</a></li>
    
      </ul>
    </div>
  
  
    <div class="  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#91-%e6%a6%82%e8%bf%b0">9.1 概述
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#911-%e6%b2%a1%e6%9c%89wal%e7%9a%84%e6%8f%92%e5%85%a5%e6%93%8d%e4%bd%9c">9.1.1 没有WAL的插入操作
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#912-%e6%8f%92%e5%85%a5%e6%93%8d%e4%bd%9c%e4%b8%8e%e6%95%b0%e6%8d%ae%e5%ba%93%e6%81%a2%e5%a4%8d">9.1.2 插入操作与数据库恢复
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#913-%e6%95%b4%e9%a1%b5%e5%86%99%e5%85%a5">9.1.3 整页写入
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#92-%e4%ba%8b%e5%8a%a1%e6%97%a5%e5%bf%97%e4%b8%8ewal%e6%ae%b5%e6%96%87%e4%bb%b6">9.2 事务日志与WAL段文件
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#wal%e6%ae%b5%e6%96%87%e4%bb%b6%e5%b0%ba%e5%af%b8">WAL段文件尺寸
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%97%b6%e9%97%b4%e7%ba%bf%e6%a0%87%e8%af%86">时间线标识
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#wal%e6%96%87%e4%bb%b6%e5%90%8d">WAL文件名
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#93-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80">9.3 WAL段文件的内部布局
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#94-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80">9.4 WAL记录的内部布局
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#941-wal%e8%ae%b0%e5%bd%95%e9%a6%96%e9%83%a8%e9%83%a8%e5%88%86">9.4.1 WAL记录首部部分
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#942-xlog%e8%ae%b0%e5%bd%95%e6%95%b0%e6%8d%ae%e9%83%a8%e5%88%8694%e5%8f%8a%e4%bb%a5%e5%89%8d">9.4.2 XLOG记录数据部分（9.4及以前）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#9421-%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97">9.4.2.1 备份区块
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#9422-%e9%9d%9e%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97">9.4.2.2 非备份区块
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#943-xlog%e8%ae%b0%e5%bd%95%e6%95%b0%e6%8d%ae%e9%83%a8%e5%88%8695%e5%8f%8a%e5%90%8e%e7%bb%ad%e7%89%88%e6%9c%ac">9.4.3 XLOG记录数据部分（9.5及后续版本）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#wal%e5%8e%8b%e7%bc%a9">WAL压缩
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#9431-%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97">9.4.3.1 备份区块
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#9432-%e9%9d%9e%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97">9.4.3.2 非备份区块
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#95-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%99%e5%85%a5">9.5 WAL记录的写入
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#96-wal%e5%86%99%e5%85%a5%e8%bf%9b%e7%a8%8b">9.6 WAL写入进程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#97-postgresql%e4%b8%ad%e7%9a%84%e6%a3%80%e6%9f%a5%e7%82%b9%e8%bf%87%e7%a8%8b">9.7 PostgreSQL中的检查点过程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#971-%e6%a3%80%e6%9f%a5%e7%82%b9%e8%bf%87%e7%a8%8b%e6%a6%82%e8%bf%b0">9.7.1 检查点过程概述
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#972-pg_crontrol%e6%96%87%e4%bb%b6">9.7.2 pg_crontrol文件
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#postgresql11%e4%b8%ad%e7%a7%bb%e9%99%a4%e4%ba%86%e5%89%8d%e4%bb%bb%e6%a3%80%e6%9f%a5%e7%82%b9">PostgreSQL11中移除了前任检查点
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#98-postgresql%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e6%81%a2%e5%a4%8d">9.8 PostgreSQL中的数据库恢复
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#99-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86">9.9 WAL段文件管理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#991-wal%e6%ae%b5%e5%88%87%e6%8d%a2">9.9.1 WAL段切换
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#992-wal%e6%ae%b5%e7%ae%a1%e7%90%8695%e7%89%88%e5%8f%8a%e4%bb%a5%e5%90%8e">9.9.2 WAL段管理（9.5版及以后）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#993-wal%e6%ae%b5%e7%ae%a1%e7%90%8694%e7%89%88%e5%8f%8a%e4%bb%a5%e5%89%8d">9.9.3 WAL段管理（9.4版及以前）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#910-%e5%bd%92%e6%a1%a3%e6%97%a5%e5%bf%97%e4%b8%8e%e6%8c%81%e7%bb%ad%e5%bd%92%e6%a1%a3">9.10 归档日志与持续归档
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400"><a class="hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50" href="https://github.com/Vonng/pg-internal/edit/main/content/ch9.md" target="_blank" rel="noreferrer">Edit this page</a>
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
        <div class="content">
          <h1>9. 预写式日志</h1>
          <p>​	事务日志（<strong>transaction log</strong>）是数据库的关键组件，因为当出现系统故障时，任何数据库管理系统都不允许丢失数据。事务日志是数据库系统中所有**变更（change）<strong>与</strong>行为（action）**的历史记录，当诸如电源故障，或其他服务器错误导致服务器崩溃时，它被用于确保数据不会丢失。由于日志包含每个已执行事务的相关充分信息，因此当服务器崩溃时，数据库服务器应能通过重放事务日志中的变更与行为来恢复数据库集群。</p>
<p>​	在计算机科学领域，WAL是<strong>Write Ahead Logging</strong>的缩写，它指的是将<strong>变更与行为写入事务日志的协议或规则</strong>；而在PostgreSQL中，WAL是<strong>Write Ahead Log</strong>的缩写。在这里它被当成事务日志的同义词，而且也用来指代一种将<strong>行为</strong>写入事务日志（WAL）的实现机制。虽然有些令人困惑， 但本文将使用PostgreSQL中的定义。</p>
<p>​	WAL机制在7.1版本中首次被实现，用以减轻服务器崩溃的影响。它还是**时间点恢复（Point-in-Time Recovery PIRT）<strong>与</strong>流复制（Streaming Replication, SR）**实现的基础，这两者将分别在<a href="/ch10" >第10章</a>和<a href="/ch11" >第11章</a>中介绍。</p>
<p>​	尽管理解WAL机制对于管理、集成PostgreSQL非常重要，但由于它的复杂性，不可能做到简要介绍。因此本章将会对WAL做一个完整的解释。第一节描绘了WAL的全貌，介绍了一些重要的概念与关键词。接下来的小节中会依次讲述其他主题：</p>
<ul>
<li>事务日志（WAL）的逻辑结构与物理结构</li>
<li>WAL数据的内部布局</li>
<li>WAL数据的写入</li>
<li>WAL写入者进程</li>
<li>检查点过程</li>
<li>数据库恢复流程</li>
<li>管理WAL段文件</li>
<li>持续归档</li>
</ul>
<h2>9.1 概述<span class="hx-absolute -hx-mt-20" id="91-概述"></span>
    <a href="#91-%e6%a6%82%e8%bf%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	让我们先来概述一下WAL机制。为了阐明WAL要解决的问题，第一部分展示了如果PostgreSQL在没有实现WAL时崩溃会发生什么。第二部分介绍了一些关键概念，并概览了本章中的一些关键主题。最后一部分总结了WAL概述部分，并引出了一个更为重要的概念。</p>
<h3>9.1.1 没有WAL的插入操作<span class="hx-absolute -hx-mt-20" id="911-没有wal的插入操作"></span>
    <a href="#911-%e6%b2%a1%e6%9c%89wal%e7%9a%84%e6%8f%92%e5%85%a5%e6%93%8d%e4%bd%9c" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>正如在<a href="/ch8" >第八章</a>中讨论的那样，为了能高效访问关系表的页面，几乎所有的DBMS都实现了共享缓冲池。</p>
<p>假设有这样一个没有实现WAL机制的PostgreSQL，现在向表A中插入一些数据元组，如图9.1所示。</p>
<p><strong>图9.1 没有WAL的插入操作</strong></p>
<p><img src="/img/fig-9-01.png" alt="图9.1 没有WAL的插入操作" loading="lazy" /></p>
<ol>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面到内存中的共享缓冲池。然后向页面中插入一条元组。页面并没有立刻写回到数据库集簇文件中。正如<a href="/ch8" >第8章</a>中提到的，被修改过的页面通常称为<strong>脏页（dirty page）</strong></li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL直接向缓冲池里的页面内添加了一条新元组。这一页仍然没有被写回到持久存储中。</li>
<li>如果操作系统或PostgreSQL服务器因为各种原因失效（例如电源故障），所有插入的数据都会丢失。</li>
</ol>
<p>因此没有WAL的数据库在系统崩溃时是很脆弱的。</p>
<h3>9.1.2 插入操作与数据库恢复<span class="hx-absolute -hx-mt-20" id="912-插入操作与数据库恢复"></span>
    <a href="#912-%e6%8f%92%e5%85%a5%e6%93%8d%e4%bd%9c%e4%b8%8e%e6%95%b0%e6%8d%ae%e5%ba%93%e6%81%a2%e5%a4%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	为了解决上述系统失效问题，同时又不招致性能损失，PostgreSQL支持了WAL。这一部分介绍了一些关键词和概念，以及WAL数据的写入和数据库系统的恢复。</p>
<p>​	为了应对系统失效，PostgreSQL将所有修改作为历史数据写入持久化存储中。这份历史数据称为<strong>XLOG记录（xlog record）<strong>或</strong>WAL数据（wal data）</strong>。</p>
<p>​	当插入、删除、提交等变更动作发生时，PostgreSQL会将XLOG记录写入内存中的<strong>WAL缓冲区（WAL Buffer）</strong>。当事务提交或中止时，它们会被立即写入持久存储上的**WAL段文件（WAL segment file）<strong>中（更精确来讲，其他场景也可能会有XLOG记录写入，细节将在9.5节中描述）。XLOG记录的</strong>日志序列号（Log Sequence Number, LSN）**标识了该记录在事务日志中的位置，记录的LSN被用作XLOG记录的唯一标识符。</p>
<p>​	顺便一提，当我们考虑数据库系统如何恢复时，可能会想到一个问题：PostgreSQL是从哪一点开始恢复的？答案是<strong>重做点（REDO Point）</strong>，即最新一个<strong>检查点（Checkpoint）<strong>开始时</strong>XLOG记录</strong>写入的位置。（PostgreSQL中的检查点将在9.7节中描述）。实际上，数据库恢复过程与检查点过程紧密相连，两者是不可分割的。</p>
<blockquote>
  <p>WAL与检查点过程在7.1版本中同时实现</p>
</blockquote>
<p>介绍完了主要的关键词与概念，现在来说一下带有WAL时的元组插入操作。如图9.2所示：</p>
<p><strong>图9.2 带有WAL的插入操作</strong></p>
<p><img src="/img/fig-9-02.png" alt="图9.2 带有WAL的插入操作" loading="lazy" /></p>
<blockquote>
  <p>表A的LSN展示的是表A页面中页首部里<code>pd_lsn</code>类型的<code>PageXLogRecPtr</code>字段，与页面的LSN是一回事。</p>
</blockquote>
<ol>
<li>检查点进程是一个后台进程，周期性地执行过程。当检查点进程开始执行检查点时，它会向当前WAL段文件写入一条XLOG记录，称为<strong>检查点（Checkpoint Record）</strong>。这条记录包含了最新的<strong>重做点</strong>位置。</li>
<li>发起第一条<code>INSERT</code>语句时，PostgreSQL从数据库集簇文件中加载表A的页面至内存中的共享缓冲池，向页面中插入一条元组，然后在<code>LSN_1</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_0</code>更新为<code>LSN_1</code>。在本例中，XLOG记录是由首部数据与<strong>完整元组</strong>组成的一对值。</li>
<li>当该事务提交时，PostgreSQL向WAL缓冲区创建并写入一条关于该提交行为的XLOG记录，然后将WAL缓冲区中的所有XLOG记录刷写入WAL段文件中。</li>
<li>发起第二条<code>INSERT</code>语句时，PostgreSQL向页面中插入一条新元组，然后在<code>LSN_2</code>位置创建并写入一条相应的XLOG记录，然后将表A的LSN从<code>LSN_1</code>更新为<code>LSN_2</code>。</li>
<li>当这条语句的事务提交时，PostgreSQL执行同步骤3类似的操作。</li>
<li>设想当操作系统失效发生时，尽管共享缓冲区中的所有数据都丢失了，但所有页面修改已经作为历史记录被写入WAL段文件中。</li>
</ol>
<p>接下来的步骤展示了如何将数据库集簇恢复到崩溃时刻前的状态。不需要任何特殊的操作，重启PostgreSQL时会自动进入恢复模式，如图9.3所示。PostgreSQL会从<strong>重做点</strong>开始，依序读取正确的WAL段文件并重放XLOG记录。</p>
<p><strong>图9.3 使用WAL进行数据库恢复</strong></p>
<p><img src="/img/fig-9-03.png" alt="图9.3 使用WAL进行数据库恢复" loading="lazy" /></p>
<ol>
<li>PostgreSQL从相关的WAL段文件中读取第一条<code>INSERT</code>语句的XLOG记录，并从硬盘上的数据库集簇目录加载表A的页面到内存中的共享缓冲区中。</li>
<li>在重放XLOG记录前，PostgreSQL会比较XLOG记录的LSN与相应页面的LSN。这么做的原因在第9.8节中描述。重放XLOG记录的规则如下所示：
<ul>
<li>如果XLOG记录的LSN要比页面LSN大，XLOG记录中的数据部分就会被插入到页面中，并将页面的LSN更新为XLOG记录的LSN。</li>
<li>如果XLOG记录的LSN要比页面的LSN小，那么不用做任何事情，直接读取后续的WAL数据即可。</li>
</ul>
</li>
<li>PostgreSQL按照同样的方式重放其余的XLOG记录。</li>
</ol>
<p>PostgreSQL可以通过按时间顺序重放写在WAL段文件中的XLOG记录来自我恢复，因此，PostgreSQL的XLOG记录显然是一种<strong>重做日志（REDO log）</strong>。</p>
<blockquote>
  <p>PostgreSQL不支持<strong>撤销日志（UNDO log）</strong></p>
</blockquote>
<p>尽管写XLOG记录肯定有一定的代价，这些代价和全页写入相比微不足道。所付出的代价换来了巨大的收益，比如，系统崩溃时的恢复能力。</p>
<h3>9.1.3 整页写入<span class="hx-absolute -hx-mt-20" id="913-整页写入"></span>
    <a href="#913-%e6%95%b4%e9%a1%b5%e5%86%99%e5%85%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	假设后台写入进程在写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。XLOG是无法在损坏的页面上重放的，我们需要其他功能来确保这一点。</p>
<blockquote>
  <p>译注：PostgreSQL默认使用8KB的页面，操作系统通常使用4KB的页面，可能出现只写入一个4KB页面的情况。</p>
</blockquote>
<p>​	PostgreSQL支持诸如<strong>整页写入（full-page write）<strong>的功能来处理这种失效。如果启用，PostgreSQL会在每次检查点之后，在每个页面第一次发生变更时，会将</strong>整个页面</strong>及相应首部作为一条XLOG记录写入。这个功能默认是开启的。在PostgreSQL中，这种包含完整页面的XLOG记录称为<strong>备份区块（backup block）</strong>，或者<strong>整页镜像（full-page image）</strong>。</p>
<p><strong>图9.4 整页写入</strong></p>
<p><img src="/img/fig-9-04.png" alt="图9.4 整页写入" loading="lazy" /></p>
<ol>
<li>检查点进程开始进行检查点过程。</li>
<li>在第一条<code>INSERT</code>语句进行插入操作时，PostgreSQL执行的操作几乎同上所述。区别在于这里的XLOG记录是当前页的<strong>备份区块</strong>（即，包含了完整的页面），因为这是自最近一次检查点以来，该页面的第一次写入。</li>
<li>当事务提交时，PostgreSQL的操作同上节所述。</li>
<li>第二条<code>INSERT</code>语句进行插入操作时，PostgreSQL的操作同上所述，这里的XLOG记录就不是备份块了。</li>
<li>当这条语句的事务提交时，PostgreSQL的操作同上节所述。</li>
<li>为了说明整页写入的效果，我们假设后台写入进程在向磁盘写入脏页的过程中出现了操作系统故障，导致磁盘上表A的页面数据损坏。</li>
</ol>
<p>重启PostgreSQL即可修复损坏的集簇，如图9.5所示</p>
<p><strong>图9.5 使用备份区块进行数据库恢复</strong></p>
<p><img src="/img/fig-9-05.png" alt="图9.5 使用备份区块进行数据库恢复" loading="lazy" /></p>
<ol>
<li>
<p>PostgreSQL读取第一条<code>INSERT</code>语句的XLOG记录，并从数据库集簇目录加载表A的页面至共享缓冲池中。在本例中，按照整页写入的规则，这条XLOG记录是一个备份区块。</p>
</li>
<li>
<p>当一条XLOG记录是备份区块时，会使用另一条重放规则：XLOG记录的数据部分会直接覆盖当前页面，无视页面或XLOG记录中的LSN，然后将页面的LSN更新为XLOG记录的LSN。</p>
<p>在本例中，PostgreSQL使用记录的数据部分覆写了损坏的页面，并将表A的LSN更新为<code>LSN_1</code>，通过这种方式，损坏的页面通过它自己的备份区块恢复回来了。</p>
</li>
<li>
<p>因为第二条XLOG记录不是备份区块， 因此PostgreSQL的操作同上所述。</p>
</li>
</ol>
<p>即使发生一些数据写入错误，PostgreSQL也能从中恢复。（当然如果发生文件系统或物理介质失效，就不行了）</p>
<h2>9.2 事务日志与WAL段文件<span class="hx-absolute -hx-mt-20" id="92-事务日志与wal段文件"></span>
    <a href="#92-%e4%ba%8b%e5%8a%a1%e6%97%a5%e5%bf%97%e4%b8%8ewal%e6%ae%b5%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>PostgreSQL在逻辑上将XLOG记录写入事务日志，即，一个长度用8字节表示的虚拟文件（16 EB）。</p>
<p>虽说事务日志的容量实际上应该是无限的，但8字节长度的地址空间已经足够宽广了。目前是不可能处理这个量级的单个文件的。因此PostgreSQL中的事务日志实际上默认被划分为16M大小的一系列文件，这些文件被称作<strong>WAL段（WAL Segment）</strong>。如图9.6所示。</p>
<blockquote>
  <h3>WAL段文件尺寸<span class="hx-absolute -hx-mt-20" id="wal段文件尺寸"></span>
    <a href="#wal%e6%ae%b5%e6%96%87%e4%bb%b6%e5%b0%ba%e5%af%b8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>从版本11开始，在使用<code>initdb</code>创建数据库时，可以通过<a href="https://www.postgresql.org/docs/11/static/app-initdb.html" target="_blank" rel="noopener"><code>--wal-segsize</code></a>选项来配置WAL段文件的大小。</p>
</blockquote>
<p><strong>图9.6 事务日志与WAL段文件</strong></p>
<p><img src="/img/fig-9-06.png" alt="图9.6 事务日志与WAL段文件" loading="lazy" /></p>
<p>WAL段文件的文件名是由24个十六进制数字组成的，其命名规则如下：
</p>
$$
\begin{align}
	\verb|WAL段文件名| = \verb|timelineId| + (\verb|uint32|) \frac{\verb|LSN|-1}{16\verb|M|*256}  
		  	  + (\verb|uint32|)\left(\frac{\verb|LSN|-1}{16\verb|M|}\right) \% 256
\end{align}
$$<blockquote>
  <h3>时间线标识<span class="hx-absolute -hx-mt-20" id="时间线标识"></span>
    <a href="#%e6%97%b6%e9%97%b4%e7%ba%bf%e6%a0%87%e8%af%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>PostgreSQL的WAL有<strong>时间线标识（TimelineID，四字节无符号整数）<strong>的概念，用于<a href="/ch10" >第十章</a>中所述的</strong>时间点恢复（PITR）</strong>。不过在本章中时间线标识将固定为<code>0x00000001</code>，因为接下来的几节里还不需要这个概念。</p>
</blockquote>
<p>​	第一个WAL段文件名是$00000001\color{blue}{00000000}000000\color{blue}{01}$，如果第一个段被XLOG记录写满了，就会创建第二个段$00000001\color{blue}{00000000}000000\color{blue}{02}$，后续的文件名将使用升序。在$00000001\color{blue}{00000000}000000\color{blue}{FF}$被填满之后，就会使用下一个文件$00000001\color{blue}{00000001}000000\color{blue}{00}$。通过这种方式，每当最后两位数字要进位时，中间8位数字就会加一。与之类似，在$00000001\color{blue}{00000001}000000\color{blue}{FF}$被填满后，就会开始使用$00000001\color{blue}{00000002}000000\color{blue}{00}$，依此类推。</p>
<blockquote>
  <h3>WAL文件名<span class="hx-absolute -hx-mt-20" id="wal文件名"></span>
    <a href="#wal%e6%96%87%e4%bb%b6%e5%90%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>使用内建的函数<code>pg_xlogfile_name</code>（9.6及以前的版本），或<code>pg_walfile_name</code>（10及以后的版本），我们可以找出包含特定LSN的WAL段文件。例如：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_xlogfile_name</span><span class="p">(</span><span class="s1">&#39;1/00002D3E&#39;</span><span class="p">);</span><span class="w">   </span><span class="c1">-- 9.6-
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="c1">-- SELECT pg_walfile_name(&#39;1/00002D3E&#39;); -- 10+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">pg_xlogfile_name</span><span class="w">     
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="mi">000000010000000100000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</blockquote>
<h2>9.3 WAL段文件的内部布局<span class="hx-absolute -hx-mt-20" id="93-wal段文件的内部布局"></span>
    <a href="#93-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>一个WAL段文件大小默认为16MB，并在内部划分为大小为8192字节（8KB）的页面。第一个页包含了由<code>XLogLongPageHeaderData</code>定义的首部数据，其他的页包含了由<code>XLogPageHeaderData</code>定义的首部数据。每页在首部数据之后，紧接着就是以<strong>降序</strong>写入的XLOG记录，如图9.7所示。</p>
<p><strong>图9.7 WAL段文件内部布局</strong></p>
<p><img src="/img/fig-9-07.png" alt="图9.7 WAL段文件内部布局" loading="lazy" /></p>
<p><code>XLogLongPageHeaderData</code>与<code>XLogPageHeaderData</code>结构定义在 <a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlog_internal.h" target="_blank" rel="noopener"><code>src/include/access/xlog_internal.h</code></a>中。这两个结构的具体说明就不在此展开了，因为对于后续小节并非必需。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogPageHeaderData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">xlp_magic</span><span class="p">;</span>		<span class="cm">/* 用于正确性检查的魔数 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">xlp_info</span><span class="p">;</span>		<span class="cm">/* 标记位，详情见下 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">TimeLineID</span>	<span class="n">xlp_tli</span><span class="p">;</span>		<span class="cm">/* 页面中第一条记录的时间线ID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">XLogRecPtr</span>	<span class="n">xlp_pageaddr</span><span class="p">;</span>	<span class="cm">/* 当前页的XLOG地址 */</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="cm">/* 当本页放不下一条完整记录时，我们会在下一页继续，xlp_rem_len存储了来自先前页面
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * 记录剩余的字节数。注意xl_rem_len包含了备份区块的数据，也就是说它会在第一个首部跟踪
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * xl_tot_len而不是xl_len。还要注意延续的数据不一定是对齐的。*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint32</span>		<span class="n">xlp_rem_len</span><span class="p">;</span>	<span class="cm">/* 记录所有剩余数据的长度 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogPageHeaderData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">XLogPageHeaderData</span> <span class="o">*</span><span class="n">XLogPageHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 当设置了XLP_LONG_HEADER标记位时，我们将在页首部中存储额外的字段。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (通常是在XLOG文件中的第一个页面中) 额外的字段用于确保文件的正确性。 */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogLongPageHeaderData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">XLogPageHeaderData</span> <span class="n">std</span><span class="p">;</span>            <span class="cm">/* 标准首部 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint64</span>             <span class="n">xlp_sysid</span><span class="p">;</span>      <span class="cm">/* 来自pg_control中的系统标识符 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint32</span>             <span class="n">xlp_seg_size</span><span class="p">;</span>   <span class="cm">/* 交叉校验 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint32</span>             <span class="n">xlp_xlog_blcksz</span><span class="p">;</span><span class="cm">/* 交叉校验 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogLongPageHeaderData</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h2>9.4 WAL记录的内部布局<span class="hx-absolute -hx-mt-20" id="94-wal记录的内部布局"></span>
    <a href="#94-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%85%e9%83%a8%e5%b8%83%e5%b1%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	一条XLOG记录由通用的首部部分与特定的数据部分构成。本章第一节描述了首部的结构，剩下两个节分别解释了9.5版本前后数据部分的结构。（9.5版本改变了数据格式）</p>
<h3>9.4.1 WAL记录首部部分<span class="hx-absolute -hx-mt-20" id="941-wal记录首部部分"></span>
    <a href="#941-wal%e8%ae%b0%e5%bd%95%e9%a6%96%e9%83%a8%e9%83%a8%e5%88%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	所有的XLOG记录都有一个通用的首部，由结构<code>XLogRecord</code>定义。9.5更改了首部的定义，9.4及更早版本的结构定义如下所示：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecord</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span>          <span class="n">xl_tot_len</span><span class="p">;</span>   <span class="cm">/* 整条记录的全长 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">TransactionId</span>   <span class="n">xl_xid</span><span class="p">;</span>       <span class="cm">/* 事务ID */</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint32</span>          <span class="n">xl_len</span><span class="p">;</span>       <span class="cm">/* 资源管理器的数据长度 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint8</span>           <span class="n">xl_info</span><span class="p">;</span>      <span class="cm">/* 标记位，如下所示 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">RmgrId</span>          <span class="n">xl_rmid</span><span class="p">;</span>      <span class="cm">/* 本记录的资源管理器 */</span>
</span></span><span class="line"><span class="cl">   <span class="cm">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">XLogRecPtr</span>      <span class="n">xl_prev</span><span class="p">;</span>      <span class="cm">/* 在日志中指向先前记录的指针 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">pg_crc32</span>        <span class="n">xl_crc</span><span class="p">;</span>       <span class="cm">/* 本记录的CRC */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogRecord</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>除了两个变量，大多数变量的意思非常明显，无需多言。<code>xl_rmid</code>与<code>xl_info</code>都是与**资源管理器（resource manager）**相关的变量，它是一些与WAL功能（写入，重放XLOG记录）相关的操作集合。资源管理器的数目随着PostgreSQL不断增加，第10版包括这些：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"></th>
          <th style="text-align: left">资源管理器</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">堆元组操作</td>
          <td style="text-align: left"><code>RM_HEAP</code>, <code>RM_HEAP2</code></td>
      </tr>
      <tr>
          <td style="text-align: left">索引操作</td>
          <td style="text-align: left"><code>RM_BTREE</code>, <code>RM_HASH</code>, <code>RM_GIN</code>, <code>RM_GIST</code>, <code>RM_SPGIST</code>, <code>RM_BRIN</code></td>
      </tr>
      <tr>
          <td style="text-align: left">序列号操作</td>
          <td style="text-align: left"><code>RM_SEQ</code></td>
      </tr>
      <tr>
          <td style="text-align: left">事务操作</td>
          <td style="text-align: left"><code>RM_XACT</code>, <code>RM_MULTIXACT</code>, <code>RM_CLOG</code>, <code>RM_XLOG</code>, <code>RM_COMMIT_TS</code></td>
      </tr>
      <tr>
          <td style="text-align: left">表空间操作</td>
          <td style="text-align: left"><code>RM_SMGR</code>, <code>RM_DBASE</code>, <code>RM_TBLSPC</code>, <code>RM_RELMAP</code></td>
      </tr>
      <tr>
          <td style="text-align: left">复制与热备操作</td>
          <td style="text-align: left"><code>RM_STANDBY</code>, <code>RM_REPLORIGIN</code>, <code>RM_GENERIC_ID</code>, <code>RM_LOGICALMSG_ID</code></td>
      </tr>
  </tbody>
</table>
<p>下面是一些有代表性的例子，展示了资源管理器工作方式。</p>
<ul>
<li>如果发起的是<code>INSERT</code>语句，则其相应XLOG记录首部中的变量<code>xl_rmid</code>与<code>xl_info</code>会相应地被设置为<code>RM_HEAP</code>与<code>XLOG_HEAP_INSERT</code>。当恢复数据库集簇时，就会按照<code>xl_info</code>选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_insert()</code>来重放当前XLOG记录。</li>
<li><code>UPDATE</code>语句与之类似，首部变量中的<code>xl_info</code>会被设置为<code>XLOG_HEAP_UPDATE</code>，而在数据库恢复时就会选用资源管理器<code>RM_HEAP</code>的函数<code>heap_xlog_update()</code>进行重放。</li>
<li>当事务提交时，相应XLOG记录首部的变量<code>xl_rmid</code>与<code>xl_info</code>会被相应地设置为<code>RM_XACT</code>与<code>XLOG_XACT_COMMIT</code>。当数据库恢复时，<code>RM_XACT</code>的<code>xact_redo_commit()</code>就会执行本记录的重放。</li>
</ul>
<p>在9.5及之后的版本，首部结构<a href="https://github.com/postgres/postgres/blob/9d4649ca49416111aee2c84b7e4441a0b7aa2fac/src/include/access/xlogrecord.h" target="_blank" rel="noopener"><code>XLogRecord</code></a>移除了一个字段<code>xl_len</code>，精简了XLOG记录的格式，省了几个字节。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecord</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint32</span>		<span class="n">xl_tot_len</span><span class="p">;</span>		<span class="cm">/* 整条记录的总长度 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">TransactionId</span> <span class="n">xl_xid</span><span class="p">;</span>		<span class="cm">/* 事物标识 xid */</span>
</span></span><span class="line"><span class="cl">	<span class="n">XLogRecPtr</span>	<span class="n">xl_prev</span><span class="p">;</span>		<span class="cm">/* 指向日志中前一条记录的指针 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">xl_info</span><span class="p">;</span>		<span class="cm">/* 标记位，详情见下*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">RmgrId</span>		<span class="n">xl_rmid</span><span class="p">;</span>		<span class="cm">/* 本条记录对应的资源管理器 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 这里有2字节的填充，初始化为0 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">pg_crc32c</span>	<span class="n">xl_crc</span><span class="p">;</span>			<span class="cm">/* 本记录的CRC */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 紧随其后的是XLogRecordBlockHeaders 与 XLogRecordDataHeader ，不带填充 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogRecord</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<blockquote>
  <p>9.4版本中的<code>XLogRecord</code>结构定义在<a href="https://github.com/postgres/postgres/blob/REL9_4_STABLE/src/include/access/xlog.h" target="_blank" rel="noopener"><code>src/include/access/xlog.h</code></a>中，9.5及以后的定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/xlogrecord.h" target="_blank" rel="noopener"><code>src/include/access/xlogrecord.h</code></a>。<code>heap_xlog_insert</code>与<code>heap_xlog_update</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/heap/heapam.c" target="_blank" rel="noopener"><code>src/backend/access/heap/heapam.c</code></a> ；而函数<code>xact_redo_commit</code>定义在<a href="https://github.com/postgres/postgres/blob/master/src/backend/access/transam/xact.c" target="_blank" rel="noopener"><code>src/backend/access/transam/xact.c</code></a>中</p>
</blockquote>
<h3>9.4.2 XLOG记录数据部分（9.4及以前）<span class="hx-absolute -hx-mt-20" id="942-xlog记录数据部分94及以前"></span>
    <a href="#942-xlog%e8%ae%b0%e5%bd%95%e6%95%b0%e6%8d%ae%e9%83%a8%e5%88%8694%e5%8f%8a%e4%bb%a5%e5%89%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>XLOG记录的数据部分可以分为两类：备份区块（完整的页面），或非备份区块（不同的操作相应的数据不同）。</p>
<p><strong>图9.8 XLOG记录的样例（9.4版本或更早）</strong></p>
<p><img src="/img/fig-9-08.png" alt="" loading="lazy" /></p>
<p>让我们通过几个具体示例来了解XLOG记录的内部布局。</p>
<h4>9.4.2.1 备份区块<span class="hx-absolute -hx-mt-20" id="9421-备份区块"></span>
    <a href="#9421-%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>备份区块如图9.8(a)所示，它由两个数据结构和一个数据对象组成，如下所述：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>BkpBlock</code>结构体</li>
<li>除去空闲空间的完整页面。</li>
</ol>
<p><code>BkpBlock</code>包括了用于在数据库集簇目录中定位该页面的变量（比如，包含该页面的关系表的<code>RelFileNode</code>与<code>ForkNumber</code>，以及文件内的区块号<code>BlockNumber</code>），以及当前页面空闲空间的开始位置与长度。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp"># @include/access/xlog_internal.h
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">BkpBlock</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">RelFileNode</span> <span class="n">node</span><span class="p">;</span>        <span class="cm">/* 包含该块的关系 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">ForkNumber</span>  <span class="n">fork</span><span class="p">;</span>        <span class="cm">/* 关系的分支(main,vm,fsm,...) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">BlockNumber</span> <span class="n">block</span><span class="p">;</span>       <span class="cm">/* 区块号 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint16</span>      <span class="n">hole_offset</span><span class="p">;</span> <span class="cm">/* &#34;空洞&#34;前的字节数 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint16</span>      <span class="n">hole_length</span><span class="p">;</span> <span class="cm">/* &#34;空洞&#34;的长度 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 实际的区块数据紧随该结构体后 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">BkpBlock</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h4>9.4.2.2 非备份区块<span class="hx-absolute -hx-mt-20" id="9422-非备份区块"></span>
    <a href="#9422-%e9%9d%9e%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>在非备份区块中，数据部分的布局依不同操作而异。这里举一个具有代表性的例子：一条<code>INSERT</code>语句的XLOG记录。如图9.8(b)所示，<code>INSERT</code>语句的XLOG记录是由两个数据结构与一个数据对象组成的：</p>
<ol>
<li>首部部分，<code>XLogRecord</code>结构体</li>
<li><code>xl_heap_insert</code>结构体</li>
<li>被插入的元组 —— 更精确地说，是移除了一些字节的元组。</li>
</ol>
<p>结构体<code>xl_heap_insert</code>包含的变量用于在数据库集簇中定位被插入的元组。（即，包含该元组的表的<code>RelFileNode</code>，以及该元组的<code>tid</code>），以及该元组的可见性标记位。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">BlockIdData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint16</span>          <span class="n">bi_hi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">uint16</span>          <span class="n">bi_lo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">BlockIdData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">uint16</span> <span class="n">OffsetNumber</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ItemPointerData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">BlockIdData</span>     <span class="n">ip_blkid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="n">OffsetNumber</span>    <span class="n">ip_posid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">RelFileNode</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Oid</span>             <span class="n">spcNode</span><span class="p">;</span>             <span class="cm">/* 表空间 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">Oid</span>             <span class="n">dbNode</span><span class="p">;</span>              <span class="cm">/* 数据库 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">Oid</span>             <span class="n">relNode</span><span class="p">;</span>             <span class="cm">/* 关系 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">RelFileNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">xl_heaptid</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">RelFileNode</span>     <span class="n">node</span><span class="p">;</span>				<span class="cm">/* 关系定位符 */</span>
</span></span><span class="line"><span class="cl">   <span class="n">ItemPointerData</span> <span class="n">tid</span><span class="p">;</span>                 <span class="cm">/* 元组在关系中的位置 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">xl_heaptid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">xl_heap_insert</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">xl_heaptid</span>      <span class="n">target</span><span class="p">;</span>              <span class="cm">/* 被插入的元组ID */</span>
</span></span><span class="line"><span class="cl">   <span class="kt">bool</span>            <span class="n">all_visible_cleared</span><span class="p">;</span> <span class="cm">/* PD_ALL_VISIBLE 是否被清除 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">xl_heap_insert</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<blockquote>
  <p>在结构体<code>xl_heap_header</code>的代码注释中解释了移除插入元组中若干字节的原因：</p>
<p>我们并没有在WAL中存储被插入或被更新元组的固定部分（即<code>HeapTupleHeaderData</code>，堆元组首部），我们可以在需要时从WAL中的其它部分重建这几个字段，以此节省一些字节。或者根本就无需重建。</p>
</blockquote>
<p>这里还有一个例子值得一提，如图9.8(c)所示，检查点的XLOG记录相当简单，它由如下所示的两个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构（首部部分）</li>
<li>包含检查点信息的<code>CheckPoint</code>结构体（参见<a href="#9.7" >9.7节</a>）</li>
</ol>
<blockquote>
  <p><code>xl_heap_header</code>结构定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h" target="_blank" rel="noopener"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构体定义在<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h" target="_blank" rel="noopener"><code>src/include/catalog/pg_control.h</code></a>中。</p>
</blockquote>
<h3>9.4.3 XLOG记录数据部分（9.5及后续版本）<span class="hx-absolute -hx-mt-20" id="943-xlog记录数据部分95及后续版本"></span>
    <a href="#943-xlog%e8%ae%b0%e5%bd%95%e6%95%b0%e6%8d%ae%e9%83%a8%e5%88%8695%e5%8f%8a%e5%90%8e%e7%bb%ad%e7%89%88%e6%9c%ac" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	在9.4及之前的版本，XLOG记录并没有通用的格式，因此每一种资源管理器都需要定义各自的格式。在这种情况下，维护源代码，以及实现与WAL相关的新功能变得越来越困难。为了解决这个问题，9.5版引入了一种通用的结构化格式，不依赖于特定的资源管理器。</p>
<p>​	XLOG记录的数据部分可以被划分为两个部分：首部与数据，如图9.9所示：</p>
<p><strong>图9.9 通用XLOG记录格式</strong></p>
<p><img src="/img/fig-9-09.png" alt="" loading="lazy" /></p>
<p>首部部分包含零个或多个<code>XLogRecordBlockHeaders</code>，以及零个或一个<code>XLogRecordDataHeaderShort</code>（或<code>XLogRecordDataHeaderLong</code>）；它必须至少包含其中一个。当记录存储着整页镜像时（即备份区块），<code>XLogRecordBlockHeader</code>会包含<code>XLogRecordBlockImageHeader</code>，如果启用压缩还会包含<code>XLogRecordBlockCompressHeader</code>。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* 追加写入XLOG记录的区块数据首部。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &#39;data_length&#39;是与本区块关联的，特定于资源管理器的数据荷载长度。它不包括可能会出现
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 的整页镜像的长度，也不会包括XLogRecordBlockHeader结构本身。注意我们并不会对
</span></span></span><span class="line"><span class="cl"><span class="cm"> * XLogRecordBlockHeader结构做边界对齐！因此在使用前该结构体必须拷贝到对齐的本地存储中。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecordBlockHeader</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">id</span><span class="p">;</span>				<span class="cm">/* 块引用 ID */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">fork_flags</span><span class="p">;</span>		<span class="cm">/* 关系中的分支，以及标志位 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">data_length</span><span class="p">;</span>	<span class="cm">/* 荷载字节数（不包括页面镜像） */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 如果设置 BKPBLOCK_HAS_IMAGE, 紧接一个XLogRecordBlockImageHeader结构 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 如果未设置 BKPBLOCK_SAME_REL, 紧接着一个RelFileNode结构 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 紧接着区块号码 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogRecordBlockHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 分支标号放在fork_flags的低4位中，高位用于标记位 */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_FORK_MASK	0x0F
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_FLAG_MASK	0xF0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_HAS_IMAGE	0x10	</span><span class="cm">/* 区块数据是一个XLogRecordBlockImage */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_HAS_DATA	0x20
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_WILL_INIT	0x40	</span><span class="cm">/* 重做会重新初始化当前页 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BKPBLOCK_SAME_REL	0x80	</span><span class="cm">/* 忽略RelFileNode，与前一个相同 */</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* XLogRecordDataHeaderShort/Long 被用于本记录的“主数据”部分。如果数据的长度小于256字节
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 则会使用Short版本的格式，即使用单个字节来保存长度，否则会使用长版本的格式。 */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecordDataHeaderShort</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">id</span><span class="p">;</span>				<span class="cm">/* XLR_BLOCK_ID_DATA_SHORT */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">data_length</span><span class="p">;</span>	<span class="cm">/* 载荷字节数目 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>			<span class="n">XLogRecordDataHeaderShort</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define SizeOfXLogRecordDataHeaderShort (sizeof(uint8) * 2)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecordDataHeaderLong</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">id</span><span class="p">;</span>				<span class="cm">/* XLR_BLOCK_ID_DATA_LONG */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* 紧随其后的是uint32类型的data_length, 未对齐 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>			<span class="n">XLogRecordDataHeaderLong</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* 当包含整页镜像时额外的首部信息(即当BKPBLOCK_HAS_IMAGE标记位被设置时)。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * XLOG相关的代码会意识到数据压缩上一个显而易见的情况，即PG里的数据页面通常会在中间包含一个
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 未使用的“空洞”，空洞里面通常只有置零的字节。如果空洞的长度大于0，我们就会从存储的数据中
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 移除该“空洞”（且XLOG记录的CRC也不会计算该空洞）。因此区块数据的总量实际上是块大小BLCKSZ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 减去空洞包含的字节大小。
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 当启用 wal_compression 时，一个包含空洞的整页镜像除了移除空洞，还会额外是引用PGLZ压缩
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 算法进行压缩。这能减小WAL日志的体积，但会增加在记录WAL日志过程中的CPU开销。在这种情况下，
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 空洞的大小就无法通过块大小-页面镜像大小来计算了。基本上，这需要存储额外的信息。但当没有
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 空洞存在时，我们可以假设空洞大小为0，因此就不需要存储额外信息了。注意，当压缩节约的字节数
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 小于额外信息的长度时，WAL里就会存储原始的页面镜像，而不是压缩过的版本。因此当成功进行压缩
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 时，区块数据的总量总是要比（块大小BLCKSZ - 空洞字节数 - 额外信息长度）要更小。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecordBlockImageHeader</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">length</span><span class="p">;</span>			<span class="cm">/* 页面镜像的字节数 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">hole_offset</span><span class="p">;</span>	<span class="cm">/* 空洞前面的字节数 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">bimg_info</span><span class="p">;</span>		<span class="cm">/* 标记位，详情见下 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* 如果 BKPIMAGE_HAS_HOLE 且 BKPIMAGE_IS_COMPRESSED, 后面会跟着
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * XLogRecordBlockCompressHeader 结构体 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogRecordBlockImageHeader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 当页面镜像含有“空洞”且被压缩时，会用到这里的额外首部信息 */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">XLogRecordBlockCompressHeader</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint16</span>		<span class="n">hole_length</span><span class="p">;</span>	<span class="cm">/* number of bytes in &#34;hole&#34; */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">XLogRecordBlockCompressHeader</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>​	数据部分则由零或多个区块数据与零或一个主数据组成，区块数据与<code>XLogRecordBlockHeader(s)</code>对应，而**主数据（main data）**则与<code>XLogRecordDataHeader</code>对应。</p>
<blockquote>
  <h4>WAL压缩<span class="hx-absolute -hx-mt-20" id="wal压缩"></span>
    <a href="#wal%e5%8e%8b%e7%bc%a9" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>​	在9.5及其后的版本，可以通过设置<code>wal_compression = enable</code>启用WAL压缩：使用LZ压缩方法对带有整页镜像的XLOG记录进行压缩。在这种情况下，会添加<code>XLogRecordBlockCompressHeader</code>结构。</p>
<p>​	该功能有两个优点与一个缺点，优点是降低写入记录的I/O开销，并减小WAL段文件的消耗量；缺点是会消耗更多的CPU资源来执行压缩。</p>
</blockquote>
<p><strong>图9.10 XLOG记录样例（9.5及其后的版本）</strong></p>
<p><img src="/img/fig-9-10.png" alt="" loading="lazy" /></p>
<p>和前一小节一样，这里通过一些特例来描述。</p>
<h4>9.4.3.1 备份区块<span class="hx-absolute -hx-mt-20" id="9431-备份区块"></span>
    <a href="#9431-%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>由<code>INSERT</code>语句创建的备份区块如图9.10(a)所示，它由如下所示的四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构，且包含一个<code>XLogRecordBlockImageHeader</code></li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一个备份区块（区块数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含了用于在数据库集簇中定位区块的变量 (关系节点，分支编号，以及区块号)； <code>XLogRecordImageHeader</code> 包含了当前区块的长度与偏移量（这两个首部结构合起来效果与9.4及先前版本中的<code>BkpBlock</code>结构相同）。</p>
<p><code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分（见下）。</p>
<blockquote>
  <p>​	除了某些特例外（例如逻辑解码与<strong>推测插入（speculative insertion）</strong>），包含整页镜像的XLOG记录的<strong>主数据</strong>不会被使用。它们会在记录重放时被忽略，属于冗余数据，未来可能会对其改进。</p>
<p>​	此外，备份区块记录的主数据与创建它们的语句相关。例如<code>UPDATE</code>语句就会追加写入<code>xl_heap_lock</code>或<code>xl_heap_updated</code>。</p>
</blockquote>
<h4>9.4.3.2 非备份区块<span class="hx-absolute -hx-mt-20" id="9432-非备份区块"></span>
    <a href="#9432-%e9%9d%9e%e5%a4%87%e4%bb%bd%e5%8c%ba%e5%9d%97" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>接下来描述由<code>INSERT</code>语句创建的非备份区块，如图9.10(b)所示，它由四个数据结构与一个数据对象组成：</p>
<ol>
<li><code>XLogRecord</code>结构 （首部部分）</li>
<li><code>XLogRecordBlockHeader</code>结构</li>
<li><code>XLogRecordDataHeaderShort</code>结构</li>
<li>一条被插入的元组（更精确地说，一个<code>xl_heap_header</code>结构与完整的插入数据）</li>
<li><code>xl_heap_insert</code>结构 (主数据)</li>
</ol>
<p><code>XLogRecordBlockHeader</code>包含三个值 (关系节点，分支编号，以及区块号)，用以指明该元组被插入到哪个区块中，以及要插入数据部分的长度。<code>XLogRecordDataHeaderShort</code>存储了<code>xl_heap_insert</code>结构的长度，该结构是当前记录的主数据部分。</p>
<p>新版本的<code>xl_heap_insert</code>仅包含两个值：当前元组在区块内的偏移量，以及一个可见性标记。该结构变得十分简单，因为<code>XLogRecordBlockHeader</code>存储了旧版本中该结构体的绝大多数数据。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* 这里是关于该INSERT操作，我们所需要知道的一切 */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">xl_heap_insert</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">OffsetNumber</span> <span class="n">offnum</span><span class="p">;</span>		<span class="cm">/* 被插入元组的偏移量 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">uint8</span>		<span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* xl_heap_header &amp; 备份区块0中的元组数据 */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">xl_heap_insert</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>最后一个例子，检查点的记录如图9.10(c)所示，它由三个数据结构组成：</p>
<ol>
<li><code>XLogRecord</code>结构体（首部部分）</li>
<li><code>XLogRecordDataHeaderShort</code>结构，包含了主数据的长度。</li>
<li>结构体<code>CheckPoint</code>（主数据）</li>
</ol>
<blockquote>
  <p><code>xl_heap_header</code>定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/access/htup.h" target="_blank" rel="noopener"><code>src/include/access/htup.h</code></a>中，而<code>CheckPoint</code>结构定义于<a href="https://github.com/postgres/postgres/blob/master/src/include/catalog/pg_control.h" target="_blank" rel="noopener"><code>src/include/catalog/pg_control.h</code></a>.</p>
</blockquote>
<p>尽管对我们来说新格式稍显复杂，但它对于资源管理器的解析而言，设计更为合理，而且许多类型的XLOG记录的大小都比先前要小。主要的结构如图9.8和图9.10所示，你可以计算并相互比较这些记录的大小。（新版<code>CheckPoint</code>记录的尺寸要比旧版本大一些，但它也包含了更多的变量）。</p>
<h2>9.5 WAL记录的写入<span class="hx-absolute -hx-mt-20" id="95-wal记录的写入"></span>
    <a href="#95-wal%e8%ae%b0%e5%bd%95%e7%9a%84%e5%86%99%e5%85%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	完成了热身练习后，现在我们已经做好理解XLOG记录写入过程的准备了。因此在本节中，我将尽可能仔细地描述。首先，以下列语句的执行为例，让我们来看一看PostgreSQL的内幕。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">testdb</span><span class="o">=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tbl</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">);</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>通过发出上述语句，内部函数<code>exec_simple_query()</code>会被调用，其伪代码如下所示：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">exec_simple_query</span><span class="p">()</span> <span class="err">@</span><span class="n">postgres</span><span class="p">.</span><span class="nf">c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="nf">ExtendCLOG</span><span class="p">()</span>	<span class="err">@</span><span class="n">clog</span><span class="p">.</span><span class="n">c</span>     <span class="cm">/* 将当前事务的状态&#34;IN_PROGRESS&#34;写入CLOG */</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="nf">heap_insert</span><span class="p">()</span>	<span class="err">@</span><span class="n">heapam</span><span class="p">.</span><span class="n">c</span>	<span class="cm">/* 插入元组，创建一条XLOG记录并调用函XLogInsert. */</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="nf">XLogInsert</span><span class="p">()</span>	<span class="err">@</span><span class="n">xlog</span><span class="p">.</span><span class="n">c</span> 	<span class="cm">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span class="line"><span class="cl">								<span class="cm">/* 将插入元组的XLOG记录写入WAL缓冲区，更新页面的 pd_lsn */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="nf">finish_xact_command</span><span class="p">()</span> <span class="err">@</span><span class="n">postgres</span><span class="p">.</span><span class="n">c</span>	<span class="cm">/* 执行提交 */</span>   
</span></span><span class="line"><span class="cl">      <span class="nf">XLogInsert</span><span class="p">()</span> <span class="err">@</span><span class="n">xlog</span><span class="p">.</span><span class="n">c</span>  			<span class="cm">/* (9.5 以及后续的版本为 xloginsert.c) */</span>
</span></span><span class="line"><span class="cl">										<span class="cm">/* 将该提交行为的XLOG记录写入WAL缓冲区 */</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="nf">XLogWrite</span><span class="p">()</span> <span class="err">@</span><span class="n">xlog</span><span class="p">.</span><span class="n">c</span>				<span class="cm">/* 将WAL缓冲区中所有的XLOG刷写入WAL段中 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="nf">TransactionIdCommitTree</span><span class="p">()</span> <span class="err">@</span><span class="n">transam</span><span class="p">.</span><span class="n">c</span>	
</span></span><span class="line"><span class="cl">							<span class="cm">/* 在CLOG中将当前事务的状态由&#34;IN_PROGRESS&#34;修改为&#34;COMMITTED&#34; /*
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在接下来的段落中将会解释每一行伪代码，从而理解XLOG记录写入的过程。如图9.11和图9.12所示。</p>
<ol>
<li>函数<code>ExtendCLOG()</code>将当前事务的状态<code>IN_PROGRESS</code>写入内存中的CLOG。</li>
<li>函数<code>heap_insert()</code>向共享缓冲池的目标页面中插入堆元组，创建当前页面的XLOG记录，并执行函数<code>XLogInsert()</code>。</li>
<li>函数<code>XLogInsert()</code>会将<code>heap_insert()</code>创建的XLOG记录写入WAL缓冲区<code>LSN_1</code>处，并将被修改页面的<code>pd_lsn</code>从<code>LSN_0</code>更新为<code>LSN_1</code>。</li>
<li>函数<code>finish_xact_command()</code>会在该事务被提交时被调用，用于创建该提交动作的XLOG记录，而这里的<code>XLogInsert()</code>函数会将该记录写入WAL缓冲区<code>LSN_2</code>处。</li>
</ol>
<p><strong>图9.11 XLOG记录的写入顺序</strong></p>
<p><img src="/img/fig-9-11.png" alt="" loading="lazy" /></p>
<blockquote>
  <p>上图的XLOG格式是9.4版本的</p>
</blockquote>
<ol start="5">
<li>函数<code>XLogWrite()</code>会冲刷WAL缓冲区，并将所有内容写入WAL段文件中。如果<code>wal_sync_method</code>参数被配置为<code>open_sync</code>或<code>open_datasync</code>，记录会被同步写入（译者注：而不是提交才会刷新WAL缓冲区），因为函数会使用带有<code>O_SYNC</code>或<code>O_DSYNC</code>标记的<code>open()</code>系统调用。如果该参数被配置为<code>fsync</code>，<code>fsync_writethrough</code>，<code>fdatasync</code>，相应的系统调用就是<code>fsync()</code>，带有<code>F_FULLSYNC</code>选项的<code>fcntl()</code>，以及<code>fdatasync()</code>。无论哪一种情况，所有的XLOG记录都会被确保写入存储之中。</li>
<li>函数<code>TransactionIdCommitTree()</code>将提交日志clog中当前事务的状态从<code>IN_PROGRESS</code>更改为<code>COMMITTED</code>。</li>
</ol>
<p><strong>图9.12 XLOG记录的写入顺序（续图9.11）</strong></p>
<p><img src="/img/fig-9-12.png" alt="" loading="lazy" /></p>
<p>在上面这个例子中，<code>COMMIT</code>操作致使XLOG记录写入WAL段文件。但发生在下列任一情况时，都会执行这种写入操作：</p>
<ol>
<li>一个运行中的事务提交或中止。</li>
<li>WAL缓冲区被写入的元组填满（WAL缓冲区的大小由参数<code>wal_buffers</code>控制）</li>
<li>WAL写入者进程周期性执行写入（参见下一节）</li>
</ol>
<p>如果出现上述情况之一，无论其事务是否已提交，WAL缓冲区上的所有WAL记录都将写入WAL段文件中。</p>
<p>​	DML操作写XLOG记录是理所当然的，但非DML操作也会产生XLOG。如上所述，<code>COMMIT</code>操作会写入包含着提交的事务ID的XLOG记录。另一个例子是<code>Checkpoint</code>操作会写入关于该检查点概述信息的XLOG记录。此外，尽管不是很常见，<code>SELECT</code>语句在一些特殊情况下也会创建XLOG记录。例如在SELECT语句处理的过程中，如果因为HOT（Heap Only Tuple）需要删除不必要元组并拼接必要的元组时，修改对应页面的XLOG记录就会写入WAL缓冲区。</p>
<h2>9.6 WAL写入进程<span class="hx-absolute -hx-mt-20" id="96-wal写入进程"></span>
    <a href="#96-wal%e5%86%99%e5%85%a5%e8%bf%9b%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	WAL写入者是一个后台进程，用于定期检查WAL缓冲区，并将所有未写入的XLOG记录写入WAL段文件。 这个进程的目的是避免XLOG记录的突发写入。 如果没有启用该进程，则在一次提交大量数据时，XLOG记录的写入可能会成为瓶颈。</p>
<p>​	WAL写入者默认是启用的，无法禁用。但检查间隔可以通过参数<code>wal_writer_delay</code>进行配置，默认值为200毫秒。</p>
<h2>9.7 PostgreSQL中的检查点过程<span class="hx-absolute -hx-mt-20" id="97-postgresql中的检查点过程"></span>
    <a href="#97-postgresql%e4%b8%ad%e7%9a%84%e6%a3%80%e6%9f%a5%e7%82%b9%e8%bf%87%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>在PostgreSQL中，检查点进程（后台）会执行检查点；当下列情形之一发生时，它会启动处理：</p>
<ol>
<li>距离上次检查点已经过去了由参数<code>checkpoint_timeout</code>配置的时间间隔（默认间隔为300秒（5分钟））。</li>
<li>在9.4及以前的版本中，自上一次检查点以来消耗的WAL段文件超出了参数<code>checkpoint_segments</code>的数量（默认值为3）。</li>
<li>在9.5及以后的版本，<code>pg_xlog</code>（10之后是<code>pg_wal</code>）中的WAL段文件总大小超过参数<code>max_wal_size</code>配置的值（默认值为1GB，64个段文件）。</li>
<li>PostgreSQL服务器以<code>smart</code>或<code>fast</code>模式关闭。</li>
</ol>
<p>当超级用户手动执行<code>CHECKPOINT</code>命令时，该进程也会启动。</p>
<blockquote>
  <p>在9.1或更早的版本中，后台写入进程（见8.6节）同时负责脏页写入与检查点。</p>
</blockquote>
<p>在接下来的几个小节中会简要描述检查点过程与<code>pg_control</code>文件，<code>pg_control</code>文件保存了当前检查点的元数据。</p>
<h3>9.7.1 检查点过程概述<span class="hx-absolute -hx-mt-20" id="971-检查点过程概述"></span>
    <a href="#971-%e6%a3%80%e6%9f%a5%e7%82%b9%e8%bf%87%e7%a8%8b%e6%a6%82%e8%bf%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	检查点进程负责两个方面：为数据库恢复做准备工作，以及共享缓冲池上脏页的刷盘工作。在本小节介绍其内部过程时，将重点关注前一个方面。参见图9.13和以下描述。</p>
<p><strong>图9.13 PostgreSQL检查点的内部流程</strong></p>
<p><img src="/img/fig-9-13.png" alt="" loading="lazy" /></p>
<ol>
<li>当检查点进程启动时，会将**重做点（REDO Point）**存储在内存中；<strong>重做点</strong>是上次检查点开始时刻时XLOG记录的写入位置，也是数据库恢复的开始位置。</li>
<li>该检查点相应的XLOG记录（即检查点）会被写入WAL缓冲区，该记录的数据部分是由<code>CheckPoint</code>结构体定义的，包含了一些变量，比如第一步中重做点的位置。另外，写入检查点记录的位置，也按照字面意义叫做<strong>检查点（checkpoint</strong>）。</li>
<li>共享内存中的所有数据（例如，CLOG的内容）都会被刷入持久存储中。</li>
<li>共享缓冲池中的所有脏页都会被逐渐刷写到存储中。</li>
<li>更新<code>pg_control</code>文件，该文件包含了一些基础信息，例如上一次检查点的位置，后面会介绍该文件的细节</li>
</ol>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">CheckPoint</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">XLogRecPtr</span>      <span class="n">redo</span><span class="p">;</span>           <span class="cm">/* 当创建存盘时，下一个可用的RecPtr(即重做点) */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TimeLineID</span>      <span class="n">ThisTimeLineID</span><span class="p">;</span> <span class="cm">/* 当前时间线ID TLI */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TimeLineID</span>      <span class="n">PrevTimeLineID</span><span class="p">;</span> <span class="cm">/* 前一个时间线ID TLI, 如果当前记录开启了一条新的时间线
</span></span></span><span class="line"><span class="cl"><span class="cm">                                   * (其他情况下等于ThisTimeLineID) */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span>            <span class="n">fullPageWrites</span><span class="p">;</span> <span class="cm">/* 当前全页写入的状态 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">uint32</span>          <span class="n">nextXidEpoch</span><span class="p">;</span>   <span class="cm">/* 下一个时事务ID（nextXid）的高位bit */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TransactionId</span>   <span class="n">nextXid</span><span class="p">;</span>        <span class="cm">/* 下一个空闲事务ID */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Oid</span>             <span class="n">nextOid</span><span class="p">;</span>        <span class="cm">/* 下一个空闲OID */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MultiXactId</span>     <span class="n">nextMulti</span><span class="p">;</span>      <span class="cm">/* 下一个空闲MultiXactId */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MultiXactOffset</span> <span class="n">nextMultiOffset</span><span class="p">;</span><span class="cm">/* 下一个空闲MultiXact 偏移量 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TransactionId</span>   <span class="n">oldestXid</span><span class="p">;</span>      <span class="cm">/* 集蔟范围最小的datfronzenxid */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Oid</span>             <span class="n">oldestXidDB</span><span class="p">;</span>    <span class="cm">/* 带有最小datfrozenxid的数据库 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MultiXactId</span>     <span class="n">oldestMulti</span><span class="p">;</span>    <span class="cm">/* 集蔟范围内最小的datminmxid */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Oid</span>             <span class="n">oldestMultiDB</span><span class="p">;</span>  <span class="cm">/* 带有最小datminmxid的数据库 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">pg_time_t</span>       <span class="n">time</span><span class="p">;</span>           <span class="cm">/* 存盘的时间戳 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="cm">/* 最老的仍然在运行的事务ID，只有当从在线检查点中初始化一个热备时才会需要该字段。因此只有
</span></span></span><span class="line"><span class="cl"><span class="cm">  * 当在线检查点且wal_level配置为热备时我们才会费劲计算这个字段。其他情况下会被设置为
</span></span></span><span class="line"><span class="cl"><span class="cm">  * InvalidTransactionId  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TransactionId</span> <span class="n">oldestActiveXid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">CheckPoint</span><span class="p">;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>​	让我们从数据库恢复的角度来总结上面的内容，检查点过程会创建包含重做点的检查点，并将检查点位置与其他信息存储到<code>pg_control</code>文件中。因此，PostgreSQL能够通过从重做点回放WAL数据来进行恢复（重做点是从检查点中获取的）。</p>
<h3>9.7.2 <code>pg_crontrol</code>文件<span class="hx-absolute -hx-mt-20" id="972-pg_crontrol文件"></span>
    <a href="#972-pg_crontrol%e6%96%87%e4%bb%b6" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	由于<code>pg_control</code>文件包含了检查点的基本信息，因此它对于数据库恢复肯定是必不可少的。如果它被破坏或不可读，因为系统不知道从哪里开始恢复，则恢复过程就无法启动。</p>
<p>尽管<code>pg_control</code>文件存储了40多条数据项，如下三个是接下来和我们讨论内容相关的：</p>
<ol>
<li><strong>状态（State）</strong> —— 最近检查点过程开始时数据库的状态，总共有七种状态：<code>start up</code>表示系统正在启动，<code>shut down</code>表示系统被关机命令正常关闭，<code>in production</code>表示数据库正在运行，诸如此类。</li>
<li><strong>最新检查点位置（Latest Checkpoint Location）</strong> —— 最新检查点的LSN位置</li>
<li><strong>上次检查点位置（Prior Checkpoint Location）</strong>—— 前一个检查点的LSN位置，在版本11中已经弃用，细节如引文所示。</li>
</ol>
<p><code>pg_control</code>文件存储在数据目录中<code>global</code>子目录内；可以使用<code>pg_controldata</code>程序显示其内容。</p>
<blockquote>
  <h3>PostgreSQL11中移除了前任检查点<span class="hx-absolute -hx-mt-20" id="postgresql11中移除了前任检查点"></span>
    <a href="#postgresql11%e4%b8%ad%e7%a7%bb%e9%99%a4%e4%ba%86%e5%89%8d%e4%bb%bb%e6%a3%80%e6%9f%a5%e7%82%b9" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>PostgreSQL 11及后续版本只会存储包含最新检查点或更新版本的WAL段文件；将不会存储包含先前检查点的旧段文件，以减少用于在<code>pg_xlog(pg_wal)</code>子目录下保存WAL段文件的磁盘空间。 详细信息请参见此<a href="http://www.postgresql-archive.org/Remove-secondary-checkpoint-tt5989050.html" target="_blank" rel="noopener">主题</a>。</p>
</blockquote>
<h2>9.8 PostgreSQL中的数据库恢复<span class="hx-absolute -hx-mt-20" id="98-postgresql中的数据库恢复"></span>
    <a href="#98-postgresql%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e6%81%a2%e5%a4%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	PostgreSQL的恢复功能基于**重做日志（REDO log）**实现。如果数据库服务器崩溃，PostgreSQL通过从REDO点依序重放WAL段文件中的XLOG记录来恢复数据库集群。</p>
<p>​	在本节之前，我们已经多次讨论过数据库恢复，所以这里将会介绍两个与恢复有关，但尚未解释过的事情。</p>
<p>​	第一件事是PostgreSQL如何启动恢复过程。当PostgreSQL启动时，它首先读取<code>pg_control</code>文件。以下是从那时起恢复处理的细节。参见图9.14和以下描述。</p>
<p><strong>图9.14 恢复过程的细节</strong></p>
<p><img src="/img/fig-9-14.png" alt="" loading="lazy" /></p>
<ol>
<li>PostgreSQL在启动时读取<code>pg_control</code>文件的所有项。如果<code>state</code>项是<code>in production</code>，PostgreSQL将进入恢复模式，因为这意味着数据库没有正常停止；如果是<code>shut down</code>，它就会进入正常的启动模式。</li>
<li>PostgreSQL从合适的WAL段文件中读取最近的检查点，该记录的位置写在<code>pg_control</code>文件中，并从该检查点中获得重做点。如果最新的检查点是无效的，PostgreSQL会读取前一个检查点。如果两个记录都不可读，它就会放弃自我恢复（注意在PostgreSQL11中不会存储前一个检查点）。</li>
<li>使用合适的资源管理器按顺序读取并重放XLOG记录，从重做点开始，直到最新WAL段文件的最后位置。当遇到一条属于备份区块的XLOG记录时，无论其LSN如何，它都会覆写相应表的页面。其他情况下，只有当此记录的LSN大于相应页面的<code>pd_lsn</code>时，才会重放该（非备份区块的）XLOG记录。</li>
</ol>
<p>第二件事是关于LSN的比较：为什么应该比较非备份区块的LSN和相应页面的<code>pd_lsn</code>。与前面的示例不同，这里使用需要在两个LSN之间进行比较的具体例子来解释，如图9.15和图9.16。 （注意这里省略了WAL缓冲区，以简化描述）。</p>
<p><strong>图9.15 当后台写入者工作时的插入操作</strong></p>
<p><img src="/img/fig-9-15.png" alt="" loading="lazy" /></p>
<ol>
<li>
<p>PostgreSQL将一条元组插入表A，并将一条XLOG记录写入<code>LSN_1</code>。</p>
</li>
<li>
<p>后台写入者进程将表A的页面写入存储。此时，此页面的<code>pd_lsn</code>为<code>LSN_1</code>。</p>
</li>
<li>
<p>PostgreSQL在表A中插入一条新元组，并在<code>LSN_2</code>处写入一条XLOG记录。修改后的页面尚未写入存储。</p>
</li>
</ol>
<p>与本章概述中的例子不同，在本场景中，表A的页面已经被一次性写入存储中。</p>
<p>使用<code>immediate</code>模式关闭数据库，然后启动数据库。</p>
<p><strong>图9.16 数据库恢复</strong></p>
<p><img src="/img/fig-9-15.png" alt="" loading="lazy" /></p>
<ol>
<li>PostgreSQL加载第一条XLOG记录和表A的页面，但不重放它，因为该记录的LSN不大于表A的LSN（两个值都是<code>LSN_1</code>）。实际上一目了然，没有重放该记录的必要性。</li>
<li>接下来，PostgreSQL会重放第二条XLOG记录，因为该记录的LSN（<code>LSN_2</code>）大于当前表A的LSN（<code>LSN_1</code>）。</li>
</ol>
<p>从这个例子中可以看出，如果非备份区块的重放顺序不正确，或者多次重放非备份区块，数据库集群将不再一致。简而言之，非备份区块的重做（重放）操作不是**幂等（idempotent）**的。因此，为了确保正确的重放顺序，非备份区块中的记录当且仅当其LSN大于相应页面的<code>pd_lsn</code>时，才执行重放。</p>
<p>​	另一方面，由于备份区块的重放操作是幂等的，不管其LSN为何值，备份块可以重放任意次。</p>
<h2>9.9 WAL段文件管理<span class="hx-absolute -hx-mt-20" id="99-wal段文件管理"></span>
    <a href="#99-wal%e6%ae%b5%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>​	PostgreSQL将XLOG记录写入<code>pg_xlog</code>子目录中的WAL段文件中（版本10之后是<code>pg_wal</code>子目录），当旧的段文件写满时就会切换至新的段文件。WAL文件的数量会根据几个配置参数的变化而变化，一些服务器的行为也会相应变化。此外，在9.5版中，段文件的管理机制也有了一些改善。</p>
<h3>9.9.1 WAL段切换<span class="hx-absolute -hx-mt-20" id="991-wal段切换"></span>
    <a href="#991-wal%e6%ae%b5%e5%88%87%e6%8d%a2" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>当出现下列任一情况时，WAL段会发生切换：</p>
<ol>
<li>WAL段已经被填满。</li>
<li>函数<code>pg_switch_xlog()</code>（10以后为<code>pg_switch_wal()</code>）被调用。</li>
<li>启用了<code>archive_mode</code>，且已经超过<code>archive_timeout</code>配置的时间。</li>
</ol>
<p>被切换的文件通常会被回收（重命名或重用），以供未来之用。但如果不是需要的话，也可能会被移除。</p>
<h3>9.9.2 WAL段管理（9.5版及以后）<span class="hx-absolute -hx-mt-20" id="992-wal段管理95版及以后"></span>
    <a href="#992-wal%e6%ae%b5%e7%ae%a1%e7%90%8695%e7%89%88%e5%8f%8a%e4%bb%a5%e5%90%8e" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>​	每当检查点过程启动时，PostgreSQL都会估计并准备下一个检查点周期所需的WAL段文件数。这种估计基于前一个检查点周期中消耗的文件数量，即从包含上一个重做点的段文件开始计数，而这个值应当在<code>min_wal_size</code>（默认80MB，5个文件）与<code>max_wal_size</code>之间（默认1GB，64个文件）。如果检查点过程启动，必需的段文件会被保留或回收，而不必要的段文件会被移除。</p>
<p>​	一个具体的例子如图9.17所示，假设在检查点开始前有六个文件，<code>WAL_3</code>包含了上一个重做点（版本10及以前，版本11后就是当前重做点），PostgreSQL估计会需要五个文件，在这种情况下，<code>WAL_1</code>被重命名为<code>WAL_7</code>回收利用，而<code>WAL_2</code>会被移除。</p>
<blockquote>
  <p>​	任何比包含上一个重做点的段文件更老的段文件都可以被移除，因为按照9.8节中描述的恢复机制，这些文件永远不会被用到了。</p>
</blockquote>
<p><strong>图9.17 在检查点时发生的WAL段文件循环与回收</strong></p>
<p><img src="/img/fig-9-17.png" alt="" loading="lazy" /></p>
<p>​	如果出现了WAL活动尖峰，导致需要更多的文件，新的文件会被创建，而WAL文件的总大小是小于<code>max_wal_size</code>的。例如在图9.18中，如果<code>WAL_7</code>被填满，<code>WAL_8</code>就会被新创建出来。</p>
<p><strong>9.18 创建WAL段文件</strong></p>
<p><img src="/img/fig-9-18.png" alt="" loading="lazy" /></p>
<p>​	WAL文件的数量会根据服务器活动而自动适配。 如果WAL数据写入量持续增加，则WAL段文件的估计数量以及WAL文件的总大小也会逐渐增加。 在相反的情况下（即WAL数据写入量减少），这些值也会减少。</p>
<p>​	如果WAL文件的总大小超过<code>max_wal_size</code>，则将启动检查点。 图9.19说明了这种情况。 检查点将会创建一个新的重做点，最近的重做点将会变为上一个重做点，不是必需的文件将被回收。通过这种方式，PostgreSQL将始终只保留数据库恢复所必需的WAL段文件。</p>
<p><strong>图9.19 检查点与回收WAL段文件</strong></p>
<p><img src="/img/fig-9-19.png" alt="" loading="lazy" /></p>
<p>配置参数<code>wal_keep_segments</code>以及**复制槽（Replication Slot）**功能都会影响WAL段文件的数量。</p>
<h3>9.9.3 WAL段管理（9.4版及以前）<span class="hx-absolute -hx-mt-20" id="993-wal段管理94版及以前"></span>
    <a href="#993-wal%e6%ae%b5%e7%ae%a1%e7%90%8694%e7%89%88%e5%8f%8a%e4%bb%a5%e5%89%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><p>WAL段文件的数量主要由下列三个参数控制：</p>
<ul>
<li><code>checkpoint_segments</code></li>
<li><code>checkpoint_completion_target</code></li>
<li><code>wal_keep_segments</code>。</li>
</ul>
<p>WAL段文件的数量通常会：</p>
<p>比 $((2 + \verb|checkpoint_completion_target|) × \verb|checkpoint_segments| + 1 )$ 要大</p>
<p>比$( \verb|checkpoint_segments| + \verb|wal_keep_segments| + 1)$要大</p>
<p>且不超过$(3×\verb|checkpoint_segments|+1)$个文件</p>
<p>WAL段文件具体数目的取决于不同的服务器活动，复制槽的存在也会影响WAL文件的数量。</p>
<p>​	如第9.7节中所提到的，当消耗了超过<code>checkpoint_segments</code>个数量的文件时，就会启动检查点过程。因此可以保证WAL段文件中总是包含至少两个重做点，因为文件的数量始终大于$2×\verb|checkpoint_segments|$，对于由超时导致的检查点同样适用。PostgreSQL总是会保留足够用于恢复的WAL段文件（有时候会超出必需的量）。</p>
<blockquote>
  <p>​	在版本9.4或更早版本中，调整参数<code>checkpoint_segments</code>是一个痛苦的问题。 如果设置为较小的值，则检查点会频繁发生，这会导致性能下降；而如果设置为较大的数值，则WAL文件总是需要巨大的磁盘空间，但其中一些空间不是必须的。</p>
<p>​	在9.5版本中，WAL文件的管理策略得到了改善，而<code>checkpoint_segments</code>参数被弃用，因此上述的权衡问题已经得到解决。</p>
</blockquote>
<h2>9.10 归档日志与持续归档<span class="hx-absolute -hx-mt-20" id="910-归档日志与持续归档"></span>
    <a href="#910-%e5%bd%92%e6%a1%a3%e6%97%a5%e5%bf%97%e4%b8%8e%e6%8c%81%e7%bb%ad%e5%bd%92%e6%a1%a3" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p><strong>持续归档（continuous archiving）<strong>是当WAL段文件发生切换时会自动将其拷贝至归档区域的一项功能。持续归档是由归档后台进程执行的，拷贝的文件称为</strong>归档日志（archive log）</strong>。该功能通常用于物理备份与时间点恢复（参见<a href="/ch10" >第十章</a>）。</p>
<p>​	归档区域的配置取决于配置参数<code>archieve_command</code>，例如使用下列配置时，每当发生段文件切换时，WAL段文件会被拷贝到目录<code>/home/postgres/archives</code>目录下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">archive_command</span> <span class="o">=</span> <span class="s1">&#39;cp %p /home/postgres/archives/%f&#39;</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这里<code>%p</code>是被拷贝WAL段文件的路径占位符，而<code>%f</code>是归档日志文件名的占位符。</p>
<p><strong>图9.20 持续归档</strong></p>
<p><img src="/img/fig-9-20.png" alt="" loading="lazy" /></p>
<p>当WAL段文件<code>WAL_7</code>发生切换时，该文件被拷贝至归档区域，作为归档日志7。</p>
<p><code>archive_command</code>参数可以配置为任意的Unix命令或程序，因此你也能用<code>scp</code>将归档日志发送到其他主机上，或使用任意的文件备份工具来替代普通的拷贝命令。</p>
<blockquote>
  <p>PostgreSQL<strong>并不会</strong>清理归档日志，所以在使用该功能时需要管理好这些日志。如果什么都不做，归档日志的数量会不断增长。</p>
<p><a href="https://www.postgresql.org/docs/current/static/pgarchivecleanup.html" target="_blank" rel="noopener"><code>pg_archivecleanup</code></a>工具是一个管理归档日志的实用工具。</p>
</blockquote>

        </div>
        <div class="hx-mt-16"></div>
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/ch8/"
        title="8. 缓冲区管理器"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-pr-4 rtl:hx-pl-4"
      ><svg class="hx-inline hx-h-5 hx-shrink-0 ltr:hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>8. 缓冲区管理器</a><a
        href="/ch10/"
        title="10. 基础备份与时间点恢复"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-ml-auto ltr:hx-pl-4 ltr:hx-text-right rtl:hx-mr-auto rtl:hx-pr-4 rtl:hx-text-left"
      >10. 基础备份与时间点恢复<svg class="hx-inline hx-h-5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div><div class="hx-mt-6 hx-text-xs">© 2024 Hextra.</div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>
<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/zh.search.js" integrity=""></script><link type="text/css" rel="stylesheet" href="/lib/katex/katex.min.7e5db7914b97e596a36c1abb67ccc7f174f8bb71d38c9a88c55b262ed1737f97.css" integrity="sha256-fl23kUuX5ZajbBq7Z8zH8XT4u3HTjJqIxVsmLtFzf5c=" />
<script defer src="/lib/katex/katex.min.9f45307c5794ed247a0d095f3a62e52ef2215a67b2327203a7fd919959ae79d1.js" integrity="sha256-n0UwfFeU7SR6DQlfOmLlLvIhWmeyMnIDp/2RmVmuedE="></script>
<script defer src="/lib/katex/auto-render.min.7b57d427ac6270677daf8d8380ded2cc73336f9149a167b8e1fe0d6ef66604ae.js" integrity="sha256-e1fUJ6xicGd9r42DgN7SzHMzb5FJoWe44f4NbvZmBK4="></script>
<script defer src="/lib/katex/mhchem.min.f0ca03df194b8c3d6017ff455db6a0ef98857905663fa311a6cded788b15340b.js" integrity="sha256-8MoD3xlLjD1gF/9FXbag75iFeQVmP6MRps3teIsVNAs="></script>
<script>
  
  
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\begin{equation}", right: "\\end{equation}", display: true },
        {left: "\\begin{align}", right: "\\end{align}", display: true},
        {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
        {left: "\\begin{gather}", right: "\\end{gather}", display: true},
        {left: "\\begin{CD}", right: "\\end{CD}", display: true},
        { left: "\\[", right: "\\]", display: true },
      ],
      throwOnError: false,
    });
  });
</script>

  </body>
</html>
